<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas y Archivo Cl√≠nico</title>
    <link rel="shortcut icon" href="/estadisticas/img/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/estadisticas/img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="/estadisticas/main_css/estilos.css" rel="stylesheet">
    <link href="/estadisticas/main_css/tabla-wrapper.css" rel="stylesheet">
</head>

<style>
    /* === TODO TU CSS ORIGINAL ‚Äî SIN QUITAR NADA === */

    .layout-egresos {
        display: grid;
        grid-template-columns: 20% 1fr;
        gap: 1rem;
        height: calc(100vh - 160px);
        min-height: 0;
    }

    .form-panel {
        background: rgba(255, 255, 255, 0.09);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 14px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.7rem;
        min-width: 200px;
        overflow-y: auto;
        color: #0f0;
    }

    .form-panel input,
    .form-panel textarea {
        width: 100%;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.08);
        color: #0f0;
        font-size: 0.9rem;
    }

    .tabla-zona {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0.3rem;
        min-height: 0;
    }

    .tabla-wrapper {
        height: 100%;
        min-height: 0;
        overflow-y: auto;
    }

    .buscador-tabla {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.6rem;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 10px;
        margin-bottom: 0.4rem;
    }

    /* === CONTENEDOR VISUAL PARA estadoSistema.js (NUEVO, M√çNIMO) === */
    #estadoSistema {
        position: fixed;
        bottom: 18px;
        right: 18px;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 0.85rem;
        backdrop-filter: blur(12px);
        opacity: 0;
        transition: all 0.35s ease;
        pointer-events: none;
        z-index: 9999;
    }

    #estadoSistema.ok {
        background: rgba(0, 255, 120, 0.25);
        color: #caffca;
        opacity: 1;
    }

    #estadoSistema.error {
        background: rgba(255, 80, 80, 0.25);
        color: #ffdada;
        opacity: 1;
    }
</style>

<body>
    <div class="glass" id="dashboard">
        <h5>Hojas Faltantes</h5>
        <div id="header"></div>

        <div class="layout-egresos">

            <form id="form-egresos" class="form-panel">
                <input type="text" name="paciente" placeholder="Paciente" required>
                <input type="date" name="fecha_egreso">
                <input type="text" name="servicio" placeholder="Servicio">
                <input type="text" name="personal_archivo" placeholder="Personal de archivo">
                <input type="text" name="no_expediente" placeholder="No. expediente">
                <textarea name="observaciones" placeholder="Observaciones"></textarea>
                <button class="button" type="submit">Guardar</button>
            </form>

            <div class="tabla-zona">
                <div class="tabla-wrapper tabla-scroll-x">
                    <div class="buscador-tabla">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="text" id="buscadorTabla" placeholder="Buscar en la tabla‚Ä¶">
                        <span>Mostrar atendidos</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleAtendidos">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <table id="tabla-registros">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="footer"></div>
    </div>

    <!-- üîî CONTENEDOR REQUERIDO POR estadoSistema.js -->
    <div id="estadoSistema"></div>

    <script>
        const URL = "https://script.google.com/macros/s/AKfycbzZf97xag50EWpqVLAhaugl0PKMp6PsUvdoMApEEhIOJ9f_CqLR_pw3nYT5EIMTrHRy/exec";
        let mostrarAtendidos = false;
        let textoBusqueda = "";

        document.getElementById("toggleAtendidos").addEventListener("change", e => {
            mostrarAtendidos = e.target.checked;
            cargarRegistros();
        });

        document.getElementById("buscadorTabla").addEventListener("input", e => {
            textoBusqueda = e.target.value.toLowerCase().trim();
            cargarRegistros();
        });

        document.getElementById("form-egresos").addEventListener("submit", async e => {
            e.preventDefault();
            try {
                const data = Object.fromEntries(new FormData(e.target).entries());
                const res = await fetch(URL, { method: "POST", body: JSON.stringify(data) });
                const json = await res.json();

                if (json.ok) {
                    estadoSistema("Registro guardado correctamente", "ok");
                    cargarRegistros();
                    e.target.reset();
                } else {
                    estadoSistema("Error al guardar", "error");
                }
            } catch {
                estadoSistema("Error de conexi√≥n", "error");
            }
        });

        async function cargarRegistros() {
            const res = await fetch(URL);
            const json = await res.json();
            if (!json.ok) {
                estadoSistema("Error al cargar registros", "error");
                return;
            }

            let registros = json.registros;

            if (!mostrarAtendidos) {
                registros = registros.filter(r => !["true", "s√≠", "si", "1"].includes(String(r["ATENDIDO"]).toLowerCase()));
            }

            if (textoBusqueda) {
                registros = registros.filter(r =>
                    Object.values(r).some(v => String(v).toLowerCase().includes(textoBusqueda))
                );
            }

            const thead = document.querySelector("#tabla-registros thead");
            const tbody = document.querySelector("#tabla-registros tbody");
            thead.innerHTML = "";
            tbody.innerHTML = "";

            if (!registros.length) return;

            const headers = Object.keys(registros[0]);
            thead.innerHTML = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";

            registros.forEach(r => {
                tbody.innerHTML += "<tr>" + headers.map(h => `<td>${r[h] ?? ""}</td>`).join("") + "</tr>";
            });
        }

        document.addEventListener("DOMContentLoaded", cargarRegistros);
    </script>

    <!-- HEADER / FOOTER / SESI√ìN: SIN TOCAR -->
    <script src="/estadisticas/comun/estadoSistema.js"></script>
    <script src="/estadisticas/comun/sesion_bk.js"></script>
</body>
</html>
