<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estad√≠sticas y Archivo Cl√≠nico</title>

<link rel="shortcut icon" href="/estadisticas/img/favicon.ico">
<link rel="icon" href="/estadisticas/img/favicon.ico">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="/estadisticas/main_css/estilos.css" rel="stylesheet">
<link href="/estadisticas/main_css/tabla-wrapper.css" rel="stylesheet">
</head>

<body>
<div class="glass" id="dashboard">

<h5>Hojas Incompletas de Hospitalizaci√≥n8</h5>
<div id="header"></div>

<div class="layout-egresos">
<div class="tabla-zona">

<div class="buscador-tabla">
    <div class="filtro-atendidos">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" id="buscadorTabla" placeholder="Buscar en la tabla‚Ä¶">
    </div>

    <div class="filtro-atendidos">
        <span>Mostrar todo</span>
        <label class="toggle-switch">
            <input type="checkbox" id="toggleAtendidos">
            <span class="toggle-slider"></span>
        </label>
    </div>
</div>

<div class="tabla-wrapper">
    <div class="tabla-scroll-x">
        <table id="tabla-registros">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

</div>
</div>

<div id="footer"></div>
</div>

<script>
/* ================= CONFIG ================= */
const URL = "https://script.google.com/macros/s/AKfycbzZf97xag50EWpqVLAhaugl0PKMp6PsUvdoMApEEhIOJ9f_CqLR_pw3nYT5EIMTrHRy/exec";

let registrosOriginales = [];
let textoBusqueda = "";
let mostrarTodo = false;

let headersGlobales = [];
const INDEX_CHECKLIST = 6; // columna G real

/* ================= EVENTOS ================= */
document.getElementById("toggleAtendidos").addEventListener("change", e => {
    mostrarTodo = e.target.checked;
    aplicarFiltros();
});

document.getElementById("buscadorTabla").addEventListener("input", e => {
    textoBusqueda = e.target.value.toLowerCase().trim();
    aplicarFiltros();
});

/* ================= CARGA ================= */
document.addEventListener("DOMContentLoaded", cargarRegistros);

async function cargarRegistros() {
    try {
        const res = await fetch(URL);
        const json = await res.json();
        registrosOriginales = json.registros || [];
        aplicarFiltros();
    } catch {
        document.querySelector("#tabla-registros tbody").innerHTML = `
        <tr><td colspan="20" style="text-align:center;color:#f55;padding:20px">
            Error al cargar datos
        </td></tr>`;
    }
}

/* ================= FILTROS ================= */
function aplicarFiltros() {
    let data = [...registrosOriginales];

    if (!mostrarTodo && headersGlobales.length) {
        data = data.filter(r => {
            const checklist = String(headersGlobales.map(h => r[h])[INDEX_CHECKLIST] || "").toLowerCase();
            return !["si","s√≠","true","1","x","‚úî"].includes(checklist);
        });
    }

    if (textoBusqueda) {
        data = data.filter(r =>
            Object.values(r).some(v =>
                String(v).toLowerCase().includes(textoBusqueda)
            )
        );
    }

    renderTabla(data);
}

/* ================= TABLA ================= */
function renderTabla(registros) {
    const thead = document.querySelector("#tabla-registros thead");
    const tbody = document.querySelector("#tabla-registros tbody");

    thead.innerHTML = "";
    tbody.innerHTML = "";

    if (!registros.length) {
        tbody.innerHTML = `
        <tr><td colspan="20" style="text-align:center;color:#aaa;padding:20px">
            No hay pendientes üéØ
        </td></tr>`;
        return;
    }

    headersGlobales = Object.keys(registros[0]);

    thead.innerHTML = "<tr>" +
        headersGlobales.map(h => `<th>${h || "‚úî"}</th>`).join("") +
        "</tr>";

    registros.forEach(r => {
        const fila = "<tr>" + headersGlobales.map(h => {
            let v = r[h] ?? "";
            if (esFecha(h)) v = formatearFecha(v);
            return `<td>${v}</td>`;
        }).join("") + "</tr>";
        tbody.innerHTML += fila;
    });
}

/* ================= FECHAS ================= */
function esFecha(h) {
    return ["FECHA DE EGRESO","REGISTRADO","CUANDO"].includes(h);
}

function formatearFecha(v) {
    if (!v) return "";
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(v)) return v;

    const f = new Date(v);
    if (isNaN(f)) return v;

    return f.toLocaleDateString("es-MX", {
        day: "2-digit",
        month: "short",
        year: "numeric"
    });
}
</script>

<script>
fetch('/estadisticas/comun/header.html')
.then(r => r.text())
.then(html => {
    document.getElementById('header').innerHTML = html;
    const s = document.createElement('script');
    s.src = '/estadisticas/comun/sesion_bk.js';
    document.body.appendChild(s);
    s.onload = () => typeof verificarAutenticacion === "function" && verificarAutenticacion();
});

fetch('/estadisticas/comun/footer.html')
.then(r => r.text())
.then(html => {
    document.getElementById('footer').innerHTML = html;
    const f = document.getElementById('footerText');
    if (f) f.innerHTML = `Hecho con ‚ù§Ô∏è por Ricardo ¬∑ ${new Date().getFullYear()}`;
});
</script>

<script src="/estadisticas/comun/estadoSistema.js"></script>
</body>
</html>
