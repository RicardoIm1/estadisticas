<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas y Archivo Cl√≠nico</title>
    <link rel="shortcut icon" href="/estadisticas/img/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/estadisticas/img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="/estadisticas/main_css/estilos.css" rel="stylesheet">
</head>
<style>
    .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 16px;
    }

    .card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(10px);
        border-radius: 14px;
        padding: 14px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, .15);
        transition: transform .2s ease;
    }

    .card:hover {
        transform: translateY(-4px);
    }

    .card h4 {
        margin: 0 0 6px;
        font-size: 14px;
        letter-spacing: .5px;
    }

    .card small {
        opacity: .8;
        font-size: 12px;
    }

    .buscador-wrapper {
        position: sticky;
        top: 0;
        left: 0;
        /* background-color: rgba(255, 25, 255, 0.08); */
        /* backdrop-filter: blur(10px); */
        padding: 1rem;
        /* border-bottom: 1px solid rgba(255, 255, 255, 0.1); */
        z-index: 10;
        text-align: left;
        border-radius: 12px;
        width: 60%;
        /*     padding: 0.5rem; */
    }

    .input-busqueda {
        /* padding: 6px 10px;
    font-size: 12px; */
        width: 100%;
        padding: 10px 16px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .input-busqueda:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.4);
        background: rgba(255, 255, 255, 0.15);
    }

    .input-busqueda::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }
</style>

<body>
    <div class="glass" id="dashboard">
        <h5>REGISTROS RESCATADOS DE SIMAH</h5>
        <div id="headerb"></div>
        <div class="grid">
            <div id="cards" class="cards-grid"></div>

            <div class="paginacion">
                <button onclick="cambiarPagina(-1)">‚Üê</button>
                <span id="paginaActual"></span>
                <button onclick="cambiarPagina(1)">‚Üí</button>
            </div>

        </div>
        <div id="footer"></div>
    </div>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzUxd6Yvvb1F2hnJdUHEwm-_og3yTfXnDIuotE_B5VEvS2GnqBIN99lg-_rp6tDjUmg/exec';
        let page = 1;

        async function cargar() {
            try {
                const res = await fetch(`${API_URL}?page=${page}`);
                const data = await res.json();
                render(data);

                document.getElementById("paginaActual").innerText =
                    `P√°gina ${data.page} de ${Math.ceil(data.total / data.pageSize)}`;
            } catch (e) {
                console.error("Error cargando datos:", e);
            }
        }

        function cambiarPagina(delta) {
            if (page + delta < 1) return;
            page += delta;
            cargar();
        }

        function render(data) {
            const cont = document.getElementById("cards");
            cont.innerHTML = "";

            data.rows.forEach(r => {
                cont.innerHTML += `
        <div class="card">
          <span>${r.nombre}</span><br>
          <small>Expediente: ${r.expediente}</small><br>
          <small>${r.servicio}</small><br>
          <small>${r.fecha}</small>
        </div>
      `;
            });
        }

        window.addEventListener("load", cargar);
        function obtenerRegistros(page, q) {
            const sh = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
            const rows = sh.getDataRange().getValues();
            rows.shift();

            let filtrados = rows;

            if (q) {
                filtrados = rows.filter(r =>
                    String(r[0]).toLowerCase().includes(q) || // expediente
                    String(r[1]).toLowerCase().includes(q)    // nombre
                );
            }

            const total = filtrados.length;
            const start = (page - 1) * PAGE_SIZE;
            const slice = filtrados.slice(start, start + PAGE_SIZE);

            return {
                page,
                pageSize: PAGE_SIZE,
                total,
                rows: slice.map(r => ({
                    expediente: r[0],
                    nombre: r[1],
                    fecha: r[2],
                    servicio: r[3]
                }))
            };
        }


    </script>

    <script>
        fetch('/estadisticas/comun/headerb.html')
            .then(r => r.text())
            .then(html => {
                document.getElementById('headerb').innerHTML = html;

                // Cargar sesi√≥n.js despu√©s de insertar el HTML
                const s = document.createElement('script');
                s.src = '/estadisticas/comun/sesion_bk.js';

                s.onload = () => {
                    console.log("üî• sesion_bk.js cargado. Verificando sesi√≥n...");
                    verificarAutenticacion();
                };

                document.body.appendChild(s);
            });

        fetch('/estadisticas/comun/footer.html')
            .then(r => r.text())
            .then(html => {
                document.getElementById('footer').innerHTML = html;

                // Ya existe footerText
                const footer = document.getElementById('footerText');
                if (footer) {
                    footer.innerHTML = `Hecho con ‚ù§Ô∏è por Ricardo ¬∑ ${new Date().getFullYear()}`;
                }
            });
    </script>
    <script src="/estadisticas/comun/estadoSistema.js"></script>
    <script src="/estadisticas/comun/sesion_bk.js"></script>
</body>

</html>