<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estad√≠sticas y Archivo Cl√≠nico</title>
  <link rel="shortcut icon" href="/estadisticas/img/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/estadisticas/img/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="/estadisticas/main_css/estilos.css" rel="stylesheet">
</head>

<body>
  <div class="glass" id="dashboard">
    <h5>REGISTRO DIARIO DEL MOVIMIENTO DE PACIENTES EN HOSPITALIZACION</h5>
    <div id="header"></div>
    <div class="grid">
      <h1><i class="fa-solid fa-file-contract" style="color: #1e40af;"></i> Reporte CENSO Diario - Formato
        SINBA-SIS-65-P</h1>

      <div class="filtros">
        <div class="bloque">
          <label for="fecha-reporte"><i class="fa-solid fa-calendar-day" style="color: #1e40af;"></i> Fecha del
            Reporte</label>
          <input type="date" id="fecha-reporte" required>
        </div>
        <div class="bloque">
          <label for="servicio-reporte"><i class="fa-solid fa-hospital" style="color: #1e40af;"></i> Servicio</label>
          <select id="servicio-reporte" required>
            <option value="">‚Äî Selecciona ‚Äî</option>
            <option>CIRUGIA GENERAL</option>
            <option>GINECOLOGIA</option>
            <option>MEDICINA INTERNA</option>
            <option>PEDIATRIA</option>
            <option>TRAUMATOLOGIA Y ORTOPEDIA</option>
            <option>UCIN</option>
          </select>
        </div>
        <div class="bloque">
          <label for="sala"><i class="fa-solid fa-door-closed" style="color: #1e40af;"></i> Sala (opcional)</label>
          <input type="text" id="sala" placeholder="Ej: SALA 1">
        </div>
        <div class="bloque">
          <label for="total-camas"><i class="fa-solid fa-bed" style="color: #1e40af;"></i> Total de Camas
            Disponibles</label>
          <input type="number" id="total-camas" placeholder="Ej: 30" value="30" min="1" max="100">
        </div>
      </div>

      <div class="botones">
        <button id="btnGenerar" class="btn btn-generar">
          <i class="fa-solid fa-eye"></i> Vista Previa
        </button>
        <button id="btnPDF" class="btn btn-pdf" style="display: none;">
          <i class="fa-solid fa-file-pdf"></i> Descargar PDF
        </button>
      </div>

      <div id="resultados" class="resultados">
        <!-- Aqu√≠ se mostrar√° la vista previa del formato SINBA -->
      </div>
    </div>
    <div id="footer"></div>
  </div>
  <script>
    fetch('/estadisticas/comun/header.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('header').innerHTML = html;

        // Cargar sesi√≥n.js despu√©s de insertar el HTML
        const s = document.createElement('script');
        s.src = '/estadisticas/comun/sesion_bk.js';

        s.onload = () => {
          console.log("üî• sesion_bk.js cargado. Verificando sesi√≥n...");
          verificarAutenticacion();
        };

        document.body.appendChild(s);
      });

    fetch('/estadisticas/comun/footer.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('footer').innerHTML = html;

        // Ya existe footerText
        const footer = document.getElementById('footerText');
        if (footer) {
          footer.innerHTML = `Hecho con ‚ù§Ô∏è por Ricardo ¬∑ ${new Date().getFullYear()}`;
        }
      });
  </script>

  <!-- PDF.js Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Mismo URL que usas en el censo
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbyhMRSZlKTZeveL0wHukElK92ntfc7yTfFCCyEeFnLsQCvIra2Tzn5_cN3MZdqZbgGH/exec";

    document.addEventListener('DOMContentLoaded', function () {
      console.log('üìä Inicializando reporte formato SINBA...');

      // Configurar fecha por defecto (hoy)
      const hoy = new Date().toISOString().split('T')[0];
      document.getElementById('fecha-reporte').value = hoy;

      // Configurar footer
      document.getElementById('anio-actual').textContent = new Date().getFullYear();

      // Cargar datos del usuario
      const usuario = localStorage.getItem('usuario');
      const rol = localStorage.getItem('rol');
      if (usuario && rol) {
        document.getElementById('user-info').textContent = `${usuario} (${rol})`;
      } else {
        // Si no hay sesi√≥n, redirigir
        window.location.href = '/estadisticas/login.html';
        return;
      }

      // Evento para generar vista previa
      document.getElementById('btnGenerar').addEventListener('click', generarVistaPrevia);

      // Evento para descargar PDF
      document.getElementById('btnPDF').addEventListener('click', generarPDF);

      console.log('‚úÖ Reporte SINBA inicializado correctamente');
    });

    async function generarVistaPrevia() {
      const fechaReporte = document.getElementById('fecha-reporte').value;
      const servicioReporte = document.getElementById('servicio-reporte').value;
      const sala = document.getElementById('sala').value;
      const totalCamas = parseInt(document.getElementById('total-camas').value) || 30;

      if (!fechaReporte || !servicioReporte) {
        alert('Por favor, seleccione fecha y servicio');
        return;
      }

      const resultadosDiv = document.getElementById('resultados');
      resultadosDiv.innerHTML = `
        <div class="loading">
            <i class="fa-solid fa-spinner fa-spin" style="color: #1e40af;"></i>
            <p style="color: #1e40af;">Cargando datos para ${formatearFechaTexto(fechaReporte)}...</p>
        </div>
    `;

      try {
        console.log('üì• Obteniendo datos para:', fechaReporte, servicioReporte);

        // Obtener todos los datos
        const datos = await obtenerDatos();
        console.log('‚úÖ Datos recibidos:', datos.length, 'registros');

        // DEBUG: Mostrar estructura de los datos
        debugRegistros(datos);

        if (datos.length === 0) {
          resultadosDiv.innerHTML = `
                <div class="sin-datos">
                    <i class="fa-solid fa-database" style="font-size: 48px; margin-bottom: 15px; color: #1e40af;"></i>
                    <h3 style="color: #1e40af;">No hay registros en el sistema</h3>
                    <p style="color: #1e40af;">Regresa a la p√°gina de censo para agregar pacientes.</p>
                </div>
            `;
          document.getElementById('btnPDF').style.display = 'none';
          return;
        }

        // Filtrar datos por fecha y servicio
        const datosFiltrados = datos.filter(registro => {
          try {
            const fechaRegistro = registro[0]; // Columna 1 - Fecha
            const servicio = registro[2]; // Columna 3 - Servicio

            if (!fechaRegistro || !servicio) {
              console.log('Registro sin fecha o servicio:', registro);
              return false;
            }

            console.log('Comparando fecha:', fechaRegistro, 'con:', fechaReporte);
            console.log('Comparando servicio:', servicio, 'con:', servicioReporte);

            // Normalizar fecha
            const fechaNormalizada = normalizarFecha(fechaRegistro);
            console.log('Fecha normalizada:', fechaNormalizada);

            if (!fechaNormalizada) return false;

            // Comparar fechas (solo el d√≠a espec√≠fico)
            return fechaNormalizada === fechaReporte && servicio === servicioReporte;
          } catch (error) {
            console.error('Error procesando registro:', error, registro);
            return false;
          }
        });

        console.log('üìä Datos filtrados:', datosFiltrados.length, 'registros');

        if (datosFiltrados.length === 0) {
          resultadosDiv.innerHTML = `
                <div class="info-message">
                    <i class="fa-solid fa-info-circle" style="color: #1e40af;"></i>
                    <h3 style="color: #1e40af;">No hay registros para la fecha y servicio seleccionados</h3>
                    <p style="color: #1e40af;">Fecha: ${formatearFechaTexto(fechaReporte)}</p>
                    <p style="color: #1e40af;">Servicio: ${servicioReporte}</p>
                    <p style="color: #1e40af;"><small>Se encontraron ${datos.length} registros en total, pero ninguno coincide con los filtros.</small></p>
                </div>
            `;
          document.getElementById('btnPDF').style.display = 'none';
          return;
        }

        // Calcular totales para el formato SINBA
        const totales = calcularTotalesSINBA(datosFiltrados, totalCamas);

        // Generar vista previa del formato
        const vistaPrevia = generarFormatoSINBA(
          fechaReporte,
          servicioReporte,
          sala,
          datosFiltrados,
          totales
        );

        resultadosDiv.innerHTML = vistaPrevia;

        // Mostrar bot√≥n de PDF
        document.getElementById('btnPDF').style.display = 'flex';

        // Guardar datos para PDF
        window.datosReporte = {
          fecha: fechaReporte,
          servicio: servicioReporte,
          sala: sala,
          registros: datosFiltrados,
          totales: totales,
          totalCamas: totalCamas
        };

        console.log('‚úÖ Vista previa generada exitosamente');

      } catch (error) {
        console.error('‚ùå Error al generar vista previa:', error);
        resultadosDiv.innerHTML = `
            <div class="mensaje-error">
                <i class="fa-solid fa-exclamation-triangle"></i>
                <h3>Error al generar el reporte</h3>
                <p>${error.message}</p>
                <p><small>Verifica tu conexi√≥n a internet e intenta nuevamente.</small></p>
            </div>
        `;
        document.getElementById('btnPDF').style.display = 'none';
      }
    }
    function obtenerDatos() {
      return new Promise((resolve, reject) => {
        console.log('üîó Conectando a Google Apps Script...');
        const callbackName = 'callback_' + Date.now() + '_' + Math.random().toString(36).substr(2);

        window[callbackName] = function (response) {
          console.log('üì® Respuesta recibida del servidor:', response);

          try {
            // Manejar diferentes formatos de respuesta
            let datos;

            if (Array.isArray(response)) {
              datos = response;
            } else if (response.data && Array.isArray(response.data)) {
              datos = response.data;
            } else if (response.records && Array.isArray(response.records)) {
              datos = response.records;
            } else if (typeof response === 'object') {
              const arrayKeys = Object.keys(response).filter(key => Array.isArray(response[key]));
              if (arrayKeys.length > 0) {
                datos = response[arrayKeys[0]];
              } else {
                reject(new Error('Formato de datos no reconocido'));
                return;
              }
            } else {
              reject(new Error('Formato de respuesta inesperado'));
              return;
            }

            console.log('üìä Datos extra√≠dos:', datos.length, 'registros');
            resolve(datos);

          } catch (error) {
            reject(new Error('Error procesando respuesta: ' + error.message));
          } finally {
            // Limpiar callback
            setTimeout(() => {
              delete window[callbackName];
            }, 1000);
          }
        };

        // Timeout
        const timeout = setTimeout(() => {
          reject(new Error('Timeout: No se pudo conectar con el servidor'));
          delete window[callbackName];
        }, 30000);

        // Crear script para llamada JSONP
        const script = document.createElement('script');
        const url = `${URL_SCRIPT}?action=get&callback=${callbackName}&t=${Date.now()}`;

        script.src = url;
        script.onerror = (error) => {
          clearTimeout(timeout);
          reject(new Error('Error de conexi√≥n: ' + (error.message || 'No se pudo cargar los datos')));
          delete window[callbackName];
        };

        script.onload = () => clearTimeout(timeout);

        document.body.appendChild(script);
      });
    }

    function normalizarFecha(fechaISO) {
      if (!fechaISO) return null;

      try {
        // Si ya est√° en formato YYYY-MM-DD
        if (/^\d{4}-\d{2}-\d{2}$/.test(fechaISO)) {
          return fechaISO;
        }

        // Si tiene tiempo (ISO format)
        if (fechaISO.includes('T')) {
          const fechaObj = new Date(fechaISO);
          if (!isNaN(fechaObj.getTime())) {
            return fechaObj.toISOString().split('T')[0];
          }
        }

        // Intentar parsear como fecha
        const fechaObj = new Date(fechaISO);
        if (!isNaN(fechaObj.getTime())) {
          return fechaObj.toISOString().split('T')[0];
        }

        return null;
      } catch (error) {
        console.error('‚ùå Error normalizando fecha:', fechaISO, error);
        return null;
      }
    }

    function calcularTotalesSINBA(datos, totalCamas) {
      console.log('üßÆ Calculando totales SINBA...');
      console.log('Datos recibidos para c√°lculo:', datos);

      let totalCamasOcupadas = datos.length;

      // Totales iniciales
      let totalPasesDe = 0;
      let totalIngresos = 0;
      let totalEgresosVivos = 0;
      let totalEgresosMuertos = 0;
      let totalPasesA = 0;
      let totalDiasPaciente = datos.length; // Cada paciente cuenta como 1 d√≠a
      let ingresosEgresosMismoDia = 0;

      // Calcular los totales basados en las columnas correctas
      datos.forEach((registro, index) => {
        console.log(`Registro ${index + 1}:`, registro);

        // Pases de (columna 3 - √≠ndice 3)
        if (registro[3] && registro[3].trim() !== '' && registro[3] !== '‚Äî Selecciona ‚Äî') {
          totalPasesDe++;
        }

        // Ingresos - verificar de d√≥nde vino
        let tieneIngreso = false;

        // Consulta Externa (columna 8 - √≠ndice 8)
        if (registro[8] && registro[8].toString().trim() !== '' && registro[8] !== false) {
          totalIngresos++;
          tieneIngreso = true;
        }

        // Urgencias (columna 9 - √≠ndice 9)
        if (registro[9] && registro[9].toString().trim() !== '' && registro[9] !== false) {
          totalIngresos++;
          tieneIngreso = true;
        }

        // Otra Unidad (columna 10 - √≠ndice 10)
        if (registro[10] && registro[10].toString().trim() !== '' && registro[10] !== false) {
          totalIngresos++;
          tieneIngreso = true;
        }

        // Egresos vivos (columna 11 - √≠ndice 11)
        let tieneEgreso = false;
        if (registro[11] && registro[11].toString().trim() !== '' && registro[11] !== false) {
          totalEgresosVivos++;
          tieneEgreso = true;
        }

        // Egresos muertos (columna 12 - √≠ndice 12)
        if (registro[12] && registro[12].toString().trim() !== '' && registro[12] !== false) {
          totalEgresosMuertos++;
          tieneEgreso = true;
        }

        // Pases a (columna 13 - √≠ndice 13)
        if (registro[13] && registro[13].trim() !== '' && registro[13] !== '‚Äî Selecciona ‚Äî') {
          totalPasesA++;
        }

        // Ingresos y egresos del mismo d√≠a
        if (tieneIngreso && tieneEgreso) {
          ingresosEgresosMismoDia++;
        }
      });

      const totalEgresos = totalEgresosVivos + totalEgresosMuertos;
      const totalCamasDesocupadas = Math.max(0, totalCamas - totalCamasOcupadas);

      // C√°lculo de existencia del d√≠a anterior (simplificado)
      const existenciaInicial = Math.max(0, totalCamasOcupadas - totalIngresos - totalPasesDe + totalEgresos + totalPasesA);

      // Existencia final seg√∫n f√≥rmula
      const existenciaFinal = existenciaInicial + totalPasesDe + totalIngresos - totalEgresos - totalPasesA;

      console.log('Totales calculados:', {
        camasOcupadas: totalCamasOcupadas,
        camasDesocupadas: totalCamasDesocupadas,
        totalCamas: totalCamas,
        pasesDe: totalPasesDe,
        ingresos: totalIngresos,
        egresosVivos: totalEgresosVivos,
        egresosMuertos: totalEgresosMuertos,
        egresosTotal: totalEgresos,
        pasesA: totalPasesA,
        existenciaInicial: existenciaInicial,
        existenciaFinal: existenciaFinal,
        totalDiasPaciente: totalDiasPaciente,
        ingresosEgresosMismoDia: ingresosEgresosMismoDia
      });

      return {
        camasOcupadas: totalCamasOcupadas,
        camasDesocupadas: totalCamasDesocupadas,
        totalCamas: totalCamas,
        pasesDe: totalPasesDe,
        ingresos: totalIngresos,
        egresosVivos: totalEgresosVivos,
        egresosMuertos: totalEgresosMuertos,
        egresosTotal: totalEgresos,
        pasesA: totalPasesA,
        existenciaInicial: existenciaInicial,
        existenciaFinal: Math.max(0, existenciaFinal),
        totalDiasPaciente: totalDiasPaciente,
        ingresosEgresosMismoDia: ingresosEgresosMismoDia
      };
    }

    function generarFormatoSINBA(fecha, servicio, sala, registros, totales) {
      const fechaFormateada = formatearFechaTexto(fecha);
      const fechaSINBA = formatearFechaSINBA(fecha);

      // Obtener informaci√≥n del usuario actual
      const usuario = localStorage.getItem('usuario') || 'Usuario';
      const rol = localStorage.getItem('rol') || 'Rol no definido';
      const userInfo = `${usuario} (${rol})`;

      let html = `
                <div class="formato-sinba-preview">
                    <div class="sinba-form-code">SINBA-SIS-65-P</div>
                    
                    <div class="sinba-header">
                        <div>
                            <div class="sinba-unidad">1 UNIDAD:</div>
                            <div style="color: #1e3a8a;">HOSPITAL REGIONAL PUERTO VALLARTA</div>
                        </div>
                        <div>
                            <div class="sinba-title">REGISTRO DIARIO DEL MOVIMIENTO DE</div>
                            <div class="sinba-title">PACIENTES EN HOSPITALIZACI√ìN</div>
                            <div class="sinba-title">SIS-2021</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
                        <div>
                            <div class="servicio-sala">
                                <div>
                                    <div><strong>2 SERVICIO</strong></div>
                                    <div style="color: #1e3a8a; font-weight: 500;">${servicio}</div>
                                </div>
                                <div>
                                    <div><strong>3 SALA</strong></div>
                                    <div style="color: #1e3a8a;">${sala || 'N/A'}</div>
                                </div>
                            </div>
                            <div style="margin-top: 10px; color: #1e3a8a;">
                                <strong>5 FECHA:</strong> ${fechaSINBA}
                            </div>
                        </div>
                        <div>
                            <div class="camas-section">
                                <div class="camas-label">4 C A M A S</div>
                                <div>4a OCUPADAS</div>
                                <div>4b DESOCUPADAS</div>
                            </div>
                            <div class="camas-section">
                                <div></div>
                                <div style="color: #dc2626; font-weight: bold;">${totales.camasOcupadas}</div>
                                <div style="color: #dc2626; font-weight: bold;">${totales.camasDesocupadas}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CUERPO DE LA FORMA (seg√∫n instructivo) -->
                    <table class="sinba-grid">
                        <thead>
                            <tr>
                                <th class="column-numero">6<br>N√öMERO</th>
                                <th class="column-numero">6 a<br>CAMA</th>
                                <th class="column-expediente">6 b<br>EXPEDIENTE</th>
                                <th class="column-nombre">7.<br>NOMBRE<br>(COMPLETO)</th>
                                <th class="column-pases-de">8.<br>PASES DE<br>(hora e iniciales<br>del servicio)</th>
                                <th colspan="3" style="background: #dbeafe;">9.<br>INGRESOS</th>
                                <th colspan="2" style="background: #fee2e2;">10.<br>EGRESOS</th>
                                <th class="column-pases-a">11.<br>PASES A<br>(hora e iniciales<br>del servicio)</th>
                                <th class="column-total">12.<br>TOTAL</th>
                            </tr>
                            <tr>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th style="background: #dbeafe; font-size: 10px;">CONSULTA<br>EXTERNA</th>
                                <th style="background: #dbeafe; font-size: 10px;">URGENCIAS</th>
                                <th style="background: #dbeafe; font-size: 10px;">OTRA<br>UNIDAD</th>
                                <th style="background: #fee2e2; font-size: 10px;">VIVO</th>
                                <th style="background: #fee2e2; font-size: 10px;">MUERTO</th>
                                <th></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
            `;

      // Filas de datos de pacientes (m√°ximo 20 por hoja seg√∫n formato)
      registros.slice(0, 20).forEach((registro, index) => {
        const numero = index + 1;
        const cama = registro[5] || ''; // Columna 6 - Cama
        const expediente = registro[6] || ''; // Columna 7 - Expediente
        const nombre = registro[7] || ''; // Columna 8 - Nombre

        // Pase de (columna 4)
        const paseDe = registro[3] || ''; // Columna 4 - Pase de
        const horaPaseDe = registro[4] || ''; // Columna 5 - Hora pase de

        // Convertir a string y limpiar
        const horaPaseDeStr = horaPaseDe ? horaPaseDe.toString() : '';
        const horaPaseDeClean = horaPaseDeStr.replace(/[^0-9:]/g, '');

        // Ingresos - verificar de d√≥nde vino
        // IMPORTANTE: Estas columnas deben tener true/false o 'X' para marcar
        const ingresoConsulta = (registro[8] && registro[8] !== false) ? 'X' : '';
        const ingresoUrgencias = (registro[9] && registro[9] !== false) ? 'X' : '';
        const ingresoOtraUnidad = (registro[10] && registro[10] !== false) ? 'X' : '';

        // Egresos
        const egresoVivo = (registro[11] && registro[11] !== false) ? 'X' : '';
        const egresoMuerto = (registro[12] && registro[12] !== false) ? 'X' : '';

        // Pase a (columna 14)
        const paseA = registro[13] || ''; // Columna 14 - Pase a
        const horaPaseA = registro[14] || ''; // Columna 15 - Hora pase a

        // Convertir a string y limpiar
        const horaPaseAStr = horaPaseA ? horaPaseA.toString() : '';
        const horaPaseAClean = horaPaseAStr.replace(/[^0-9:]/g, '');

        // Formatear pases
        const paseDeFormateado = paseDe ?
          `${horaPaseDeClean ? horaPaseDeClean.substring(0, 5) : ''} ${paseDe.substring(0, 3).toUpperCase()}`.trim() : '';

        const paseAFormateado = paseA ?
          `${horaPaseAClean ? horaPaseAClean.substring(0, 5) : ''} ${paseA.substring(0, 3).toUpperCase()}`.trim() : '';

        html += `
                    <tr>
                        <td style="color: #1e40af; font-weight: bold;">${numero}</td>
                        <td style="color: #1e3a8a;">${cama}</td>
                        <td style="color: #1e3a8a;">${expediente}</td>
                        <td class="column-nombre" style="color: #1e3a8a; font-weight: 500;">${nombre}</td>
                        <td style="color: #1e3a8a; font-size: 10px;">${paseDeFormateado}</td>
                        <td style="color: #dc2626; font-weight: bold;">${ingresoConsulta}</td>
                        <td style="color: #dc2626; font-weight: bold;">${ingresoUrgencias}</td>
                        <td style="color: #dc2626; font-weight: bold;">${ingresoOtraUnidad}</td>
                        <td style="color: #dc2626; font-weight: bold;">${egresoVivo}</td>
                        <td style="color: #dc2626; font-weight: bold;">${egresoMuerto}</td>
                        <td style="color: #1e3a8a; font-size: 10px;">${paseAFormateado}</td>
                        <td style="color: #1e3a8a;"></td>
                    </tr>
                `;
      });

      // Agregar filas vac√≠as si hay menos de 20 registros
      const filasVacias = 20 - Math.min(registros.length, 20);
      for (let i = 0; i < filasVacias; i++) {
        html += `
                    <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    </tr>
                `;
      }

      // RESUMEN (seg√∫n instructivo cuadros 13-20)
      html += `
                        </tbody>
                    </table>
                    
                    <div class="sinba-footer">
                        <div class="resumen-grid">
                            <div class="resumen-item">
                                <div><strong style="color: #1e40af;">13. EXISTENCIA DEL D√çA ANTERIOR</strong></div>
                                <div style="color: #dc2626; font-weight: bold; font-size: 14px;">${totales.existenciaInicial}</div>
                            </div>
                            <div class="resumen-item">
                                <div><strong style="color: #1e40af;">14. PASES DE</strong></div>
                                <div style="color: #dc2626; font-weight: bold; font-size: 14px;">${totales.pasesDe}</div>
                            </div>
                            <div class="resumen-item">
                                <div><strong style="color: #1e40af;">15. INGRESOS</strong></div>
                                <div style="color: #dc2626; font-weight: bold; font-size: 14px;">${totales.ingresos}</div>
                            </div>
                            <div class="resumen-item">
                                <div><strong style="color: #1e40af;">16. EGRESOS</strong></div>
                                <div style="color: #dc2626; font-weight: bold; font-size: 14px;">${totales.egresosTotal}</div>
                            </div>
                            <div class="resumen-item">
                                <div><strong style="color: #1e40af;">17. PASES A</strong></div>
                                <div style="color: #dc2626; font-weight: bold; font-size: 14px;">${totales.pasesA}</div>
                            </div>
                            <div class="resumen-item">
                                <div><strong style="color: #1e40af;">18. EXISTENCIA DE PACIENTES A LAS 24 HORAS</strong></div>
                                <div style="color: #dc2626; font-weight: bold; font-size: 14px;">${totales.existenciaFinal}</div>
                            </div>
                            <div class="resumen-item">
                                <div><strong style="color: #1e40af;">19. INGRESOS Y EGRESOS DEL MISMO D√çA</strong></div>
                                <div style="color: #dc2626; font-weight: bold; font-size: 14px;">${totales.ingresosEgresosMismoDia > 0 ? totales.ingresosEgresosMismoDia : '-'}</div>
                            </div>
                            <div class="resumen-item">
                                <div><strong style="color: #1e40af;">20. TOTAL DE D√çAS PACIENTE</strong></div>
                                <div style="color: #dc2626; font-weight: bold; font-size: 14px;">${totales.totalDiasPaciente}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 10px; text-align: center; color: #1e3a8a;">
                            <strong>21. CAMAS DISPONIBLES:</strong> ${totales.totalCamas}
                        </div>
                        
                        <div class="firmas-container">
                            <div class="firma-area">
                                <strong style="color: #1e40af; font-size: 12px;">ENFERMERA RESPONSABLE</strong>
                                <div class="linea-firma"></div>
                                <div style="color: #1e3a8a; font-size: 10px; margin-top: 5px;">Nombre y Firma</div>
                            </div>
                            <div class="firma-area">
                                <strong style="color: #1e40af; font-size: 12px;">Vo. Bo. JEFE DE ENFERMERAS</strong>
                                <div class="linea-firma"></div>
                                <div style="color: #1e3a8a; font-size: 10px; margin-top: 5px;">Nombre y Firma</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; text-align: center; font-size: 10px; color: #1e3a8a; border-top: 1px solid #1e40af; padding-top: 10px;">
                            <div><strong>Fecha del reporte:</strong> ${fechaFormateada}</div>
                            <div><strong>Servicio:</strong> ${servicio} | <strong>Sala:</strong> ${sala || 'No especificada'} | <strong>Total pacientes:</strong> ${registros.length}</div>
                            <div><strong>Generado por:</strong> ${userInfo}</div>
                        </div>
                    </div>
                </div>
            `;

      return html;
    }

    function formatearFechaSINBA(fechaISO) {
      try {
        const fecha = new Date(fechaISO);
        const dia = fecha.getDate().toString().padStart(2, '0');
        const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
        const anio = fecha.getFullYear().toString().slice(-2);
        return `${dia}-${mes}-${anio}`;
      } catch (error) {
        return fechaISO;
      }
    }

    function formatearFechaTexto(fechaISO) {
      try {
        const fecha = new Date(fechaISO);
        return fecha.toLocaleDateString('es-MX', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      } catch (error) {
        return fechaISO;
      }
    }

    function generarPDF() {
      if (!window.datosReporte) {
        alert('Primero genere una vista previa');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
      });

      const { fecha, servicio, sala, registros, totales, totalCamas } = window.datosReporte;
      const fechaFormateada = formatearFechaTexto(fecha);
      const fechaSINBA = formatearFechaSINBA(fecha);

      // Configurar color del texto en PDF
      doc.setTextColor(30, 58, 138); // Azul oscuro #1e3a8a

      let yPos = 15;
      const pageWidth = doc.internal.pageSize.width;

      // Encabezado del formulario
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(220, 38, 38); // Rojo para el c√≥digo
      doc.text('SINBA-SIS-65-P', pageWidth - 10, 10, { align: 'right' });
      doc.setTextColor(30, 58, 138); // Volver a azul

      // Primera l√≠nea: UNIDAD y T√≠tulo
      doc.text('1 UNIDAD:', 20, yPos);
      doc.setFont('helvetica', 'normal');
      doc.text('HOSPITAL REGIONAL PUERTO VALLARTA', 45, yPos);

      // T√≠tulo centrado
      doc.setFont('helvetica', 'bold');
      doc.text('REGISTRO DIARIO DEL MOVIMIENTO DE', pageWidth / 2, yPos, { align: 'center' });
      yPos += 5;
      doc.text('PACIENTES EN HOSPITALIZACI√ìN', pageWidth / 2, yPos, { align: 'center' });
      doc.text('SIS-2021', pageWidth / 2, yPos + 5, { align: 'center' });
      yPos += 15;

      // Informaci√≥n del servicio y sala
      doc.setFont('helvetica', 'bold');
      doc.text('2 SERVICIO', 20, yPos);
      doc.setFont('helvetica', 'normal');
      doc.text(servicio, 45, yPos);

      doc.setFont('helvetica', 'bold');
      doc.text('3 SALA', 120, yPos);
      doc.setFont('helvetica', 'normal');
      doc.text(sala || 'N/A', 135, yPos);

      // Fecha
      doc.setFont('helvetica', 'bold');
      doc.text('5 FECHA:', 20, yPos + 8);
      doc.setFont('helvetica', 'normal');
      doc.text(fechaSINBA, 45, yPos + 8);

      // Camas
      doc.setFont('helvetica', 'bold');
      doc.text('4 C A M A S', 140, yPos);
      doc.text('4a OCUPADAS', 160, yPos);
      doc.text('4b DESOCUPADAS', 180, yPos);

      doc.setFont('helvetica', 'normal');
      doc.setTextColor(220, 38, 38); // Rojo para n√∫meros
      doc.text(totales.camasOcupadas.toString(), 165, yPos + 8, { align: 'center' });
      doc.text(totales.camasDesocupadas.toString(), 185, yPos + 8, { align: 'center' });
      doc.setTextColor(30, 58, 138); // Volver a azul

      yPos += 20;

      // Encabezado de la tabla
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);

      // Definir anchos de columnas
      const columnWidths = [10, 10, 15, 40, 20, 12, 12, 12, 12, 12, 20, 15];
      const columnHeaders = [
        '6\nN√öMERO',
        '6 a\nCAMA',
        '6 b\nEXPEDIENTE',
        '7.\nNOMBRE\n(COMPLETO)',
        '8.\nPASES DE\n(hora e iniciales\ndel servicio)',
        '9.\nINGRESOS',
        '',
        '',
        '10.\nEGRESOS',
        '',
        '11.\nPASES A\n(hora e iniciales\ndel servicio)',
        '12.\nTOTAL'
      ];

      const subHeaders = [
        '', '', '', '', '',
        'CONSULTA\nEXTERNA',
        'URGENCIAS',
        'OTRA\nUNIDAD',
        'VIVO',
        'MUERTO',
        '', ''
      ];

      let xPos = 10;

      // Dibujar encabezados principales
      columnHeaders.forEach((header, index) => {
        if (index === 5) { // Ingresos (ocupa 3 columnas)
          doc.text(header, xPos + (columnWidths[5] + columnWidths[6] + columnWidths[7]) / 2, yPos - 3, {
            align: 'center',
            maxWidth: columnWidths[5] + columnWidths[6] + columnWidths[7] - 2
          });
        } else if (index === 8) { // Egresos (ocupa 2 columnas)
          doc.text(header, xPos + (columnWidths[8] + columnWidths[9]) / 2, yPos - 3, {
            align: 'center',
            maxWidth: columnWidths[8] + columnWidths[9] - 2
          });
        } else if (index === 6 || index === 7 || index === 9) {
          // Saltar estas columnas (ya fueron cubiertas)
        } else {
          doc.text(header, xPos + columnWidths[index] / 2, yPos - 3, {
            align: 'center',
            maxWidth: columnWidths[index] - 2
          });
        }

        if (index < 11) xPos += columnWidths[index];
      });

      // Dibujar subencabezados
      yPos += 5;
      xPos = 10;

      subHeaders.forEach((header, index) => {
        doc.text(header, xPos + columnWidths[index] / 2, yPos, {
          align: 'center',
          maxWidth: columnWidths[index] - 2,
          fontSize: 7
        });
        xPos += columnWidths[index];
      });

      yPos += 10;

      // Dibujar l√≠neas de la tabla
      doc.setDrawColor(59, 130, 246); // Azul #3b82f6
      const tableHeight = 140;

      // L√≠neas horizontales
      doc.line(10, yPos - 10, pageWidth - 10, yPos - 10); // L√≠nea superior
      doc.line(10, yPos + tableHeight, pageWidth - 10, yPos + tableHeight); // L√≠nea inferior

      // L√≠neas verticales
      xPos = 10;
      doc.line(xPos, yPos - 10, xPos, yPos + tableHeight); // L√≠nea izquierda

      columnWidths.forEach((width) => {
        xPos += width;
        doc.line(xPos, yPos - 10, xPos, yPos + tableHeight);
      });

      doc.setDrawColor(0, 0, 0); // Volver a negro

      // Datos de pacientes
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(30, 58, 138); // Azul oscuro

      let startY = yPos;
      const maxRows = Math.min(registros.length, 20);

      for (let i = 0; i < maxRows; i++) {
        const registro = registros[i];
        const rowY = startY + (i * 7);

        // N√∫mero
        doc.setTextColor(30, 64, 175); // #1e40af
        doc.setFont('helvetica', 'bold');
        doc.text((i + 1).toString(), 15, rowY);

        // Cama
        doc.setTextColor(30, 58, 138); // #1e3a8a
        doc.setFont('helvetica', 'normal');
        const cama = registro[5] || '';
        doc.text(cama, 25, rowY);

        // Expediente
        const expediente = registro[6] || '';
        doc.text(expediente, 35, rowY);

        // Nombre
        const nombre = registro[7] || '';
        doc.text(nombre, 50, rowY, { maxWidth: 35 });

        // Pase de
        const paseDe = registro[3] || '';
        const horaPaseDe = registro[4] || '';
        const horaPaseDeStr = horaPaseDe ? horaPaseDe.toString() : '';
        const horaPaseDeClean = horaPaseDeStr.replace(/[^0-9:]/g, '');
        const paseDeFormateado = paseDe ?
          `${horaPaseDeClean ? horaPaseDeClean.substring(0, 5) : ''} ${paseDe.substring(0, 3).toUpperCase()}`.trim() : '';
        doc.text(paseDeFormateado, 90, rowY, { maxWidth: 18 });

        // Ingresos
        xPos = 108;
        const ingresos = [
          registro[8] ? 'X' : '',
          registro[9] ? 'X' : '',
          registro[10] ? 'X' : ''
        ];

        ingresos.forEach((ingreso, idx) => {
          if (ingreso) {
            doc.setTextColor(220, 38, 38); // Rojo
            doc.setFont('helvetica', 'bold');
            doc.text(ingreso, xPos + (idx * 12), rowY, { align: 'center' });
            doc.setTextColor(30, 58, 138); // Volver a azul
            doc.setFont('helvetica', 'normal');
          } else {
            doc.text('', xPos + (idx * 12), rowY, { align: 'center' });
          }
        });

        // Egresos
        xPos = 144;
        const egresoVivo = registro[11] ? 'X' : '';
        const egresoMuerto = registro[12] ? 'X' : '';

        if (egresoVivo) {
          doc.setTextColor(220, 38, 38); // Rojo
          doc.setFont('helvetica', 'bold');
          doc.text(egresoVivo, xPos, rowY, { align: 'center' });
          doc.setTextColor(30, 58, 138); // Volver a azul
          doc.setFont('helvetica', 'normal');
        }

        if (egresoMuerto) {
          doc.setTextColor(220, 38, 38); // Rojo
          doc.setFont('helvetica', 'bold');
          doc.text(egresoMuerto, xPos + 12, rowY, { align: 'center' });
          doc.setTextColor(30, 58, 138); // Volver a azul
          doc.setFont('helvetica', 'normal');
        }

        // Pase a
        const paseA = registro[13] || '';
        const horaPaseA = registro[14] || '';
        const horaPaseAStr = horaPaseA ? horaPaseA.toString() : '';
        const horaPaseAClean = horaPaseAStr.replace(/[^0-9:]/g, '');
        const paseAFormateado = paseA ?
          `${horaPaseAClean ? horaPaseAClean.substring(0, 5) : ''} ${paseA.substring(0, 3).toUpperCase()}`.trim() : '';
        doc.text(paseAFormateado, 168, rowY, { maxWidth: 18 });

        // Total (vac√≠o)
        doc.text('', 188, rowY);
      }

      yPos = startY + tableHeight + 15;

      // RESUMEN (cuadros 13-20)
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(9);

      // Primera fila del resumen
      const resumenItems = [
        { label: '13. EXISTENCIA DEL D√çA ANTERIOR', value: totales.existenciaInicial },
        { label: '14. PASES DE', value: totales.pasesDe },
        { label: '15. INGRESOS', value: totales.ingresos },
        { label: '16. EGRESOS', value: totales.egresosTotal }
      ];

      xPos = 15;
      resumenItems.forEach((item, index) => {
        doc.setTextColor(30, 64, 175); // Azul #1e40af para etiquetas
        doc.text(item.label, xPos + (index * 45), yPos);

        doc.setTextColor(220, 38, 38); // Rojo para n√∫meros
        doc.text(item.value.toString(), xPos + (index * 45) + 35, yPos, { align: 'center' });
      });

      yPos += 8;

      // Segunda fila del resumen
      const resumenItems2 = [
        { label: '17. PASES A', value: totales.pasesA },
        { label: '18. EXISTENCIA DE PACIENTES A LAS 24 HORAS', value: totales.existenciaFinal },
        { label: '19. INGRESOS Y EGRESOS DEL MISMO D√çA', value: totales.ingresosEgresosMismoDia > 0 ? totales.ingresosEgresosMismoDia.toString() : '-' },
        { label: '20. TOTAL DE D√çAS PACIENTE', value: totales.totalDiasPaciente }
      ];

      resumenItems2.forEach((item, index) => {
        doc.setTextColor(30, 64, 175); // Azul #1e40af para etiquetas
        doc.text(item.label, xPos + (index * 45), yPos);

        doc.setTextColor(220, 38, 38); // Rojo para n√∫meros
        doc.text(item.value.toString(), xPos + (index * 45) + 35, yPos, { align: 'center' });
      });

      yPos += 10;

      // Camas disponibles (21)
      doc.setTextColor(30, 64, 175);
      doc.text('21. CAMAS DISPONIBLES:', 15, yPos);
      doc.setTextColor(220, 38, 38);
      doc.text(totalCamas.toString(), 50, yPos, { align: 'center' });

      yPos += 15;

      // FIRMAS
      doc.setTextColor(30, 58, 138);
      doc.setFont('helvetica', 'bold');
      doc.text('ENFERMERA RESPONSABLE', pageWidth / 4, yPos, { align: 'center' });
      doc.text('Vo. Bo. JEFE DE ENFERMERAS', 3 * pageWidth / 4, yPos, { align: 'center' });

      yPos += 20;

      // L√≠neas para firmas
      doc.setDrawColor(30, 58, 138);
      doc.line(pageWidth / 4 - 40, yPos, pageWidth / 4 + 40, yPos);
      doc.line(3 * pageWidth / 4 - 40, yPos, 3 * pageWidth / 4 + 40, yPos);

      yPos += 5;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8);
      doc.text('Nombre y Firma', pageWidth / 4, yPos, { align: 'center' });
      doc.text('Nombre y Firma', 3 * pageWidth / 4, yPos, { align: 'center' });

      yPos += 15;

      // Informaci√≥n del reporte
      doc.setFontSize(8);
      doc.text(`Fecha del reporte: ${fechaFormateada}`, 15, yPos);
      doc.text(`Servicio: ${servicio}`, 15, yPos + 5);
      doc.text(`Sala: ${sala || 'No especificada'}`, 15, yPos + 10);
      doc.text(`Total pacientes: ${registros.length}`, 15, yPos + 15);

      const usuario = localStorage.getItem('usuario') || 'Sistema';
      doc.text(`Generado por: ${usuario}`, pageWidth - 15, yPos + 15, { align: 'right' });

      // Guardar PDF
      const nombreArchivo = `SINBA-SIS-65-P_${servicio.replace(/\s+/g, '_')}_${fecha.replace(/-/g, '')}.pdf`;
      doc.save(nombreArchivo);
    }

    // Verificar sesi√≥n
    function verificarAutenticacion() {
      const usuario = localStorage.getItem('usuario');
      const rol = localStorage.getItem('rol');
      const loginTime = localStorage.getItem('loginTime');

      if (!usuario || !rol || !loginTime) {
        return false;
      }

      const ahora = Date.now();
      const horasTranscurridas = (ahora - parseInt(loginTime)) / (1000 * 60 * 60);

      return horasTranscurridas <= 24;
    }

    // Verificar al cargar
    document.addEventListener('DOMContentLoaded', function () {
      if (!verificarAutenticacion()) {
        alert('Sesi√≥n expirada. Por favor, inicie sesi√≥n nuevamente.');
        window.location.href = '/estadisticas/login.html';
      }
    });

    function debugRegistros(datos) {
      console.log('=== DEBUG DE REGISTROS ===');
      console.log('Total registros:', datos.length);

      if (datos.length > 0) {
        console.log('Primer registro:', datos[0]);
        console.log('Estructura del primer registro:');
        datos[0].forEach((valor, index) => {
          console.log(`Columna ${index}:`, valor, 'Tipo:', typeof valor);
        });
      }

      console.log('=== FIN DEBUG ===');
    }


  </script>
</body>

</html>