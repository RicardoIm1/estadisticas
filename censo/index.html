<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SINBA-SIS-65-P | Censo Diario</title>
  <link rel="stylesheet" href="../main_css/estilos.css">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <script src="estadoSistema.js"></script>
  <style>
    /* === Ajustes visuales === */
    .formulario {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }

    .campo {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      margin-bottom: 0.3rem;
    }

    .tabla-wrapper {
      margin-top: 2rem;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      text-align: left;
      color: white;
    }

    th, td {
      padding: 0.6rem;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    th {
      background: rgba(255,255,255,0.1);
      font-weight: 600;
      text-transform: uppercase;
    }

    tr:nth-child(even) {
      background: rgba(255,255,255,0.05);
    }

    .cargando {
      text-align: center;
      padding: 1rem;
      font-style: italic;
      color: #ccc;
    }
  </style>
</head>

<body class="fondo-gradiente">
  <header class="header glass sombra">
    <h1 class="titulo-app">üè• SINBA-SIS-65-P</h1>
    <p class="subtitulo-header">Registro diario de movimiento de pacientes</p>
  </header>

  <main class="glass card sombra contenedor-central">
    <form id="formCenso" class="formulario">
      <h2 class="titulo-seccion" style="grid-column:1/-1;">Datos del Paciente</h2>

      <div class="campo">
        <label for="unidad">Unidad</label>
        <input type="text" id="unidad" name="unidad" required>
      </div>

      <div class="campo">
        <label for="fecha">Fecha</label>
        <input type="date" id="fecha" name="fecha" required>
      </div>

      <div class="campo">
        <label for="servicio">Servicio</label>
        <input type="text" id="servicio" name="servicio">
      </div>

      <div class="campo">
        <label for="sala">Sala</label>
        <input type="text" id="sala" name="sala">
      </div>

      <div class="campo">
        <label for="numero_cama">N√∫mero de cama</label>
        <input type="text" id="numero_cama" name="numero_cama">
      </div>

      <div class="campo">
        <label for="expediente">Expediente</label>
        <input type="text" id="expediente" name="expediente">
      </div>

      <div class="campo">
        <label for="nombre">Nombre completo</label>
        <input type="text" id="nombre" name="nombre" required>
      </div>

      <div class="campo">
        <label for="ingreso_tipo">Ingreso</label>
        <select id="ingreso_tipo" name="ingreso_tipo">
          <option value="">Selecciona</option>
          <option value="Consulta externa">Consulta externa</option>
          <option value="Urgencias">Urgencias</option>
          <option value="Otra unidad">Otra unidad</option>
        </select>
      </div>

      <div class="campo">
        <label for="hora_ingreso">Hora ingreso</label>
        <input type="time" id="hora_ingreso" name="hora_ingreso">
      </div>

      <div class="campo">
        <label for="egreso_tipo">Egreso</label>
        <select id="egreso_tipo" name="egreso_tipo">
          <option value="">Selecciona</option>
          <option value="Vivo">Vivo</option>
          <option value="Muerto">Muerto</option>
        </select>
      </div>

      <div class="campo">
        <label for="hora_egreso">Hora egreso</label>
        <input type="time" id="hora_egreso" name="hora_egreso">
      </div>

      <div class="campo" style="grid-column: 1 / -1;">
        <label for="observaciones">Observaciones</label>
        <textarea id="observaciones" name="observaciones" rows="2"></textarea>
      </div>

      <button type="submit" class="boton-principal" style="grid-column: 1 / -1;">üíæ Guardar registro</button>
    </form>

    <!-- Indicador de estado -->
    <div id="message" class="mensaje-estado" style="text-align:center;margin-top:1rem;"></div>

    <!-- === TABLA === -->
    <div class="tabla-wrapper glass card sombra">
      <h2 class="titulo-seccion">Registros guardados</h2>
      <div id="contenedorTabla" class="cargando">Cargando registros...</div>
    </div>
  </main>

  <footer class="footer glass sombra">
    <p>Hospital Regional de Puerto Vallarta ¬∑ SINBA-SIS-65-P ¬∑ <span id="fechaFooter"></span></p>
  </footer>

  <script>
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbwg5Dc5QtmcbzRhtjSFXAffylxAtkaRFJSdj7ep-laoYSaU6fnKmBrUzO83rt43RHG9/exec"; // ‚ö†Ô∏è Reemplaza
    const tablaContenedor = document.getElementById("contenedorTabla");

    // === GUARDAR REGISTRO ===
    document.getElementById("formCenso").addEventListener("submit", function(e) {
      e.preventDefault();
      const datos = Object.fromEntries(new FormData(this).entries());
      datos.action = "save";

      setEstado("loading", "Guardando registro...");

      const callbackName = "callback_" + Date.now();

      window[callbackName] = function(respuesta) {
        if (respuesta.exito) {
          setEstado("success", "Registro guardado exitosamente");
          document.getElementById("formCenso").reset();
          cargarRegistros();
        } else {
          setEstado("error", respuesta.mensaje || "Error al guardar");
        }
        delete window[callbackName];
      };

      const params = new URLSearchParams(datos);
      params.append("callback", callbackName);

      const script = document.createElement("script");
      script.src = `${URL_SCRIPT}?${params.toString()}`;
      document.body.appendChild(script);
    });

    // === CARGAR REGISTROS ===
    function cargarRegistros() {
      setEstado("loading", "Actualizando tabla...");
      const callbackName = "callback_" + Date.now();

      window[callbackName] = function(data) {
        if (!data || !data.length) {
          tablaContenedor.innerHTML = "<p class='cargando'>Sin registros a√∫n.</p>";
          setEstado("success", "Sin registros");
          return;
        }

        const headers = ["Fecha", "Unidad", "Servicio", "Sala", "Cama", "Expediente", "Nombre", "Ingreso", "Egreso", "Observaciones"];
        let html = "<table><thead><tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr></thead><tbody>";

        data.forEach(r => {
          html += `<tr>
            <td>${r[0] || ""}</td>
            <td>${r[1] || ""}</td>
            <td>${r[3] || ""}</td>
            <td>${r[4] || ""}</td>
            <td>${r[5] || ""}</td>
            <td>${r[6] || ""}</td>
            <td>${r[7] || ""}</td>
            <td>${r[8] || ""}</td>
            <td>${r[10] || ""}</td>
            <td>${r[12] || ""}</td>
          </tr>`;
        });

        html += "</tbody></table>";
        tablaContenedor.innerHTML = html;

        setEstado("success", "Registros actualizados");
        delete window[callbackName];
      };

      const script = document.createElement("script");
      script.src = `${URL_SCRIPT}?action=get&callback=${callbackName}`;
      document.body.appendChild(script);
    }

    cargarRegistros();

    document.getElementById("fechaFooter").textContent =
      new Date().toLocaleDateString("es-MX", { day: "2-digit", month: "long", year: "numeric" });
  </script>
</body>
</html>
