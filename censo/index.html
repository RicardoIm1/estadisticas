<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Estad√≠sticas y Archivo Cl√≠nico</title>
  <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
  <link rel="icon" href="../img/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="/estadisticas/censo/censo.css" rel="stylesheet">
  <link href="/estadisticas/censo/tabla-wrapper-censo.css" rel="stylesheet">
</head>

<body>
  <div class="glass" id="dashboard">
    <h5>Registro diario del movimiento de pacientes en hospitalizaci√≥n</h5>
    <div class="header">
      <div class="logo">
        <a href="/estadisticas"><img src="../img/logo-hrpv.png" alt="Logo" width="120"></a>
      </div>
      <div>
        <div class="usuario">
          <i class="fa-solid fa-user-circle"></i>
          <span id="user-info"></span>
          <button onclick="cerrarSesion()" class="btn-salir-ultra">
            Salir
          </button>
        </div>
      </div>
    </div>

    <div class="contenedor-flex">
      <form id="formCenso" class="formulario" autocomplete="off">
        <!-- Unidad -->
        <div class="bloque">
          <label for="unidad">Unidad</label>
          <input id="unidad" name="unidad" readonly value="HOSPITAL REGIONAL PUERTO VALLARTA">
        </div>

        <div class="bloque-horizontal">
          <!-- Fecha -->
          <div class="bloque">
            <label for="fecha">Fecha</label>
            <input id="fecha" name="fecha" type="date" required>
          </div>
          <!-- Servicio -->
          <div class="bloque">
            <label for="servicio">Servicio</label>
            <select id="servicio" name="servicio" required>
              <option value="">‚Äî Selecciona ‚Äî</option>
              <option>CIRUGIA GENERAL</option>
              <option>GINECOLOGIA</option>
              <option>MEDICINA INTERNA</option>
              <option>PEDIATRIA</option>
              <option>TRAUMATOLOGIA Y ORTOPEDIA</option>
              <option>UCIN</option>
            </select>
          </div>
        </div>

        <div class="bloque-horizontal">
          <div class="bloque">
            <label for="numero_cama">No. cama</label>
            <input id="numero_cama" name="numero_cama" type="text">
          </div>
          <div class="bloque">
            <label for="expediente">Expediente</label>
            <input id="expediente" name="expediente" type="text">
          </div>
          <div class="bloque">
            <label for="foliador">Foliador</label>
            <input type="text" id="foliador" readonly tabindex="-1">
          </div>
        </div>

        <div class="bloque">
          <label for="nombre">Nombre completo</label>
          <input id="nombre" name="nombre" type="text" required>
        </div>

        <!-- Informaci√≥n de ingreso -->
        <h3>Ingreso</h3>
        <div class="bloque">
          <label for="pase_de">Pase de</label>
          <select id="pase_de" name="pase_de">
            <option value="">‚Äî Selecciona ‚Äî</option>
            <option>GINECOLOGIA</option>
            <option>MEDICINA INTERNA</option>
            <option>CIRUGIA GENERAL</option>
            <option>TRAUMATOLOGIA Y ORTOPEDIA</option>
            <option>PEDIATRIA</option>
            <option>UCIN</option>
          </select>
        </div>
        <div class="bloque-horizontal">
          <!-- Hora -->
          <div class="bloque">
            <label for="hora_ingreso_consulta_externa">Consulta externa (HH:MM)</label>
            <input id="hora_ingreso_consulta_externa" name="hora_ingreso_consulta_externa" type="text" step="60"
              inputmode="numeric" placeholder="HH:MM">
          </div>
          <!-- Hora -->
          <div class="bloque">
            <label for="hora_ingreso_urgencias">Urgencias (HH:MM)</label>
            <input id="hora_ingreso_urgencias" name="hora_ingreso_urgencias" type="text" step="60" inputmode="numeric"
              placeholder="HH:MM">
          </div>
          <!-- Hora -->
          <div class="bloque">
            <label for="hora_ingreso_otra_unidad">Otra unidad (HH:MM)</label>
            <input id="hora_ingreso_otra_unidad" name="hora_ingreso_otra_unidad" type="text" step="60"
              inputmode="numeric" placeholder="HH:MM">
          </div>
        </div>

        <!-- Informaci√≥n de egreso -->
        <h3>Egreso</h3>
        <div class="bloque-horizontal">
          <!-- Hora -->
          <div class="bloque">
            <label for="hora_egreso_vivo">Vivo (HH:MM)</label>
            <input id="hora_egreso_vivo" name="hora_egreso_vivo" type="text" step="60" inputmode="numeric"
              placeholder="HH:MM">
          </div>
          <!-- Hora -->
          <div class="bloque">
            <label for="hora_egreso_muerto">Muerto (HH:MM)</label>
            <input id="hora_egreso_muerto" name="hora_egreso_muerto" type="text" step="60" inputmode="numeric"
              placeholder="HH:MM">
          </div>
        </div>

        <!-- Destino -->
        <div class="bloque">
          <label for="servicio_destino">Servicio destino</label>
          <select id="servicio_destino" name="servicio_destino">
            <option value="">‚Äî Selecciona ‚Äî</option>
            <option>ALTA VOLUNTARIA</option>
            <option>CIRUGIA GENERAL</option>
            <option>DEFUNCION</option>
            <option>FUGA</option>
            <option>GINECOLOGIA</option>
            <option>IMSS</option>
            <option>MEDICINA INTERNA</option>
            <option>MEJORIA</option>
            <option>PEDIATRIA</option>
            <option>TRAUMATOLOGIA Y ORTOPEDIA</option>
            <option>UCIN</option>
          </select>
        </div>

        <!-- Observaciones -->
        <div class="bloque">
          <label for="observaciones">Observaciones</label>
          <textarea id="observaciones" name="observaciones" rows="2"></textarea>
        </div>

        <button class="btn-salir-ultra" id="btnGuardar">Guardar</button>
      </form>

      <div class="glass-inner">
        <div class="buscador-wrapper">
          <input type="text" id="buscador" placeholder="üîç Buscar por cualquier campo..." class="input-busqueda">
        </div>
        <div id="contenedorTabla" class="tabla-wrapper cargando">
          Cargando registros...
        </div>
      </div>
    </div>

    <footer>
      <p id="footerText">Hecho con ‚ù§Ô∏è por Ricardo ¬∑ 2023</p>
    </footer>
  </div> <!-- end .glass -->
<script>
// ===============================
// üß† CONTROL DE TABULACI√ìN INTELIGENTE PARA FORMULARIO CENSO
// ===============================
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('formCenso');
    if (!form) return;

    // üîç Elementos clave para la l√≥gica de tabulaci√≥n
    const elementos = {
        fecha: document.getElementById('fecha'),
        servicio: document.getElementById('servicio'),
        numero_cama: document.getElementById('numero_cama'),
        expediente: document.getElementById('expediente'),
        nombre: document.getElementById('nombre'),
        pase_de: document.getElementById('pase_de'),
        hora_ingreso_consulta_externa: document.getElementById('hora_ingreso_consulta_externa'),
        hora_ingreso_urgencias: document.getElementById('hora_ingreso_urgencias'),
        hora_ingreso_otra_unidad: document.getElementById('hora_ingreso_otra_unidad'),
        hora_egreso_vivo: document.getElementById('hora_egreso_vivo'),
        hora_egreso_muerto: document.getElementById('hora_egreso_muerto'),
        servicio_destino: document.getElementById('servicio_destino'),
        observaciones: document.getElementById('observaciones'),
        foliador: document.getElementById('foliador'),
        btnGuardar: document.getElementById('btnGuardar')
    };

    // Validar que existan los elementos esenciales
    if (!elementos.fecha || !elementos.btnGuardar) return;

    // üéØ Secuencia normal de tabulaci√≥n (excluyendo foliador)
    const secuenciaNormal = [
        elementos.fecha,
        elementos.servicio,
        elementos.numero_cama,
        elementos.expediente,
        elementos.nombre,
        elementos.pase_de,
        elementos.hora_ingreso_consulta_externa,
        elementos.hora_ingreso_urgencias,
        elementos.hora_ingreso_otra_unidad,
        elementos.hora_egreso_vivo,
        elementos.hora_egreso_muerto,
        elementos.servicio_destino,
        elementos.observaciones,
        elementos.btnGuardar
    ].filter(el => el !== null);

    // üîÑ Funci√≥n para configurar tabulaci√≥n normal
    function configurarTabulacionNormal() {
        secuenciaNormal.forEach((el, index) => {
            if (el) el.tabIndex = index + 1;
        });

        // Fol√≠ador siempre excluido de tabulaci√≥n
        if (elementos.foliador) elementos.foliador.tabIndex = -1;

        // Aplicar l√≥gica de exclusi√≥n para hora_egreso_muerto si hay dato en vivo
        if (elementos.hora_egreso_vivo && elementos.hora_egreso_vivo.value.trim() !== '') {
            if (elementos.hora_egreso_muerto) elementos.hora_egreso_muerto.tabIndex = -1;
        }
    }

    // üöÄ Funci√≥n para manejar tabulaci√≥n inteligente en ingreso
    function manejarTabulacionIngreso() {
        const tieneConsulta = elementos.hora_ingreso_consulta_externa.value.trim() !== '';
        const tieneUrgencias = elementos.hora_ingreso_urgencias.value.trim() !== '';
        const tieneOtraUnidad = elementos.hora_ingreso_otra_unidad.value.trim() !== '';
        
        if (tieneConsulta || tieneUrgencias || tieneOtraUnidad) {
            secuenciaNormal.forEach(el => {
                if (el && el !== elementos.btnGuardar) {
                    const esCampoIngreso = 
                        el === elementos.hora_ingreso_consulta_externa ||
                        el === elementos.hora_ingreso_urgencias ||
                        el === elementos.hora_ingreso_otra_unidad;
                    el.tabIndex = esCampoIngreso ? 0 : -1;
                }
            });
            elementos.btnGuardar.tabIndex = 0;
        } else {
            configurarTabulacionNormal();
        }
    }

    // ‚å®Ô∏è Interceptar Tab para saltar al bot√≥n guardar cuando corresponda
    function manejarKeydown(e) {
        if (e.key === 'Tab' && !e.shiftKey) {
            const campoActual = document.activeElement;
            
            // Saltar a guardar desde campos de ingreso con datos
            if ((campoActual === elementos.hora_ingreso_consulta_externa && elementos.hora_ingreso_consulta_externa.value.trim() !== '') ||
                (campoActual === elementos.hora_ingreso_urgencias && elementos.hora_ingreso_urgencias.value.trim() !== '') ||
                (campoActual === elementos.hora_ingreso_otra_unidad && elementos.hora_ingreso_otra_unidad.value.trim() !== '')) {
                e.preventDefault();
                elementos.btnGuardar.focus();
                return;
            }

            // Saltar egreso_muerto si hay dato en egreso_vivo
            if (campoActual === elementos.hora_egreso_vivo && 
                elementos.hora_egreso_vivo.value.trim() !== '' &&
                elementos.hora_egreso_muerto) {
                const siguienteIndex = secuenciaNormal.indexOf(elementos.hora_egreso_vivo) + 2;
                if (secuenciaNormal[siguienteIndex]) {
                    e.preventDefault();
                    secuenciaNormal[siguienteIndex].focus();
                }
            }
        }
    }

    // üìù Configurar eventos
    function configurarEventos() {
        [elementos.hora_ingreso_consulta_externa, 
         elementos.hora_ingreso_urgencias, 
         elementos.hora_ingreso_otra_unidad].forEach(campo => {
            if (campo) {
                campo.addEventListener('input', manejarTabulacionIngreso);
                campo.addEventListener('keydown', manejarKeydown);
            }
        });
        
        if (elementos.hora_egreso_vivo) {
            elementos.hora_egreso_vivo.addEventListener('input', configurarTabulacionNormal);
        }
        
        form.addEventListener('keydown', manejarKeydown);
    }

    // üéâ Inicializaci√≥n
    function inicializarTabulacion() {
        configurarTabulacionNormal();
        configurarEventos();
        
        // Foco inicial en fecha
        setTimeout(() => {
            elementos.fecha.focus();
        }, 500);
    }

    // üöÄ Iniciar tabulaci√≥n
    inicializarTabulacion();
    
    // Hacer funci√≥n disponible globalmente
    window.actualizarTabulacion = configurarTabulacionNormal;
});
</script>

<script>
// ===============================
// üéØ SCRIPT PRINCIPAL (MODIFICADO)
// ===============================

/* -----------------------
   setEstado: aplica clases a .glass
   ----------------------- */
function setEstado(estado) {
    const glass = document.querySelector('.glass');
    if (!glass) return;
    glass.classList.remove('loading', 'success', 'error');
    glass.classList.add(estado);
    if (estado === 'success' || estado === 'error') {
        setTimeout(() => glass.classList.remove(estado), 2500);
    }
}

// footer din√°mico (seguro)
const ft = document.getElementById('footerText');
if (ft) ft.innerHTML = `Hecho con ‚ù§Ô∏è por Ricardo ¬∑ ${new Date().getFullYear()}`;

const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbyhMRSZlKTZeveL0wHukElK92ntfc7yTfFCCyEeFnLsQCvIra2Tzn5_cN3MZdqZbgGH/exec";

const form = document.getElementById("formCenso");
const tablaContenedor = document.getElementById("contenedorTabla");

// ---------------------- Inicializar fecha ----------------------
if (document.getElementById("fecha")) {
    document.getElementById("fecha").valueAsDate = new Date();
}

// ---------------------- Validaci√≥n de horas ----------------------
function validarHoras() {
    if (!form) return { ok: true };
    const ingreso = [
        form.hora_ingreso_consulta_externa?.value,
        form.hora_ingreso_urgencias?.value,
        form.hora_ingreso_otra_unidad?.value
    ].filter(Boolean);
    if (ingreso.length > 1) return { ok: false, mensaje: "Solo puede haber una hora de ingreso" };

    const egreso = [
        form.hora_egreso_vivo?.value,
        form.hora_egreso_muerto?.value
    ].filter(Boolean);
    if (egreso.length > 1) return { ok: false, mensaje: "Solo puede haber una hora de egreso" };

    return { ok: true };
}

// ---------------------- Validaci√≥n de campos requeridos ----------------------
function validarCamposRequeridos() {
    const camposRequeridos = ['fecha', 'servicio', 'nombre'];
    const errores = [];

    camposRequeridos.forEach(campo => {
        const elemento = form.querySelector(`[name="${campo}"]`);
        if (elemento && !elemento.value.trim()) {
            errores.push(`El campo "${elemento.previousElementSibling?.textContent || campo}" es obligatorio`);
        }
    });

    return errores;
}

// ---------------------- Guardar registro (VERSI√ìN √öNICA) ----------------------
function guardarRegistro() {
    // Validar campos requeridos
    const erroresRequeridos = validarCamposRequeridos();
    if (erroresRequeridos.length > 0) {
        alert("Por favor complete los siguientes campos obligatorios:\n\n" + erroresRequeridos.join("\n"));
        return;
    }

    // Validar horas
    const v = validarHoras();
    if (!v.ok) {
        setEstado("error");
        alert(v.mensaje);
        return;
    }

    const fd = new FormData(form);
    const datos = {};
    fd.forEach((v, k) => datos[k] = v);
    datos.unidad = "HOSPITAL REGIONAL PUERTO VALLARTA";
    datos.action = "save";

    const cb = "cb_" + Date.now();
    window[cb] = function (resp) {
        if (resp.exito) {
            setEstado("success");
            // Mostrar folio solo despu√©s de guardar
            if (resp.foliador) document.getElementById("foliador").value = resp.foliador;

            // Limpiar campos espec√≠ficos
            const camposALimpiar = [
                'numero_cama', 'expediente', 'nombre', 'pase_de',
                'hora_ingreso_consulta_externa', 'hora_ingreso_urgencias',
                'hora_ingreso_otra_unidad', 'hora_egreso_vivo', 'hora_egreso_muerto',
                'servicio_destino', 'observaciones'
            ];

            camposALimpiar.forEach(campo => {
                const elemento = form.querySelector(`[name="${campo}"]`);
                if (elemento) elemento.value = '';
            });

            // Persistir en localStorage
            const unidad = form.unidad?.value || "HOSPITAL REGIONAL PUERTO VALLARTA";
            const fecha = form.fecha?.value || new Date().toISOString().split('T')[0];
            const servicio = form.servicio?.value || "";

            localStorage.setItem("ultima_unidad", unidad);
            localStorage.setItem("ultima_fecha", fecha);
            localStorage.setItem("ultimo_servicio", servicio);

            // Fol√≠ador excluido de tabulaci√≥n
            const foliador = document.getElementById("foliador");
            if (foliador) foliador.tabIndex = -1;

            // Recargar registros
            cargarRegistros();

            // üîÑ RESTAURAR TABULACI√ìN Y FOCO despu√©s de guardar
            setTimeout(() => {
                if (window.actualizarTabulacion) {
                    window.actualizarTabulacion();
                }
                const campoCama = document.querySelector('[name="numero_cama"], #numero_cama');
                if (campoCama) campoCama.focus();
            }, 400);
        } else {
            setEstado("error");
            alert("Error: " + (resp.mensaje || "No se pudo guardar."));
        }
        setTimeout(() => delete window[cb], 500);
    };

    const params = new URLSearchParams(datos);
    params.append("callback", cb);

    setEstado("loading");
    const s = document.createElement("script");
    s.src = `${URL_SCRIPT}?${params.toString()}`;
    s.onerror = () => {
        setEstado("error");
        alert("Error de conexi√≥n. Verifique su conexi√≥n a Internet.");
    };
    document.body.appendChild(s);
}

// ---------------------- Asignar bot√≥n ----------------------
document.getElementById("btnGuardar")?.addEventListener("click", e => {
    e.preventDefault();
    guardarRegistro();
});

// ... (el resto del c√≥digo permanece igual - funciones de formato hora, cargarRegistros, etc.)
</script>

  <script src="../main_js/estadoSistema.js"></script>
</body>

</html>