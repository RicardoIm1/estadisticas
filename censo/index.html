<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Estad√≠sticas y Archivo Cl√≠nico</title>
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
    <link rel="icon" href="../img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="/estadisticas/censo/censo.css" rel="stylesheet">
    <link href="/estadisticas/censo/tabla-wrapper-censo.css" rel="stylesheet">
</head>

<body>
    <div class="glass" id="dashboard">
        <h5>Registro diario del movimiento de pacientes en hospitalizaci√≥n</h5>
        <div class="header">
            <div class="logo">
                <a href="/estadisticas"><img src="../img/logo-hrpv.png" alt="Logo" width="120"></a>
            </div>
            <div class="buscador-wrapper">
                <input type="text" id="buscador" placeholder="üîç Buscar por cualquier campo..." class="input-busqueda">
            </div>
            <a href="/estadisticas/censo/total-censo.html" target="_self"
                style="padding: 10px 20px; background-color: #1e40af; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">
                Ver censo
            </a>
            <div>
                <div class="usuario">
                    <i class="fa-solid fa-user-circle"></i>
                    <span id="user-info"></span>
                    <button onclick="cerrarSesion()" class="btn-salir-ultra">
                        Salir
                    </button>
                </div>
            </div>
        </div>
        <div class="contenedor-flex">
            <form id="formCenso" class="formulario" autocomplete="off">
                <!-- Unidad -->
                <div class="bloque">
                    <label for="unidad">Unidad</label>
                    <input id="unidad" name="unidad" readonly value="HOSPITAL REGIONAL PUERTO VALLARTA">
                </div>
                <div class="bloque-horizontal">
                    <!-- Fecha -->
                    <div class="bloque">
                        <label for="fecha">Fecha</label>
                        <input id="fecha" name="fecha" type="date" required>
                    </div>
                    <!-- Servicio -->
                    <div class="bloque">
                        <label for="servicio">Servicio</label>
                        <select id="servicio" name="servicio" required>
                            <option value="">‚Äî Selecciona ‚Äî</option>
                            <option>CIRUGIA GENERAL</option>
                            <option>GINECOLOGIA</option>
                            <option>MEDICINA INTERNA</option>
                            <option>PEDIATRIA</option>
                            <option>TRAUMATOLOGIA Y ORTOPEDIA</option>
                            <option>UCIN</option>
                        </select>
                    </div>
                </div>
                <div class="bloque-horizontal">
                    <div class="bloque">
                        <label for="numero_cama">No. cama</label>
                        <input id="numero_cama" name="numero_cama" type="text">
                    </div>
                    <div class="bloque">
                        <label for="expediente">Expediente</label>
                        <input id="expediente" name="expediente" type="text">
                    </div>
                    <div class="bloque">
                        <label for="foliador">Foliador</label>
                        <input type="text" id="foliador" readonly tabindex="-1">
                    </div>
                </div>
                <div class="bloque">
                    <label for="nombre">Nombre completo</label>
                    <input id="nombre" name="nombre" type="text" required>
                </div>
                <!-- Informaci√≥n de ingreso -->
                <h3>Ingreso</h3>
                <div class="bloque">
                    <label for="pase_de">Pase de</label>
                    <select id="pase_de" name="pase_de">
                        <option value="">‚Äî Selecciona ‚Äî</option>
                        <option>GINECOLOGIA</option>
                        <option>MEDICINA INTERNA</option>
                        <option>CIRUGIA GENERAL</option>
                        <option>TRAUMATOLOGIA Y ORTOPEDIA</option>
                        <option>PEDIATRIA</option>
                        <option>UCIN</option>
                    </select>
                </div>
                <div class="bloque-horizontal">
                    <!-- Hora -->
                    <div class="bloque">
                        <label for="hora_ingreso_consulta_externa">Consulta externa (HH:MM)</label>
                        <input id="hora_ingreso_consulta_externa" name="hora_ingreso_consulta_externa" type="text"
                            step="60" inputmode="numeric" placeholder="HH:MM">
                    </div>
                    <!-- Hora -->
                    <div class="bloque">
                        <label for="hora_ingreso_urgencias">Urgencias (HH:MM)</label>
                        <input id="hora_ingreso_urgencias" name="hora_ingreso_urgencias" type="text" step="60"
                            inputmode="numeric" placeholder="HH:MM">
                    </div>
                    <!-- Hora -->
                    <div class="bloque">
                        <label for="hora_ingreso_otra_unidad">Otra unidad (HH:MM)</label>
                        <input id="hora_ingreso_otra_unidad" name="hora_ingreso_otra_unidad" type="text" step="60"
                            inputmode="numeric" placeholder="HH:MM">
                    </div>
                </div>
                <!-- Informaci√≥n de egreso -->
                <h3>Egreso</h3>
                <div class="bloque-horizontal">
                    <!-- Hora -->
                    <div class="bloque">
                        <label for="hora_egreso_vivo">Vivo (HH:MM)</label>
                        <input id="hora_egreso_vivo" name="hora_egreso_vivo" type="text" step="60" inputmode="numeric"
                            placeholder="HH:MM">
                    </div>
                    <!-- Hora -->
                    <div class="bloque">
                        <label for="hora_egreso_muerto">Muerto (HH:MM)</label>
                        <input id="hora_egreso_muerto" name="hora_egreso_muerto" type="text" step="60"
                            inputmode="numeric" placeholder="HH:MM">
                    </div>
                </div>
                <!-- Destino -->
                <div class="bloque">
                    <label for="servicio_destino">Servicio destino</label>
                    <select id="servicio_destino" name="servicio_destino">
                        <option value="">‚Äî Selecciona ‚Äî</option>
                        <option>ALTA VOLUNTARIA</option>
                        <option>CIRUGIA GENERAL</option>
                        <option>DEFUNCION</option>
                        <option>FUGA</option>
                        <option>GINECOLOGIA</option>
                        <option>IMSS</option>
                        <option>MEDICINA INTERNA</option>
                        <option>MEJORIA</option>
                        <option>PEDIATRIA</option>
                        <option>TRAUMATOLOGIA Y ORTOPEDIA</option>
                        <option>UCIN</option>
                        <option>TRASLADO A OTRA UNIDAD</option>
                    </select>
                </div>
                <!-- Observaciones -->
                <div class="bloque">
                    <label for="observaciones">Archivista</label>
                    <textarea id="observaciones" name="observaciones" rows="2"></textarea>
                </div>
                <button class="btn-salir-ultra" id="btnGuardar">Guardar</button>
            </form>
            <div class="glass-inner">
                <div id="contenedorTabla" class="tabla-wrapper cargando">
                    Cargando registros...
                </div>
            </div>
        </div>
        <footer>
            <p id="footerText">Hecho con ‚ù§Ô∏è por Ricardo ¬∑ 2023</p>
        </footer>
    </div> <!-- end .glass -->
    <script>
        // ===============================
        // üß† CONTROL DE TABULACI√ìN INTELIGENTE PARA FORMULARIO CENSO
        // ===============================
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('formCenso');
            if (!form) return;
            // üîç Elementos clave para la l√≥gica de tabulaci√≥n
            const elementos = {
                fecha: document.getElementById('fecha'),
                servicio: document.getElementById('servicio'),
                numero_cama: document.getElementById('numero_cama'),
                expediente: document.getElementById('expediente'),
                nombre: document.getElementById('nombre'),
                pase_de: document.getElementById('pase_de'),
                hora_ingreso_consulta_externa: document.getElementById('hora_ingreso_consulta_externa'),
                hora_ingreso_urgencias: document.getElementById('hora_ingreso_urgencias'),
                hora_ingreso_otra_unidad: document.getElementById('hora_ingreso_otra_unidad'),
                hora_egreso_vivo: document.getElementById('hora_egreso_vivo'),
                hora_egreso_muerto: document.getElementById('hora_egreso_muerto'),
                servicio_destino: document.getElementById('servicio_destino'),
                observaciones: document.getElementById('observaciones'),
                foliador: document.getElementById('foliador'),
                btnGuardar: document.getElementById('btnGuardar')
            };
            // Validar que existan los elementos esenciales
            if (!elementos.fecha || !elementos.btnGuardar) return;
            // üéØ Secuencia normal de tabulaci√≥n (excluyendo foliador)
            const secuenciaNormal = [
                elementos.fecha,
                elementos.servicio,
                elementos.numero_cama,
                elementos.expediente,
                elementos.nombre,
                elementos.pase_de,
                elementos.hora_ingreso_consulta_externa,
                elementos.hora_ingreso_urgencias,
                elementos.hora_ingreso_otra_unidad,
                elementos.hora_egreso_vivo,
                elementos.hora_egreso_muerto,
                elementos.servicio_destino,
                elementos.observaciones,
                elementos.btnGuardar
            ].filter(el => el !== null);
            // üîÑ Funci√≥n para configurar tabulaci√≥n normal
            function configurarTabulacionNormal() {
                secuenciaNormal.forEach((el, index) => {
                    if (el) el.tabIndex = index + 1;
                });
                // Fol√≠ador siempre excluido de tabulaci√≥n
                if (elementos.foliador) elementos.foliador.tabIndex = -1;
                // Aplicar l√≥gica de exclusi√≥n para hora_egreso_muerto si hay dato en vivo
                if (elementos.hora_egreso_vivo && elementos.hora_egreso_vivo.value.trim() !== '') {
                    if (elementos.hora_egreso_muerto) elementos.hora_egreso_muerto.tabIndex = -1;
                }
            }
            // üöÄ Funci√≥n para manejar tabulaci√≥n inteligente en ingreso
            function manejarTabulacionIngreso() {
                const tieneConsulta = elementos.hora_ingreso_consulta_externa.value.trim() !== '';
                const tieneUrgencias = elementos.hora_ingreso_urgencias.value.trim() !== '';
                const tieneOtraUnidad = elementos.hora_ingreso_otra_unidad.value.trim() !== '';
                if (tieneConsulta || tieneUrgencias || tieneOtraUnidad) {
                    secuenciaNormal.forEach(el => {
                        if (el && el !== elementos.btnGuardar) {
                            const esCampoIngreso =
                                el === elementos.hora_ingreso_consulta_externa ||
                                el === elementos.hora_ingreso_urgencias ||
                                el === elementos.hora_ingreso_otra_unidad;
                            el.tabIndex = esCampoIngreso ? 0 : -1;
                        }
                    });
                    elementos.btnGuardar.tabIndex = 0;
                } else {
                    configurarTabulacionNormal();
                }
            }
            // ‚å®Ô∏è Interceptar Tab para saltar al bot√≥n guardar cuando corresponda
            function manejarKeydown(e) {
                if (e.key === 'Tab' && !e.shiftKey) {
                    const campoActual = document.activeElement;
                    // Saltar a guardar desde campos de ingreso con datos
                    if ((campoActual === elementos.hora_ingreso_consulta_externa && elementos.hora_ingreso_consulta_externa.value.trim() !== '') ||
                        (campoActual === elementos.hora_ingreso_urgencias && elementos.hora_ingreso_urgencias.value.trim() !== '') ||
                        (campoActual === elementos.hora_ingreso_otra_unidad && elementos.hora_ingreso_otra_unidad.value.trim() !== '')) {
                        e.preventDefault();
                        elementos.btnGuardar.focus();
                        return;
                    }
                    // Saltar egreso_muerto si hay dato en egreso_vivo
                    if (campoActual === elementos.hora_egreso_vivo &&
                        elementos.hora_egreso_vivo.value.trim() !== '' &&
                        elementos.hora_egreso_muerto) {
                        const siguienteIndex = secuenciaNormal.indexOf(elementos.hora_egreso_vivo) + 2;
                        if (secuenciaNormal[siguienteIndex]) {
                            e.preventDefault();
                            secuenciaNormal[siguienteIndex].focus();
                        }
                    }
                }
            }
            // üìù Configurar eventos
            function configurarEventos() {
                [elementos.hora_ingreso_consulta_externa,
                elementos.hora_ingreso_urgencias,
                elementos.hora_ingreso_otra_unidad].forEach(campo => {
                    if (campo) {
                        campo.addEventListener('input', manejarTabulacionIngreso);
                        campo.addEventListener('keydown', manejarKeydown);
                    }
                });
                if (elementos.hora_egreso_vivo) {
                    elementos.hora_egreso_vivo.addEventListener('input', configurarTabulacionNormal);
                }
                form.addEventListener('keydown', manejarKeydown);
            }
            // üéâ Inicializaci√≥n
            function inicializarTabulacion() {
                configurarTabulacionNormal();
                configurarEventos();
                // Foco inicial en fecha
                setTimeout(() => {
                    elementos.fecha.focus();
                }, 500);
            }
            // üöÄ Iniciar tabulaci√≥n
            inicializarTabulacion();
            // Hacer funci√≥n disponible globalmente
            window.actualizarTabulacion = configurarTabulacionNormal;
        });
    </script>
    <script>
        /* -----------------------
           setEstado: aplica clases a .glass
           ----------------------- */
        function setEstado(estado) {
            const glass = document.querySelector('.glass');
            if (!glass) return; // evita errores si el DOM cambia
            glass.classList.remove('loading', 'success', 'error');
            glass.classList.add(estado);
            if (estado === 'success' || estado === 'error') {
                setTimeout(() => glass.classList.remove(estado), 2500);
            }
        }
        // footer din√°mico (seguro)
        const ft = document.getElementById('footerText');
        if (ft) ft.innerHTML = `Hecho con ‚ù§Ô∏è por Ricardo ¬∑ ${new Date().getFullYear()}`;
    </script>
    <script>
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbyhMRSZlKTZeveL0wHukElK92ntfc7yTfFCCyEeFnLsQCvIra2Tzn5_cN3MZdqZbgGH/exec"; // tu WebApp JSONP
        const form = document.getElementById("formCenso");
        const tablaContenedor = document.getElementById("contenedorTabla");
        if (document.getElementById("fecha")) {
            document.getElementById("fecha").valueAsDate = new Date();
        }
        // ---------------------- Validaci√≥n de horas ----------------------
        function validarHoras() {
            if (!form) return { ok: true };
            const ingreso = [
                form.hora_ingreso_consulta_externa?.value,
                form.hora_ingreso_urgencias?.value,
                form.hora_ingreso_otra_unidad?.value
            ].filter(Boolean);
            if (ingreso.length > 1) return { ok: false, mensaje: "Solo puede haber una hora de ingreso" };
            const egreso = [
                form.hora_egreso_vivo?.value,
                form.hora_egreso_muerto?.value
            ].filter(Boolean);
            if (egreso.length > 1) return { ok: false, mensaje: "Solo puede haber una hora de egreso" };
            return { ok: true };
        }
        // ---------------------- Validaci√≥n de campos requeridos ----------------------
        function validarCamposRequeridos() {
            const camposRequeridos = ['fecha', 'servicio', 'nombre'];
            const errores = [];
            camposRequeridos.forEach(campo => {
                const elemento = form.querySelector(`[name="${campo}"]`);
                if (elemento && !elemento.value.trim()) {
                    errores.push(`El campo "${elemento.previousElementSibling?.textContent || campo}" es obligatorio`);
                }
            });
            return errores;
        }
        // ---------------------- Guardar registro ----------------------
        function guardarRegistro() {
            // Validar campos requeridos
            const erroresRequeridos = validarCamposRequeridos();
            if (erroresRequeridos.length > 0) {
                alert("Por favor complete los siguientes campos obligatorios:\n\n" + erroresRequeridos.join("\n"));
                return;
            }
            // Validar horas
            const v = validarHoras();
            if (!v.ok) {
                setEstado("error");
                alert(v.mensaje);
                return;
            }
            const fd = new FormData(form);
            const datos = {};
            fd.forEach((v, k) => datos[k] = v);
            datos.unidad = "HOSPITAL REGIONAL PUERTO VALLARTA";
            datos.action = "save";
            const cb = "cb_" + Date.now();
            window[cb] = function (resp) {
                if (resp.exito) {
                    setEstado("success");
                    // Mostrar folio solo despu√©s de guardar
                    if (resp.foliador) document.getElementById("foliador").value = resp.foliador;
                    // ‚úÖ ELIMINAR form.reset() y usar limpieza controlada
                    const camposALimpiar = [
                        'numero_cama', 'expediente', 'nombre', 'pase_de',
                        'hora_ingreso_consulta_externa', 'hora_ingreso_urgencias',
                        'hora_ingreso_otra_unidad', 'hora_egreso_vivo', 'hora_egreso_muerto',
                        'servicio_destino', 'observaciones'
                    ];
                    // Limpiar solo los campos que deben cambiar
                    camposALimpiar.forEach(campo => {
                        const elemento = form.querySelector(`[name="${campo}"]`);
                        if (elemento) elemento.value = '';
                    });
                    // Los campos 'unidad', 'fecha', 'servicio' se MANTIENEN autom√°ticamente
                    // üíæ Persistir en localStorage (por si el usuario los cambia manualmente)
                    const unidad = form.unidad?.value || "HOSPITAL REGIONAL PUERTO VALLARTA";
                    const fecha = form.fecha?.value || new Date().toISOString().split('T')[0];
                    const servicio = form.servicio?.value || "";
                    localStorage.setItem("ultima_unidad", unidad);
                    localStorage.setItem("ultima_fecha", fecha);
                    localStorage.setItem("ultimo_servicio", servicio);
                    // ‚ö° Asegurar que foliador nunca reciba foco al tabular
                    const foliador = document.getElementById("foliador");
                    if (foliador) foliador.tabIndex = -1;
                    // üîÅ Recargar registros
                    cargarRegistros();
                    // üí° Restaurar tabulaci√≥n y colocar foco en el campo numero_cama
                    setTimeout(() => {
                        if (window.actualizarTabulacion) {
                            window.actualizarTabulacion();
                        }
                        const campoCama = document.querySelector('[name="numero_cama"], #numero_cama');
                        if (campoCama) campoCama.focus();
                    }, 400);
                } else {
                    setEstado("error");
                    alert("Error: " + (resp.mensaje || "No se pudo guardar."));
                }
                setTimeout(() => delete window[cb], 500);
            };
            const params = new URLSearchParams(datos);
            params.append("callback", cb);
            setEstado("loading");
            const s = document.createElement("script");
            s.src = `${URL_SCRIPT}?${params.toString()}`;
            s.onerror = () => {
                setEstado("error");
                alert("Error de conexi√≥n. Verifique su conexi√≥n a Internet.");
            };
            document.body.appendChild(s);
        }
        // ---------------------- Asignar bot√≥n ----------------------
        document.getElementById("btnGuardar")?.addEventListener("click", e => {
            e.preventDefault();
            guardarRegistro();
        });
        // ---------------------- Formato de hora HH:MM ----------------------
        document.querySelectorAll('input[id^="hora_"]').forEach(input => {
            input.addEventListener('input', e => {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 4) v = v.slice(0, 4);
                if (v.length >= 3) v = v.slice(0, 2) + ':' + v.slice(2);
                e.target.value = v;
            });
            input.addEventListener('blur', e => {
                const val = e.target.value;
                if (!val) return;
                if (!/^([01]\d|2[0-3]):[0-5]\d$/.test(val)) {
                    e.target.classList.add('error-hora');
                    setTimeout(() => e.target.classList.remove('error-hora'), 1500);
                    e.target.value = '';
                } else {
                    e.target.value = val.padStart(5, '0');
                }
            });
        });
        // ---------------------- Cargar registros ----------------------
        function cargarRegistros() {
            setEstado("loading");
            const cb = "cb_get_" + Date.now();
            window[cb] = function (data) {
                if (!data || !data.length) {
                    if (tablaContenedor) tablaContenedor.innerHTML = "<p class='tiny'>Sin registros a√∫n.</p>";
                    setEstado("success");
                    delete window[cb];
                    return;
                }
                const headers = [
                    "Fecha", "Unidad", "Servicio", "Pase de", "Sala", "Cama", "Expediente", "Nombre",
                    "Ingreso (consulta)", "Ingreso (urgencias)", "Ingreso (otra)", "Egreso (vivo)", "Egreso (muerto)",
                    "Servicio destino", "Foliador", "Observaciones", "Registro TS"
                ];
                const idxFecha = 0;
                const idxHoraCols = [8, 9, 10, 11, 12, 16];
                const ocultarIdx = [1, 4, 16];
                let html = "<table><thead><tr>" +
                    headers.map((h, i) => ocultarIdx.includes(i) ? "" : `<th>${h}</th>`).join("") +
                    "</tr></thead><tbody>";
                data = data.reverse(); // mostrar m√°s reciente primero
                // √çndices fijos seg√∫n el orden del HEADER del backend
                const idxExpediente = 6;  // "expediente"
                const idxFoliador = 14; // "foliador"
                data.forEach(fila => {
                    html += "<tr>";
                    fila.forEach((celda, i) => {
                        if (ocultarIdx.includes(i)) return;
                        let valor = celda;
                        // === Ajustes visuales ===
                        if (i === idxFecha) valor = formatearFecha(celda);
                        if (idxHoraCols.includes(i)) valor = formatearHora(celda);
                        // === Mantener ceros iniciales ===
                        if (i === idxExpediente && valor) valor = valor.toString().padStart(6, "0");
                        if (i === idxFoliador && valor) valor = valor.toString().padStart(3, "0");
                        html += `<td>${valor || ""}</td>`;
                    });
                    html += "</tr>";
                });
                html += "</tbody></table>";
                if (tablaContenedor) tablaContenedor.innerHTML = html;
                setEstado("success");
                delete window[cb];
            };
            const s = document.createElement("script");
            s.src = `${URL_SCRIPT}?action=get&callback=${cb}`;
            s.onerror = () => {
                setEstado("error");
                if (tablaContenedor) tablaContenedor.innerHTML = "<p class='tiny'>Error al cargar los registros.</p>";
            };
            document.body.appendChild(s);
        }
        // ---------------------- Formatear fecha y hora ----------------------
        function formatearFecha(fechaISO) {
            if (!fechaISO) return "";
            const d = new Date(fechaISO);
            if (isNaN(d)) return fechaISO;
            const dia = String(d.getDate()).padStart(2, '0');
            const mes = String(d.getMonth() + 1).padStart(2, '0');
            const anio = d.getFullYear();
            return `${dia}/${mes}/${anio}`;
        }
        function formatearHora(valor) {
            if (!valor) return "";
            const d = new Date(valor);
            if (!isNaN(d)) return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            if (/^\d{1,2}:\d{2}$/.test(valor)) return valor;
            return "";
        }
        // ---------------------- Mantener unidad, fecha y servicio ----------------------
        window.addEventListener("DOMContentLoaded", () => {
            const campoUnidad = document.getElementById("unidad");
            const campoFecha = document.getElementById("fecha");
            const campoServicio = document.getElementById("servicio");
            const unidadGuardada = localStorage.getItem("ultima_unidad") || "HOSPITAL REGIONAL PUERTO VALLARTA";
            const fechaGuardada = localStorage.getItem("ultima_fecha") || new Date().toISOString().split("T")[0];
            const servicioGuardado = localStorage.getItem("ultimo_servicio") || "";
            if (campoUnidad) {
                campoUnidad.value = unidadGuardada;
                campoUnidad.addEventListener("change", () => localStorage.setItem("ultima_unidad", campoUnidad.value));
            }
            if (campoFecha) {
                campoFecha.value = fechaGuardada;
                campoFecha.addEventListener("change", () => localStorage.setItem("ultima_fecha", campoFecha.value));
            }
            if (campoServicio) {
                campoServicio.value = servicioGuardado;
                campoServicio.addEventListener("change", () => localStorage.setItem("ultimo_servicio", campoServicio.value));
            }
        });
        // ---------------------- Inicializar ----------------------
        cargarRegistros();
    </script>
    <script>
        // === FILTRO DE B√öSQUEDA ===
        const buscador = document.getElementById('buscador');
        if (buscador) {
            buscador.addEventListener('input', function () {
                const filtro = this.value.toLowerCase().trim();
                const filas = document.querySelectorAll('#contenedorTabla table tbody tr');

                filas.forEach(fila => {
                    const texto = fila.textContent.toLowerCase();
                    fila.style.display = texto.includes(filtro) ? '' : 'none';
                });
            });
        }
    </script>

    <script>
        // ========== VERIFICACI√ìN DE SESI√ìN CORREGIDA ==========
        function verificarAutenticacion() {
            const usuario = localStorage.getItem('usuario');
            const rol = localStorage.getItem('rol');
            const loginTime = localStorage.getItem('loginTime');

            console.log('üîç Verificando sesi√≥n:', { usuario, rol, loginTime });

            // ‚úÖ Si NO hay sesi√≥n activa, redirigir AL LOGIN CORRECTO
            if (!usuario || !rol || !loginTime) {
                console.warn('‚ùå No hay sesi√≥n activa - Redirigiendo a login');
                window.location.href = '/estadisticas/login.html';
                return false;
            }

            // Verificar expiraci√≥n (24 horas)
            const ahora = Date.now();
            const horasTranscurridas = (ahora - parseInt(loginTime)) / (1000 * 60 * 60);

            if (horasTranscurridas > 24) {
                console.warn('‚è∞ Sesi√≥n expirada - Redirigiendo a login');
                localStorage.clear();
                window.location.href = '/estadisticas/login.html';
                return false;
            }

            console.log('‚úÖ Sesi√≥n activa:', usuario, 'Rol:', rol);

            // Mostrar en el header
            const userElement = document.getElementById('user-info');
            if (userElement) {
                userElement.innerHTML = `${usuario} (${rol})`;
            }

            return true;
        }

        // Cerrar sesi√≥n
        function cerrarSesion() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                localStorage.clear();
                // ‚úÖ Redirigir al login CORRECTO
                window.location.href = '/estadisticas/login.html';
            }
        }

        // Verificar al cargar la p√°gina - VERSI√ìN MEJORADA
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üìç P√°gina cargada:', window.location.href);

            // Verificar sesi√≥n inmediatamente
            if (!verificarAutenticacion()) {
                console.log('üö® Redirecci√≥n en proceso...');
                // Detener cualquier ejecuci√≥n adicional
                return;
            }

            // Solo ejecutar esto si la sesi√≥n es v√°lida
            console.log('‚úÖ Sesi√≥n v√°lida, continuando...');

            // Hacer funci√≥n global
            window.cerrarSesion = cerrarSesion;
        });

        // Tambi√©n verificar en window.load por si acaso
        window.addEventListener('load', function () {
            console.log('üîÑ Window loaded - Verificando sesi√≥n nuevamente');
            verificarAutenticacion();
        });
    </script>

    <script src="../main_js/estadoSistema.js"></script>
</body>

</html>