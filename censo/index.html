<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SINBA-SIS-65-P | Censo Diario</title>
  <link rel="stylesheet" href="./main_css/estilos.css">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <script src="estadoSistema.js"></script>
  <style>
    .formulario { display: grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap: 1rem; }
    .campo { display:flex; flex-direction:column; }
    label { font-weight:600; margin-bottom:.25rem; }
    .tabla-wrapper { margin-top:1.2rem; overflow-x:auto; }
    table { width:100%; border-collapse:collapse; color:white; }
    th,td { padding:.5rem; border-bottom:1px solid rgba(255,255,255,0.08); }
    th { text-transform:uppercase; background:rgba(255,255,255,0.04); font-weight:700; font-size:.75rem; }
    .tiny { font-size:.85rem; opacity:.85; }
    .mensaje-estado { text-align:center; margin-top: .6rem; min-height:1.6rem; }
    input[readonly] { background: rgba(255,255,255,0.03); color: #fff; }
    .grid-row { display:grid; grid-template-columns: repeat(3, 1fr); gap:.6rem; }
    @media (max-width:720px) { .grid-row { grid-template-columns: 1fr; } }
  </style>
</head>
<body class="fondo-gradiente">
  <header class="header glass sombra">
    <h1 class="titulo-app">üè• SINBA-SIS-65-P</h1>
    <p class="subtitulo-header">Registro diario de movimiento de pacientes</p>
  </header>

  <main class="glass card sombra contenedor-central">
    <form id="formCenso" class="formulario" autocomplete="off">
      <h2 class="titulo-seccion" style="grid-column:1/-1">Datos del Paciente</h2>

      <!-- Unidad (siempre fija) -->
      <div class="campo">
        <label for="unidad">Unidad</label>
        <input id="unidad" name="unidad" readonly value="HOSPITAL REGIONAL PUERTO VALLARTA">
      </div>

      <div class="campo">
        <label for="fecha">Fecha</label>
        <input id="fecha" name="fecha" type="date" required>
      </div>

      <!-- Servicio (select) -->
      <div class="campo">
        <label for="servicio">Servicio</label>
        <select id="servicio" name="servicio" required>
          <option value="">‚Äî Selecciona ‚Äî</option>
          <option>GINECOLOGIA</option>
          <option>MEDICINA INTERNA</option>
          <option>CIRUGIA GENERAL</option>
          <option>TRAUMATOLOGIA Y ORTOPEDIA</option>
          <option>PEDIATRIA</option>
          <option>UCIN</option>
        </select>
      </div>

      <!-- Pase de (select) -->
      <div class="campo">
        <label for="pase_de">Pase de</label>
        <select id="pase_de" name="pase_de">
          <option value="">‚Äî Selecciona ‚Äî</option>
          <option>GINECOLOGIA</option>
          <option>MEDICINA INTERNA</option>
          <option>CIRUGIA GENERAL</option>
          <option>TRAUMATOLOGIA Y ORTOPEDIA</option>
          <option>PEDIATRIA</option>
          <option>UCIN</option>
        </select>
      </div>

      <div class="campo">
        <label for="sala">Sala</label>
        <input id="sala" name="sala" type="text">
      </div>

      <div class="campo">
        <label for="numero_cama">No. cama</label>
        <input id="numero_cama" name="numero_cama" type="text">
      </div>

      <div class="campo">
        <label for="expediente">Expediente</label>
        <input id="expediente" name="expediente" type="text">
      </div>

      <div class="campo" style="grid-column:1/-1">
        <label for="nombre">Nombre completo</label>
        <input id="nombre" name="nombre" type="text" required>
      </div>

      <h3 style="grid-column:1/-1; margin-top:.4rem; font-size:1rem">Ingreso (marcar la hora correspondiente)</h3>
      <div class="campo">
        <label for="hora_ingreso_consulta_externa">Consulta externa (HH:MM)</label>
        <input id="hora_ingreso_consulta_externa" name="hora_ingreso_consulta_externa" type="time">
      </div>

      <div class="campo">
        <label for="hora_ingreso_urgencias">Urgencias (HH:MM)</label>
        <input id="hora_ingreso_urgencias" name="hora_ingreso_urgencias" type="time">
      </div>

      <div class="campo">
        <label for="hora_ingreso_otra_unidad">Otra unidad (HH:MM)</label>
        <input id="hora_ingreso_otra_unidad" name="hora_ingreso_otra_unidad" type="time">
      </div>

      <h3 style="grid-column:1/-1; margin-top:.4rem; font-size:1rem">Egreso</h3>
      <div class="campo">
        <label for="hora_egreso_vivo">Vivo (HH:MM)</label>
        <input id="hora_egreso_vivo" name="hora_egreso_vivo" type="time">
      </div>

      <div class="campo">
        <label for="hora_egreso_muerto">Muerto (HH:MM)</label>
        <input id="hora_egreso_muerto" name="hora_egreso_muerto" type="time">
      </div>

      <!-- Servicio destino -->
      <div class="campo">
        <label for="servicio_destino">Servicio destino</label>
        <select id="servicio_destino" name="servicio_destino">
          <option value="">‚Äî Selecciona ‚Äî</option>
          <option>GINECOLOGIA</option>
          <option>MEDICINA INTERNA</option>
          <option>CIRUGIA GENERAL</option>
          <option>TRAUMATOLOGIA Y ORTOPEDIA</option>
          <option>PEDIATRIA</option>
          <option>UCIN</option>
        </select>
      </div>

      <div class="campo">
        <label for="foliador">Foliador</label>
        <input id="foliador" name="foliador" type="text">
      </div>

      <div class="campo" style="grid-column:1/-1">
        <label for="observaciones">Observaciones</label>
        <textarea id="observaciones" name="observaciones" rows="2"></textarea>
      </div>

      <button type="submit" class="boton-principal" style="grid-column:1/-1">üíæ Guardar registro</button>
    </form>

    <!-- Indicador de estado (estadoSistema.js maneja el visual) -->
    <div id="message" class="mensaje-estado"></div>

    <div class="tabla-wrapper glass card sombra">
      <h2 class="titulo-seccion">Registros guardados</h2>
      <div id="contenedorTabla" class="cargando">Cargando registros...</div>
    </div>
  </main>

  <footer class="footer glass sombra">
    <p>Hospital Regional de Puerto Vallarta ¬∑ SINBA-SIS-65-P ¬∑ <span id="fechaFooter"></span></p>
  </footer>

  <script>
    // URL del Web App (debes publicar el GAS y pegar aqu√≠)
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbwFZfgIcaHfTuz-H-KrVHSPlR-p20xN0ZhwCYnBfmxmv-ZP5eljWES2A-KMt6LXVK07/exec"; // <- reemplaza

    const tablaContenedor = document.getElementById("contenedorTabla");
    const form = document.getElementById("formCenso");

    // Auto set fecha a hoy
    document.getElementById("fecha").valueAsDate = new Date();

    // Validaci√≥n: solo una hora de ingreso y solo una de egreso
    function validarHoras() {
      const ingreso = [
        document.getElementById("hora_ingreso_consulta_externa").value,
        document.getElementById("hora_ingreso_urgencias").value,
        document.getElementById("hora_ingreso_otra_unidad").value
      ].filter(Boolean);

      if (ingreso.length > 1) return { ok:false, mensaje: "Solo una hora de INGRESO debe tener valor." };

      const egreso = [
        document.getElementById("hora_egreso_vivo").value,
        document.getElementById("hora_egreso_muerto").value
      ].filter(Boolean);

      if (egreso.length > 1) return { ok:false, mensaje: "Solo una hora de EGRESO debe tener valor." };

      return { ok:true };
    }

    form.addEventListener("submit", function(e) {
      e.preventDefault();

      const v = validarHoras();
      if (!v.ok) {
        // Mostrar estado de error visual (sin alert)
        setEstado("error");
        return;
      }

      // Construir datos
      const fd = new FormData(form);
      const datos = {};
      fd.forEach((v,k) => datos[k] = v);

      // Forzar unidad (en cliente tambi√©n)
      datos.unidad = "HOSPITAL REGIONAL PUERTO VALLARTA";
      datos.action = "save";

      // JSONP callback name
      const cb = "cb_" + Date.now();
      window[cb] = function(resp) {
        if (resp && resp.exito) {
          setEstado("success");
          form.reset();
          // restaurar fecha a hoy despu√©s del reset
          document.getElementById("fecha").valueAsDate = new Date();
          cargarRegistros();
        } else {
          setEstado("error");
          console.error("Error al guardar:", resp && resp.mensaje);
        }
        // limpiar
        setTimeout(()=>{ try{ delete window[cb]; }catch(e){} },1000);
      };

      // Arme query params (incluye callback)
      const params = new URLSearchParams(datos);
      params.append("callback", cb);

      // Mostrar loading (solo visual)
      setEstado("loading");

      // JSONP insert
      const s = document.createElement("script");
      s.src = `${URL_SCRIPT}?${params.toString()}`;
      s.onerror = function(){ setEstado("error"); };
      document.body.appendChild(s);
    });

    // Cargar registros
    function cargarRegistros() {
      setEstado("loading");
      const cb = "cb_get_" + Date.now();
      window[cb] = function(data) {
        if (!data || !data.length) {
          tablaContenedor.innerHTML = "<p class='cargando tiny'>Sin registros a√∫n.</p>";
          setEstado("success");
          delete window[cb];
          return;
        }

        // HEADER visual (m√°s amigable)
        const headers = [
          "Fecha","Unidad","Servicio","Pase de","Sala","Cama","Expediente","Nombre",
          "Ingreso (consulta)","Ingreso (urgencias)","Ingreso (otra)","Egreso (vivo)","Egreso (muerto)",
          "Servicio destino","Foliador","Observaciones","Registro TS"
        ];

        let html = "<table><thead><tr>" + headers.map(h=>`<th>${h}</th>`).join("") + "</tr></thead><tbody>";
        data.forEach(r => {
          html += "<tr>";
          // r is array in the same order as HEADER in codigo.gs
          html += r.map(cell => `<td>${cell || ""}</td>`).join("");
          html += "</tr>";
        });
        html += "</tbody></table>";

        tablaContenedor.innerHTML = html;
        setEstado("success");
        delete window[cb];
      };

      const script = document.createElement("script");
      script.src = `${URL_SCRIPT}?action=get&callback=${cb}`;
      script.onerror = function(){ setEstado("error"); };
      document.body.appendChild(script);
    }

    // inicio
    cargarRegistros();
    document.getElementById("fechaFooter").textContent =
      new Date().toLocaleDateString("es-MX", { day:"2-digit", month:"long", year:"numeric" });
  </script>
</body>
</html>