<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SINBA-SIS-65-P | Censo Diario</title>
  <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
  <link rel="icon" href="../img/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="../main_css/estilos.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="../main_js/estadoSistema.js"></script>
  <!-- === Estilos base === -->
  <link rel="stylesheet" href="../main_css/estilos.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="../main_js/estadoSistema.js"></script>

  <style>
    /* === LAYOUT PRINCIPAL === */
    .contenedor-central {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      align-items: start;
      width: 100%;
      padding: 1.2rem;
    }
    @media (max-width: 960px) {
      .contenedor-central {
        grid-template-columns: 1fr;
      }
    }

    /* === PANEL FORMULARIO / TABLA === */
    .panel-formulario, .panel-tabla {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 0 10px rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .panel-formulario:hover, .panel-tabla:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(255,255,255,0.1);
    }

    /* === FORMULARIO === */
    .formulario { display: grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap: 1rem; }
    .campo { display:flex; flex-direction:column; }
    label { font-weight:600; margin-bottom:.25rem; }
    input[readonly] { background: rgba(255,255,255,0.03); color: #fff; }

    /* === TABLA === */
    .tabla-wrapper { margin-top:.5rem; overflow-x:auto; }
    table { width:100%; border-collapse:collapse; color:white; }
    th,td { padding:.5rem; border-bottom:1px solid rgba(255,255,255,0.08); }
    th { text-transform:uppercase; background:rgba(255,255,255,0.04); font-weight:700; font-size:.75rem; }
    .tiny { font-size:.85rem; opacity:.85; }

    .mensaje-estado { text-align:center; margin-top: .6rem; min-height:1.6rem; }
  </style>
</head>

<body class="fondo-gradiente">
  <header class="header glass sombra">
    <h1 class="titulo-app">üè• SINBA-SIS-65-P</h1>
    <p class="subtitulo-header">Registro diario de movimiento de pacientes</p>
  </header>

  <!-- === CONTENEDOR PRINCIPAL === -->
  <main class="glass card sombra contenedor-central">
    
    <!-- PANEL IZQUIERDO: FORMULARIO -->
    <div class="panel-formulario">
      <form id="formCenso" class="formulario" autocomplete="off">
        <h2 class="titulo-seccion" style="grid-column:1/-1">Datos del Paciente</h2>

        <div class="campo">
          <label for="unidad">Unidad</label>
          <input id="unidad" name="unidad" readonly value="HOSPITAL REGIONAL PUERTO VALLARTA">
        </div>

        <div class="campo">
          <label for="fecha">Fecha</label>
          <input id="fecha" name="fecha" type="date" required>
        </div>

        <div class="campo">
          <label for="servicio">Servicio</label>
          <select id="servicio" name="servicio" required>
            <option value="">‚Äî Selecciona ‚Äî</option>
            <option>GINECOLOGIA</option>
            <option>MEDICINA INTERNA</option>
            <option>CIRUGIA GENERAL</option>
            <option>TRAUMATOLOGIA Y ORTOPEDIA</option>
            <option>PEDIATRIA</option>
            <option>UCIN</option>
          </select>
        </div>

        <div class="campo">
          <label for="pase_de">Pase de</label>
          <select id="pase_de" name="pase_de">
            <option value="">‚Äî Selecciona ‚Äî</option>
            <option>GINECOLOGIA</option>
            <option>MEDICINA INTERNA</option>
            <option>CIRUGIA GENERAL</option>
            <option>TRAUMATOLOGIA Y ORTOPEDIA</option>
            <option>PEDIATRIA</option>
            <option>UCIN</option>
          </select>
        </div>

        <div class="campo">
          <label for="sala">Sala</label>
          <input id="sala" name="sala" type="text">
        </div>

        <div class="campo">
          <label for="numero_cama">No. cama</label>
          <input id="numero_cama" name="numero_cama" type="text">
        </div>

        <div class="campo">
          <label for="expediente">Expediente</label>
          <input id="expediente" name="expediente" type="text">
        </div>

        <div class="campo" style="grid-column:1/-1">
          <label for="nombre">Nombre completo</label>
          <input id="nombre" name="nombre" type="text" required>
        </div>

        <h3 style="grid-column:1/-1;margin-top:.4rem;">Ingreso</h3>
        <div class="campo">
          <label for="hora_ingreso_consulta_externa">Consulta externa (HH:MM)</label>
          <input id="hora_ingreso_consulta_externa" name="hora_ingreso_consulta_externa" type="time">
        </div>
        <div class="campo">
          <label for="hora_ingreso_urgencias">Urgencias (HH:MM)</label>
          <input id="hora_ingreso_urgencias" name="hora_ingreso_urgencias" type="time">
        </div>
        <div class="campo">
          <label for="hora_ingreso_otra_unidad">Otra unidad (HH:MM)</label>
          <input id="hora_ingreso_otra_unidad" name="hora_ingreso_otra_unidad" type="time">
        </div>

        <h3 style="grid-column:1/-1;margin-top:.4rem;">Egreso</h3>
        <div class="campo">
          <label for="hora_egreso_vivo">Vivo (HH:MM)</label>
          <input id="hora_egreso_vivo" name="hora_egreso_vivo" type="time">
        </div>
        <div class="campo">
          <label for="hora_egreso_muerto">Muerto (HH:MM)</label>
          <input id="hora_egreso_muerto" name="hora_egreso_muerto" type="time">
        </div>

        <div class="campo">
          <label for="servicio_destino">Servicio destino</label>
          <select id="servicio_destino" name="servicio_destino">
            <option value="">‚Äî Selecciona ‚Äî</option>
            <option>GINECOLOGIA</option>
            <option>MEDICINA INTERNA</option>
            <option>CIRUGIA GENERAL</option>
            <option>TRAUMATOLOGIA Y ORTOPEDIA</option>
            <option>PEDIATRIA</option>
            <option>UCIN</option>
          </select>
        </div>

        <div class="campo">
          <label for="foliador">Foliador</label>
          <input id="foliador" name="foliador" type="text">
        </div>

        <div class="campo" style="grid-column:1/-1">
          <label for="observaciones">Observaciones</label>
          <textarea id="observaciones" name="observaciones" rows="2"></textarea>
        </div>

        <button type="submit" class="boton-principal" style="grid-column:1/-1">üíæ Guardar registro</button>
      </form>

      <div id="message" class="mensaje-estado"></div>
    </div>

    <!-- PANEL DERECHO: TABLA -->
    <div class="panel-tabla">
      <h2 class="titulo-seccion">Registros guardados</h2>
      <div id="contenedorTabla" class="tabla-wrapper cargando">Cargando registros...</div>
    </div>

  </main>

  <footer class="footer glass sombra">
    <p>Hospital Regional de Puerto Vallarta ¬∑ SINBA-SIS-65-P ¬∑ <span id="fechaFooter"></span></p>
  </footer>

  <script>
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbwFZfgIcaHfTuz-H-KrVHSPlR-p20xN0ZhwCYnBfmxmv-ZP5eljWES2A-KMt6LXVK07/exec"; // Reemplaza por tu WebApp URL
    const form = document.getElementById("formCenso");
    const tablaContenedor = document.getElementById("contenedorTabla");

    document.getElementById("fecha").valueAsDate = new Date();
    document.getElementById("fechaFooter").textContent = new Date().toLocaleDateString("es-MX", { day:"2-digit", month:"long", year:"numeric" });

    function validarHoras() {
      const ingreso = [
        form.hora_ingreso_consulta_externa.value,
        form.hora_ingreso_urgencias.value,
        form.hora_ingreso_otra_unidad.value
      ].filter(Boolean);
      if (ingreso.length > 1) return {ok:false};

      const egreso = [
        form.hora_egreso_vivo.value,
        form.hora_egreso_muerto.value
      ].filter(Boolean);
      if (egreso.length > 1) return {ok:false};

      return {ok:true};
    }

    form.addEventListener("submit", e => {
      e.preventDefault();
      const v = validarHoras();
      if (!v.ok) { setEstado("error"); return; }

      const fd = new FormData(form);
      const datos = {};
      fd.forEach((v,k)=>datos[k]=v);
      datos.unidad = "HOSPITAL REGIONAL PUERTO VALLARTA";
      datos.action = "save";

      const cb = "cb_" + Date.now();
      window[cb] = function(resp){
        if(resp && resp.exito){
          setEstado("success");
          form.reset();
          document.getElementById("fecha").valueAsDate = new Date();
          cargarRegistros();
        } else setEstado("error");
        setTimeout(()=>delete window[cb],500);
      };

      const params = new URLSearchParams(datos);
      params.append("callback", cb);
      setEstado("loading");
      const s = document.createElement("script");
      s.src = `${URL_SCRIPT}?${params.toString()}`;
      s.onerror=()=>setEstado("error");
      document.body.appendChild(s);
    });

    function cargarRegistros(){
      setEstado("loading");
      const cb = "cb_get_" + Date.now();
      window[cb] = function(data){
        if(!data || !data.length){
          tablaContenedor.innerHTML = "<p class='tiny'>Sin registros a√∫n.</p>";
          setEstado("success");
          delete window[cb];
          return;
        }
        const headers = ["Fecha","Unidad","Servicio","Pase de","Sala","Cama","Expediente","Nombre","Ingreso (consulta)","Ingreso (urgencias)","Ingreso (otra)","Egreso (vivo)","Egreso (muerto)","Servicio destino","Foliador","Observaciones","Registro TS"];
        let html = "<table><thead><tr>"+headers.map(h=>`<th>${h}</th>`).join("")+"</tr></thead><tbody>";
        data.forEach(r=>{
          html+="<tr>"+r.map(c=>`<td>${c||""}</td>`).join("")+"</tr>";
        });
        html+="</tbody></table>";
        tablaContenedor.innerHTML = html;
        setEstado("success");
        delete window[cb];
      };
      const s=document.createElement("script");
      s.src=`${URL_SCRIPT}?action=get&callback=${cb}`;
      s.onerror=()=>setEstado("error");
      document.body.appendChild(s);
    }

    cargarRegistros();
  </script>
</body>
</html>