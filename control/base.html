<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estad√≠sticas y Archivo Cl√≠nico</title>
  <link rel="shortcut icon" href="/estadisticas/img/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/estadisticas/img/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="/estadisticas/main_css/estilos.css" rel="stylesheet">
</head>

<body>
  <div class="glass" id="dashboard">
    <h5>Base</h5>
    <div id="header"></div>
    <div class="grid">
<!-- AQUI
      VA
      EL
  CONTENIDO -->
    </div>
    <div id="footer"></div>
  </div>
  <script>
    const INFORMES = [
      "SINBA BD EGRESOS", "SINBA BD URGENCIAS", "SINBA BD LESIONES", "SINBA BD NACIMIENTOS",
      "SINBA BD DEFUNCIONES", "SINBA GERENCIAL", "RESUMEN DEFUNCIONES",
      "CONCENTRADO GENERAL DEL CENSO", "CORTA ESTANCIA", "PRINCIPALES CAUSAS DE EGRESO",
      "EXPEDIENTES CLINICOS NUEVOS", "LABORATORIO", "TAMIZ NEONATAL", "CAPACITACIONES DE ENFERMERIA",
      "VACUNAS", "CARTILLAS DE SALUD", "REHABILITACION", "EPIDEMIOLOGIA", "TRABAJO SOCIAL",
      "SERVICIO DE AMBULANCIAS"
    ];

    const LLAVE = "informes_matriz_v2";

    function obtenerDatos() {
      return JSON.parse(localStorage.getItem(LLAVE)) || { meses: {} };
    }

    function guardarDatos(obj) {
      localStorage.setItem(LLAVE, JSON.stringify(obj));
    }

    function generarMesesA√±oActual() {
      const y = new Date().getFullYear();
      const m = [];
      for (let i = 1; i <= 12; i++) {
        m.push(`${y}-${String(i).padStart(2, "0")}`);
      }
      return m;
    }

    function generarMatrizAuto() {
      const meses = generarMesesA√±oActual();
      const matriz = document.getElementById("matriz");
      matriz.innerHTML = "";

      matriz.style.gridTemplateColumns = `auto repeat(${meses.length}, auto)`;

      const datos = obtenerDatos();

      // TITULOS
      matriz.appendChild(crearCeldaTitulo("Informes"));
      meses.forEach(m => matriz.appendChild(crearCeldaTitulo(m)));

      // FILAS
      INFORMES.forEach(informe => {
        matriz.appendChild(crearCeldaFija(informe));

        meses.forEach(mes => {
          if (!datos.meses[mes]) datos.meses[mes] = {};
          if (!datos.meses[mes][informe]) {
            datos.meses[mes][informe] = { ruta: "", completo: false };
          }

          matriz.appendChild(crearCeldaEditable(mes, informe, datos));
        });
      });

      guardarDatos(datos);
    }

    function crearCeldaTitulo(texto) {
      const d = document.createElement("div");
      d.className = "celda col-titulo";
      d.textContent = texto;
      return d;
    }

    function crearCeldaFija(texto) {
      const d = document.createElement("div");
      d.className = "celda celda-fija";
      d.textContent = texto;
      return d;
    }

    function crearCeldaEditable(mes, informe, datos) {
      const d = document.createElement("div");
      d.className = "celda";

      const reg = datos.meses[mes][informe];

      const box = document.createElement("div");
      box.className = "card-informe";
      if (reg.ruta) box.classList.add("activo");

      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.checked = reg.completo;

      const inp = document.createElement("input");
      inp.type = "text";
      inp.value = reg.ruta;
      inp.placeholder = "Evidencia";
      inp.className = "input-evidencia";

      // Color persistente al cargar
      if (reg.ruta) d.classList.add("celda-llena");


      // --- √öNICO LISTENER PARA inp ---
      inp.addEventListener("input", () => {
        reg.ruta = inp.value.trim();
        reg.completo = reg.ruta !== "";
        chk.checked = reg.completo;
        box.classList.toggle("activo", reg.completo);

        d.classList.toggle("celda-llena", reg.completo);

        guardarDatos(datos);
      });


      // --- CLICK EN CELDA COMPLETA ---
      d.addEventListener("click", (e) => {
        if (e.target.tagName === "INPUT") return;

        if (reg.ruta && reg.ruta.trim() !== "") {
          let url = reg.ruta.trim();
          if (!/^https?:\/\//i.test(url)) url = "https://" + url;
          window.open(url, "_self");
        }
      });

      chk.addEventListener("change", () => {
        reg.completo = chk.checked;
        if (!reg.completo) reg.ruta = "";

        inp.value = reg.ruta;
        box.classList.toggle("activo", reg.completo);
        d.classList.toggle("celda-llena", reg.completo);

        guardarDatos(datos);
      });

      // Ensamble
      box.appendChild(chk);
      box.appendChild(inp);
      d.appendChild(box);
      return d;
    }

    // GENERACI√ìN AUTOM√ÅTICA AL ABRIR LA P√ÅGINA
    window.addEventListener("load", generarMatrizAuto);
  </script>
  <script>
    fetch('/estadisticas/comun/header.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('header').innerHTML = html;

        // Cargar sesi√≥n.js despu√©s de insertar el HTML
        const s = document.createElement('script');
        s.src = '/estadisticas/comun/sesion_bk.js';

        s.onload = () => {
          console.log("üî• sesion_bk.js cargado. Verificando sesi√≥n...");
          verificarAutenticacion();
        };

        document.body.appendChild(s);
      });

    fetch('/estadisticas/comun/footer.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('footer').innerHTML = html;

        // Ya existe footerText
        const footer = document.getElementById('footerText');
        if (footer) {
          footer.innerHTML = `Hecho con ‚ù§Ô∏è por Ricardo ¬∑ ${new Date().getFullYear()}`;
        }
      });
  </script>
  <script src="/estadisticas/comun/estadoSistema.js"></script>
  <script src="/estadisticas/comun/sesion_bk.js"></script>
</body>

</html>