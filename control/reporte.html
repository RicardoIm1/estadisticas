<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EstadÃ­sticas y Archivo ClÃ­nico</title>
    <link rel="shortcut icon" href="/estadisticas/img/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/estadisticas/img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="/estadisticas/main_css/estilos.css" rel="stylesheet">
    <link href="/estadisticas/main_css/login.css" rel="stylesheet">

</head>

<body>
    <div class="glass" id="dashboard">
        <h5>Reporte de Actividades</h5>
        <div id="header"></div>
            <div class="glass" id="dashboard">
                <div id="message" style="text-align:center; margin-top:1rem;"></div>
                <form id="reporteForm">
                    <!-- Persona -->
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fa-solid fa-user-tie"></i> Responsable
                        </label>
                        <select class="form-select" id="persona" required>
                            <option value="">Selecciona tu nombre</option>
                            <option value="Fernanda">ğŸ‘©â€ğŸ’¼ Fernanda</option>
                            <option value="Lolita">ğŸ‘©â€ğŸ’» Lolita</option>
                            <option value="Elda">ğŸ‘¨â€ğŸ’» Elda</option>
                            <option value="Isela">ğŸ‘©â€ğŸ“ Isela</option>
                            <option value="Lucero">ğŸ‘©â€ğŸ“ Lucero</option>
                            <option value="Kenya">ğŸ‘©â€ğŸ“ Kenya</option>
                            <option value="Cintia">ğŸ‘©â€ğŸ“ Cintia</option>
                            <option value="Yolanda">ğŸ‘©â€ğŸ“ Yolanda</option>
                            <option value="Ruth">ğŸ‘©â€ğŸ“ Ruth</option>
                            <option value="Freddy">ğŸ‘¨â€ğŸ’¼ Freddy</option>
                            <option value="Aldo">ğŸ‘¨â€ğŸ’¼ Aldo</option>
                            <option value="Omar">ğŸ‘¨â€ğŸ’¼ Omar</option>
                        </select>
                    </div>

                    <!-- Tarea -->
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fa-solid fa-list-check"></i> Tarea Realizada
                        </label>
                        <select class="form-select" id="tarea" required>
                            <option value="">Selecciona la actividad</option>
                            <option value="ValidaciÃ³n CIE-10">ğŸ” ValidaciÃ³n CIE-10</option>
                            <option value="Captura en SINBA">ğŸ’» Captura en SINBA</option>
                            <option value="Concentrado de servicios">ğŸ“Š Concentrado de servicios</option>
                            <option value="Informe mensual">ğŸ“ˆ Informe mensual</option>
                            <option value="EnvÃ­o digital y respaldo">ğŸ“¤ EnvÃ­o digital y respaldo</option>
                            <option value="SupervisiÃ³n y retroalimentaciÃ³n">ğŸ‘ï¸ SupervisiÃ³n y retroalimentaciÃ³n</option>
                            <option value="IntegraciÃ³n de observaciones jurisdiccionales">ğŸ”— IntegraciÃ³n de
                                observaciones
                                jurisdiccionales</option>
                            <option value="Valer VERSACE..">âš¡ Valer VERSACE..</option>
                        </select>
                    </div>

                    <!-- Documentos Trabajados -->
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fa-solid fa-file-circle-check"></i> Documentos Procesados
                        </label>
                        <input type="number" class="form-input" id="documentos" placeholder="Ej: 25, 150, 340..."
                            min="0" max="10000" required>
                    </div>

                    <!-- Observaciones -->
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fa-solid fa-comment-dots"></i> Observaciones
                        </label>
                        <textarea class="form-input form-textarea" id="observaciones"
                            placeholder="Detalles relevantes del avance (opcional)..."></textarea>
                    </div>

                    <button type="submit" class="submit-btn" id="submitBtn">
                        <i class="fa-solid fa-paper-plane"></i> Registrar Avance
                    </button>

                    <div id="successMessage" class="success-message">
                        <i class="fa-solid fa-check-circle"></i>
                        <div style="font-weight: 600; margin-bottom: 5px;">Â¡Reporte Guardado!</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">El registro se ha actualizado en el sistema</div>
                    </div>
                </form>
                <a href="https://ricardoim1.github.io/estadisticas/" class="back-link">
                    <i class="fa-solid fa-arrow-left"></i> Inicio
                </a>
            </div>
        </div>
        <script>
            // URL de tu GAS - REEMPLAZA CON TU URL REAL
            const GAS_URL = "https://script.google.com/macros/s/AKfycbw5lrSCqUScFDhgcGvSgkiWdTte_as7rcwqVcAp8MCfjPvOrvBIDO-gUSfbJEOCVjET/exec";

            document.getElementById('reporteForm').addEventListener('submit', function (e) {
                e.preventDefault();

                const submitBtn = document.getElementById('submitBtn');
                const originalHTML = submitBtn.innerHTML;

                // Deshabilitar y mostrar loading
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin pulse"></i> Guardando en sistema...';

                const formData = {
                    fecha: new Date().toISOString().split('T')[0], // YYYY-MM-DD
                    persona: document.getElementById('persona').value,
                    tarea: document.getElementById('tarea').value,
                    documentos: document.getElementById('documentos').value,
                    observaciones: document.getElementById('observaciones').value
                };

                console.log('ğŸš€ Enviando datos premium:', formData);

                // Usar JSONP para evitar CORS
                const callbackName = 'formCallback_' + Date.now();

                window[callbackName] = function (response) {
                    console.log('ğŸ“¥ Respuesta del servidor:', response);

                    // Limpiar
                    delete window[callbackName];
                    const script = document.querySelector(`script[src*="${callbackName}"]`);
                    if (script) script.remove();

                    // Restaurar botÃ³n
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHTML;

                    if (response && response.success) {
                        // Ã‰XITO - Mostrar confirmaciÃ³n
                        document.getElementById('successMessage').style.display = 'block';
                        document.getElementById('reporteForm').reset();

                        setTimeout(() => {
                            document.getElementById('successMessage').style.display = 'none';
                        }, 4000);

                    } else {
                        // ERROR
                        alert('âŒ Error: ' + (response.error || 'No se pudo guardar el reporte'));
                    }
                };

                // Crear script JSONP
                const script = document.createElement('script');
                const params = new URLSearchParams({
                    ...formData,
                    callback: callbackName
                });

                script.src = `${GAS_URL}?${params.toString()}`;
                console.log('ğŸ”— URL llamada:', script.src);

                script.onerror = function () {
                    console.error('âŒ Error de conexiÃ³n');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHTML;
                    alert('ğŸš¨ Error de conexiÃ³n. Verifica tu internet.');
                    delete window[callbackName];
                };

                document.head.appendChild(script);

                // Timeout de seguridad
                setTimeout(() => {
                    if (window[callbackName]) {
                        console.warn('â° Timeout del formulario');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalHTML;
                        alert('â° El servidor no respondiÃ³. Intenta nuevamente.');
                        delete window[callbackName];
                    }
                }, 10000);
            });

            // Efectos de focus mejorados
            document.querySelectorAll('.form-select, .form-input, .form-textarea').forEach(input => {
                input.addEventListener('focus', function () {
                    this.parentElement.style.transform = 'translateY(-2px)';
                });

                input.addEventListener('blur', function () {
                    this.parentElement.style.transform = 'translateY(0)';
                });
            });

            // Auto-focus en el primer campo
            document.getElementById('persona').focus();
        </script>
        <script>
            fetch('/estadisticas/comun/header.html')
                .then(r => r.text())
                .then(html => {
                    document.getElementById('header').innerHTML = html;

                    // Cargar sesiÃ³n.js despuÃ©s de insertar el HTML
                    const s = document.createElement('script');
                    s.src = '/estadisticas/comun/sesion_bk.js';

                    s.onload = () => {
                        console.log("ğŸ”¥ sesion_bk.js cargado. Verificando sesiÃ³n...");
                        verificarAutenticacion();
                    };

                    document.body.appendChild(s);
                });

            fetch('/estadisticas/comun/footer.html')
                .then(r => r.text())
                .then(html => {
                    document.getElementById('footer').innerHTML = html;

                    // Ya existe footerText
                    const footer = document.getElementById('footerText');
                    if (footer) {
                        footer.innerHTML = `Hecho con â¤ï¸ por Ricardo Â· ${new Date().getFullYear()}`;
                    }
                });
        </script>
        <script src="/estadisticas/comun/estadoSistema.js"></script>
        <script src="/estadisticas/comun/sesion_bk.js"></script>

</body>

</html>