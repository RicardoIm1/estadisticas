<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Defunciones Generales</title>
  <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
  <link rel="icon" href="../img/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="/estadisticas/main_css/estilos.css" rel="stylesheet">
  <link href="/estadisticas/main_css/estilos_original.css" rel="stylesheet">
  <link href="/estadisticas/defunciones/estilos.css" rel="stylesheet">
  <link href="/estadisticas/main_css/tabla-wrapper.css" rel="stylesheet">
</head>

<body>
  <div class="glass" id="dashboard">
    <h5>Defunciones Generales</h5>
    <div class="header">
      <div class="logo">
        <a href="/estadisticas/"> <img src="/estadisticas/img/logo-hrpv.png" alt="Logo" width="120"></a>
      </div>
      <div>
        <div class="usuario">
          <i class="fas fa-user-circle"></i>
          <span id="user-info"></span>
          <!-- Bot√≥n de cerrar sesi√≥n -->
          <button onclick="cerrarSesion()" class="btn-salir-ultra">
            Salir
          </button>
        </div>
      </div>
    </div>
    <!--     <div id="estadoTexto">Sistema listo</div> -->
    <div class="contenedor-flex">
<!--       <form id="crud-form" class="formulario">
        <input type="hidden" id="id">

        <div class="bloque">
          <label for="folio"><i class="fas fa-file-alt"></i> Folio</label>
          <input id="folio" placeholder="Ingrese el folio">
        </div>

        <div class="bloque">
          <label for="nombre"><i class="fas fa-user"></i> Nombre *</label>
          <input id="nombre" required placeholder="Nombre completo">
        </div>

        <div class="bloque">
          <label for="fechaDefuncion"><i class="fas fa-calendar-alt"></i> Fecha de Defunci√≥n</label>
          <input id="fechaDefuncion" type="date">
        </div>

        <div class="bloque-horizontal">
          <div class="bloque">
            <label for="area"><i class="fas fa-map-marker-alt"></i> √Årea</label>
            <input id="area" placeholder="√Årea">
          </div>
          <div class="bloque">
            <label for="edad"><i class="fas fa-birthday-cake"></i> Edad</label>
            <input id="edad" type="number" placeholder="Edad">
          </div>
          <div class="bloque">
            <label for="sexo"><i class="fas fa-venus-mars"></i> Sexo</label>
            <select id="sexo">
              <option value="">Seleccione</option>
              <option value="Masculino">Masculino</option>
              <option value="Femenino">Femenino</option>
              <option value="Intersexual">Intersexual</option>
            </select>
          </div>
        </div>

        <div class="bloque">
          <label for="diagnostico"><i class="fas fa-stethoscope"></i> Diagn√≥stico</label>
          <textarea id="diagnostico" placeholder="Diagn√≥stico principal" rows="3"></textarea>
        </div>

        <div class="bloque">
          <label for="observaciones"><i class="fas fa-clipboard-list"></i> Observaciones</label>
          <textarea id="observaciones" placeholder="Observaciones adicionales" rows="3"></textarea>
        </div>

        <div class="bloque-horizontal">
          <div class="bloque">
            <label for="expediente"><i class="fas fa-folder"></i> Expediente</label>
            <input id="expediente" placeholder="N¬∞ de expediente">
          </div>
          <div class="bloque">
            <label for="medico"><i class="fas fa-user-md"></i> M√©dico</label>
            <input id="medico" placeholder="M√©dico tratante">
          </div>
        </div>

        <div class="botones">
          <button type="submit" id="btn-guardar"><i class="fas fa-save"></i> Guardar</button>
          <button type="button" id="btn-limpiar"><i class="fas fa-broom"></i> Limpiar</button>
          <button type="button" id="btn-cancelar" style="display:none;"><i class="fas fa-times"></i> Cancelar</button>
        </div>
      </form> -->

      <div class="tabla-wrapper">
        <div class="buscador-wrapper">
          <input type="text" id="buscador" placeholder="üîç Buscar por cualquier campo..." class="input-busqueda">
        </div>
        <table>
          <thead>
            <tr>
              <th class="columna-pequena">N¬∞</th>
              <th class="columna-mediana">Folio</th>
              <th class="columna-grande">Nombre</th>
              <th class="columna-mediana">Fecha</th>
              <th class="columna-mediana">√Årea</th>
              <th class="columna-grande">Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-registros">
            <!-- Estado de carga -->
            <tr>
              <td colspan="6" style="text-align:center; padding: 2rem;">Cargando registros...</td>
            </tr>
          </tbody>
        </table>
        <footer>
          <p id="footerText">Hecho con ‚ù§Ô∏è por Ricardo ¬∑ 2023</p>
        </footer>
      </div>

      <!-- Modal para confirmar eliminaci√≥n -->
      <div class="modal-backdrop" id="modalEliminar">
        <div class="modal">
          <h3><i class="fas fa-exclamation-triangle"></i> ¬øConfirmar eliminaci√≥n?</h3>
          <p>Esta acci√≥n no se puede deshacer. ¬øEst√° seguro de que desea eliminar este registro?</p>
          <div class="modal-buttons">
            <button class="btn-confirm" id="btnConfirmarEliminar"><i class="fas fa-trash"></i> Eliminar</button>
            <button class="btn-cancel" id="btnCancelarEliminar"><i class="fas fa-times"></i> Cancelar</button>
          </div>
        </div>
      </div>
    </div>
  </div> <!-- end .glass -->

    <script>
      // Footer din√°mico
      document.getElementById('footerText').innerHTML =
        `Hecho con ‚ù§Ô∏è por Ricardo ¬∑ ${new Date().getFullYear()}`;

      // ========== FUNCI√ìN PARA FORMATEAR FECHAS ==========
      function formatearFecha(fechaString) {
        if (!fechaString) return '-';

        try {
          // Si ya es una fecha v√°lida en formato simple
          if (/^\d{4}-\d{2}-\d{2}$/.test(fechaString)) {
            const fecha = new Date(fechaString + 'T00:00:00');
            return fecha.toLocaleDateString('es-ES', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            });
          }

          // Si viene con hora (formato completo)
          const fecha = new Date(fechaString);

          // Verificar si es una fecha v√°lida
          if (isNaN(fecha.getTime())) {
            return '-';
          }

          // Formatear a DD/MM/YYYY
          return fecha.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          });
        } catch (error) {
          console.error('Error formateando fecha:', fechaString, error);
          return '-';
        }
      }

      // ========== estadoSistema.js ==========
      let intensidadUso = 0;
      let respiracionInterval;

      function iniciarRespiracion() {
        const dashboard = document.querySelector('.glass');
        if (!dashboard) return;

        clearInterval(respiracionInterval);
        let fase = 0;
        respiracionInterval = setInterval(() => {
          fase += 0.04 + Math.random() * 0.02;
          const intensidad = Math.min(0.2 + intensidadUso / 50, 0.7);
          const escala = 1 + Math.sin(fase) * intensidad * 0.05;
          dashboard.style.transform = `scale(${escala})`;
        }, 100);
      }

      function setEstado(estado, mensaje = null) {
        const dashboard = document.querySelector('.glass');
        const estadoTexto = document.querySelector('#estadoTexto');

        if (!dashboard) {
          console.warn('‚ö†Ô∏è No se encontr√≥ el contenedor .glass');
          return;
        }

        intensidadUso = Math.min(intensidadUso + 1, 20);

        /* iniciarRespiracion(); */
        setTimeout(() => (intensidadUso = Math.max(intensidadUso - 1, 0)), 10000);

        dashboard.style.transition = 'background 0.5s ease, box-shadow 0.8s ease, border 0.5s ease';
        dashboard.classList.remove('loading', 'success', 'error');

        switch (estado) {
          case 'loading':
            dashboard.classList.add('loading');
            break;
          case 'success':
            dashboard.classList.add('success');
            break;
          case 'error':
            dashboard.classList.add('error');
            break;
        }

        if (estadoTexto) {
          const iconos = {
            loading: '<i class="fas fa-sync fa-spin"></i> Procesando...',
            success: '<i class="fas fa-check-circle"></i> √âxito ‚úÖ',
            error: '<i class="fas fa-exclamation-circle"></i> Error ‚ùå'
          };
          estadoTexto.innerHTML = mensaje || iconos[estado] || 'Listo';
          estadoTexto.style.opacity = '1';
        }

        // üîÑ Restaurar a cristalino en 5 s
        setTimeout(() => {
          dashboard.style.transition = 'background 5s ease, box-shadow 5s ease, border 5s ease';
          dashboard.classList.remove('loading', 'success', 'error');
        }, 5000);
      }

      // ========== app.js ==========
      const GAS_URL = "https://script.google.com/macros/s/AKfycbzTd3NQZuEKXIrIjI9qTRBolbeB9RlJ0d0RETuPunYQqE2Xz4860uiwAqGKiXXg3mfK/exec";

      // Variables globales
      let idParaEliminar = null;

      // Funci√≥n para cargar datos
      async function cargarRegistros() {
        try {
          console.log('üîÑ Cargando registros...');
          setEstado('loading', 'üîÑ Cargando registros...');

          const response = await fetch(GAS_URL);
          const text = await response.text();
          const data = JSON.parse(text);

          if (data.success) {
            mostrarTabla(data.rows);
            setEstado('success', `‚úÖ ${data.rows.length} registros cargados`);
          } else {
            throw new Error(data.error || 'Error del servidor');
          }
        } catch (error) {
          console.error('‚ùå Error:', error);
          setEstado('error', '‚ùå Error: ' + error.message);
          document.getElementById('tabla-registros').innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 2rem; color: #ff6b6b;">Error cargando datos</td></tr>';
        }
      }

      // Guardar registro - M√âTODO QUE FUNCIONA (con formulario)
      async function guardar(e) {
        e.preventDefault();

        const id = document.getElementById('id').value;
        const datos = {
          folio: document.getElementById('folio').value,
          nombre: document.getElementById('nombre').value,
          fechaDefuncion: document.getElementById('fechaDefuncion').value,
          area: document.getElementById('area').value,
          edad: document.getElementById('edad').value,
          sexo: document.getElementById('sexo').value,
          diagnostico: document.getElementById('diagnostico').value,
          expediente: document.getElementById('expediente').value,
          medico: document.getElementById('medico').value,
          observaciones: document.getElementById('observaciones').value
        };

        if (!datos.nombre) {
          setEstado('error', '‚ùå El nombre es obligatorio');
          return;
        }

        console.log('üíæ Enviando datos:', datos);
        setEstado('loading', 'üíæ Guardando registro...');

        try {
          // Crear formulario que se abre en nueva pesta√±a (m√©todo que funciona)
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = GAS_URL;
          form.target = '_blank';
          form.style.display = 'none';

          // Agregar campos individuales
          const campos = {
            action: id ? 'updateData' : 'createData',
            ...datos
          };

          if (id) campos.id = id;

          Object.keys(campos).forEach(key => {
            const input = document.createElement('input');
            input.name = key;
            input.value = campos[key] || '';
            form.appendChild(input);
          });

          document.body.appendChild(form);
          form.submit();
          document.body.removeChild(form);

          setEstado('success', '‚úÖ Enviando datos... Revisa la nueva pesta√±a');
          limpiarForm();

          // Recargar despu√©s de 3 segundos
          setTimeout(() => {
            cargarRegistros();
          }, 3000);

        } catch (error) {
          console.error('‚ùå Error:', error);
          setEstado('error', '‚ùå Error: ' + error.message);
        }
      }

      // Eliminar registro - CON MODAL ELEGANTE
      function solicitarEliminar(id) {
        idParaEliminar = id;
        const modal = document.getElementById('modalEliminar');
        const modalContent = modal.querySelector('.modal');

        modal.style.display = 'flex';
        setTimeout(() => {
          modalContent.classList.add('show');
        }, 10);
      }

      async function eliminarConfirmado() {
        if (!idParaEliminar) return;

        try {
          setEstado('loading', 'üóëÔ∏è Eliminando registro...');

          // Crear formulario para eliminar
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = GAS_URL;
          form.target = '_blank';
          form.style.display = 'none';

          const inputAction = document.createElement('input');
          inputAction.name = 'action';
          inputAction.value = 'deleteData';
          form.appendChild(inputAction);

          const inputId = document.createElement('input');
          inputId.name = 'id';
          inputId.value = idParaEliminar;
          form.appendChild(inputId);

          document.body.appendChild(form);
          form.submit();
          document.body.removeChild(form);

          setEstado('success', '‚úÖ Eliminando registro...');
          cerrarModal();

          setTimeout(() => {
            cargarRegistros();
          }, 2000);

        } catch (error) {
          console.error('‚ùå Error eliminando:', error);
          setEstado('error', '‚ùå Error eliminando: ' + error.message);
          cerrarModal();
        }
      }

      function cerrarModal() {
        const modal = document.getElementById('modalEliminar');
        const modalContent = modal.querySelector('.modal');

        modalContent.classList.remove('show');
        setTimeout(() => {
          modal.style.display = 'none';
          idParaEliminar = null;
        }, 300);
      }

      // Mostrar tabla
      function mostrarTabla(registros) {
        const tbody = document.getElementById('tabla-registros');
        tbody.innerHTML = '';

        if (!registros || registros.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 2rem;">No hay registros</td></tr>';
          return;
        }

        // Ordenar registros por fecha m√°s reciente primero
        const registrosOrdenados = [...registros].sort((a, b) => {
          return new Date(b.fechaDefuncion) - new Date(a.fechaDefuncion);
        });

        registrosOrdenados.forEach((registro, index) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${registro.folio || '-'}</td>
          <td>${registro.nombre || ''}</td>
          <td>${formatearFecha(registro.fechaDefuncion)}</td>
          <td>${registro.area || ''}</td>
          <td>
            <div class="acciones-tabla">
              <button class="btn-editar" onclick="editar('${registro.id}')" title="Editar registro">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-eliminar" onclick="solicitarEliminar('${registro.id}')" title="Eliminar registro">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        `;
          tbody.appendChild(tr);
        });
      }

      // Editar registro
      async function editar(id) {
        try {
          setEstado('loading', 'üìù Cargando datos para editar...');

          const response = await fetch(GAS_URL);
          const data = await response.json();

          if (data.success) {
            const registro = data.rows.find(r => r.id === id);
            if (registro) {
              document.getElementById('id').value = registro.id;
              document.getElementById('folio').value = registro.folio || '';
              document.getElementById('nombre').value = registro.nombre || '';

              // Formatear la fecha para el input date (necesita formato YYYY-MM-DD)
              if (registro.fechaDefuncion) {
                const fecha = new Date(registro.fechaDefuncion);
                if (!isNaN(fecha.getTime())) {
                  document.getElementById('fechaDefuncion').value = fecha.toISOString().split('T')[0];
                } else {
                  document.getElementById('fechaDefuncion').value = '';
                }
              } else {
                document.getElementById('fechaDefuncion').value = '';
              }

              document.getElementById('area').value = registro.area || '';
              document.getElementById('edad').value = registro.edad || '';
              document.getElementById('sexo').value = registro.sexo || '';
              document.getElementById('diagnostico').value = registro.diagnostico || '';
              document.getElementById('expediente').value = registro.expediente || '';
              document.getElementById('medico').value = registro.medico || '';
              document.getElementById('observaciones').value = registro.observaciones || '';

              // Cambiar texto del bot√≥n
              document.getElementById('btn-guardar').innerHTML = '<i class="fas fa-sync-alt"></i> Actualizar';
              document.getElementById('btn-cancelar').style.display = 'block';

              setEstado('success', '‚úèÔ∏è Modo edici√≥n activado');
              document.querySelector('.formulario').scrollIntoView({ behavior: 'smooth' });
            }
          }
        } catch (error) {
          setEstado('error', '‚ùå Error cargando registro para editar');
        }
      }

      // Cancelar edici√≥n
      function cancelarEdicion() {
        limpiarForm();
        setEstado('success', '‚ùå Edici√≥n cancelada');
      }

      // Limpiar formulario
      function limpiarForm() {
        document.getElementById('crud-form').reset();
        document.getElementById('id').value = '';
        document.getElementById('btn-guardar').innerHTML = '<i class="fas fa-save"></i> Guardar';
        document.getElementById('btn-cancelar').style.display = 'none';
        setEstado('success', 'üßπ Formulario limpiado');
      }

      // Inicializaci√≥n
      document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ Iniciando aplicaci√≥n...');

        document.getElementById('crud-form').addEventListener('submit', guardar);
        document.getElementById('btn-limpiar').addEventListener('click', limpiarForm);
        document.getElementById('btn-cancelar').addEventListener('click', cancelarEdicion);
        document.getElementById('btnConfirmarEliminar').addEventListener('click', eliminarConfirmado);
        document.getElementById('btnCancelarEliminar').addEventListener('click', cerrarModal);

        // Cerrar modal al hacer clic fuera
        document.getElementById('modalEliminar').addEventListener('click', function (e) {
          if (e.target === this) {
            cerrarModal();
          }
        });

        // Cargar datos
        cargarRegistros();
      });

      // Funciones globales para los botones
      window.editar = editar;
      window.solicitarEliminar = solicitarEliminar;
    </script>

    <script>
      // Verificar si el usuario est√° logueado
      function verificarAutenticacion() {
        const usuario = localStorage.getItem('usuario');
        const rol = localStorage.getItem('rol');

        if (!usuario) {
          window.location.href = '/estadisticas/login.html';
          return;
        }

        // Mostrar informaci√≥n del usuario
        console.log('Usuario:', usuario, 'Rol:', rol);

        // Mostrar en la interfaz
        const userElement = document.getElementById('user-info');
        if (userElement) {
          userElement.innerHTML = `${usuario} (${rol})`;
        }
      }

      // Cerrar sesi√≥n
      function cerrarSesion() {
        localStorage.removeItem('usuario');
        localStorage.removeItem('rol');
        localStorage.removeItem('loginTime');
        window.location.href = 'index.html';
      }

      // Verificar al cargar la p√°gina
      window.addEventListener('load', verificarAutenticacion);
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const buscador = document.getElementById("buscador");
        const filas = document.getElementById("tabla-registros");

        if (!buscador || !filas) return;

        buscador.addEventListener("keyup", function () {
          const valor = this.value.toLowerCase().trim();
          const registros = filas.querySelectorAll("tr");

          registros.forEach(fila => {
            const textoFila = fila.textContent.toLowerCase();
            fila.style.display = textoFila.includes(valor) ? "" : "none";
          });
        });
      });
    </script>

</body>

</html>