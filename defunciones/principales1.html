<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Epidemiológico | GitHub Pages</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --gray: #7f8c8d;
            --success: #27ae60;
            --warning: #f39c12;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --radius: 10px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f5f7fa; color: var(--dark); line-height: 1.6; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        header { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white; padding: 2rem; border-radius: var(--radius);
            margin-bottom: 2rem; box-shadow: var(--shadow);
        }
        header h1 { font-size: 2.2rem; margin-bottom: 0.5rem; }
        .badge { 
            display: inline-block; background: rgba(255,255,255,0.2); 
            padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;
            margin-top: 1rem;
        }
        
        /* Loader */
        .loader { 
            border: 4px solid #f3f3f3; border-top: 4px solid var(--secondary); 
            border-radius: 50%; width: 40px; height: 40px; 
            animation: spin 1s linear infinite; margin: 2rem auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Cards */
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .card { background: white; padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); }
        .card h3 { color: var(--gray); font-size: 0.9rem; margin-bottom: 0.5rem; }
        .card .value { font-size: 2rem; font-weight: bold; color: var(--primary); margin: 0.5rem 0; }
        
        /* Filters */
        .filters { 
            background: white; padding: 1.5rem; border-radius: var(--radius); 
            box-shadow: var(--shadow); margin-bottom: 2rem;
            display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;
        }
        .filter-group { flex: 1; min-width: 200px; }
        .filter-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        select, input { 
            width: 100%; padding: 0.7rem; border: 2px solid #e0e6ed; 
            border-radius: 6px; font-size: 1rem;
        }
        button { 
            padding: 0.7rem 1.5rem; border: none; border-radius: 6px; 
            cursor: pointer; font-weight: 600; transition: all 0.3s;
        }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-secondary { background: var(--gray); color: white; }
        .btn-success { background: var(--success); color: white; }
        button:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        
        /* Charts */
        .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        @media (max-width: 768px) { .charts { grid-template-columns: 1fr; } }
        .chart-container { background: white; padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); }
        .chart-container h3 { margin-bottom: 1rem; color: var(--primary); }
        
        /* Table */
        .table-container { 
            background: white; border-radius: var(--radius); box-shadow: var(--shadow); 
            padding: 1.5rem; margin-bottom: 2rem; overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--light); font-weight: 600; color: var(--primary); }
        tr:hover { background: rgba(52, 152, 219, 0.05); }
        
        /* Status */
        .status { text-align: center; padding: 2rem; color: var(--gray); }
        .error { background: #fee; color: #c00; padding: 1rem; border-radius: var(--radius); margin: 1rem 0; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-heartbeat"></i> Dashboard Epidemiológico</h1>
            <p>Análisis de causas de defunción - Datos en tiempo real desde Google Sheets</p>
            <div class="badge" id="statusBadge">
                <i class="fas fa-sync fa-spin"></i> Conectando a datos...
            </div>
        </header>
        
        <div id="errorMessage" class="error" style="display: none;"></div>
        
        <div id="loader" class="loader"></div>
        
        <div id="dashboardContent" style="display: none;">
            <!-- Filtros -->
            <div class="filters">
                <div class="filter-group">
                    <label><i class="fas fa-calendar-alt"></i> Año</label>
                    <select id="yearFilter">
                        <option value="all">Todos los años</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-calendar"></i> Mes</label>
                    <select id="monthFilter">
                        <option value="all">Todos los meses</option>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-search"></i> Buscar</label>
                    <input type="text" id="searchInput" placeholder="Código CIE o descripción...">
                </div>
                <button onclick="applyFilters()" class="btn-primary">
                    <i class="fas fa-filter"></i> Filtrar
                </button>
                <button onclick="resetFilters()" class="btn-secondary">
                    <i class="fas fa-redo"></i> Limpiar
                </button>
                <button onclick="loadData()" class="btn-success">
                    <i class="fas fa-sync"></i> Actualizar
                </button>
            </div>
            
            <!-- Cards -->
            <div class="cards">
                <div class="card">
                    <h3>TOTAL DEFUNCIONES</h3>
                    <div class="value" id="totalDeaths">0</div>
                    <p>Período completo</p>
                </div>
                <div class="card">
                    <h3>CAUSA PRINCIPAL</h3>
                    <div class="value" id="topCause">-</div>
                    <p id="topCauseDesc"></p>
                </div>
                <div class="card">
                    <h3>MÁXIMO MENSUAL</h3>
                    <div class="value" id="peakMonth">-</div>
                    <p id="peakCount"></p>
                </div>
                <div class="card">
                    <h3>CÓDIGOS ÚNICOS</h3>
                    <div class="value" id="uniqueCodes">0</div>
                    <p>Diversidad de causas</p>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="charts">
                <div class="chart-container">
                    <h3><i class="fas fa-chart-bar"></i> Defunciones por Mes</h3>
                    <canvas id="monthlyChart" height="250"></canvas>
                </div>
                <div class="chart-container">
                    <h3><i class="fas fa-chart-pie"></i> Top 10 Causas</h3>
                    <canvas id="causesChart" height="250"></canvas>
                </div>
            </div>
            
            <!-- Table -->
            <div class="table-container">
                <h3><i class="fas fa-table"></i> Datos Detallados</h3>
                <p id="tableInfo">Mostrando <span id="rowCount">0</span> registros</p>
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Año</th>
                            <th>Mes</th>
                            <th>Código CIE</th>
                            <th>Descripción</th>
                            <th>Cantidad</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Datos dinámicos -->
                    </tbody>
                </table>
            </div>
            
            <div class="status">
                <p id="lastUpdate">Última actualización: -</p>
                <p>Dashboard conectado a Google Sheets vía Google Apps Script</p>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURACIÓN =====
        // IMPORTANTE: Reemplaza esta URL con la de TU Google Apps Script publicado
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzLPSiBwOi6EQJ7hN4Gxqh6NOQebHfnZtCAFP-XdabMZCHo7JSHAHU7IxiTaGSFPNc0/exec';
        
        // ===== VARIABLES GLOBALES =====
        let rawData = [];
        let filteredData = [];
        let monthlyChart = null;
        let causesChart = null;
        
        // ===== INICIALIZACIÓN =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard inicializando...');
            loadData();
        });
        
        // ===== FUNCIONES PRINCIPALES =====
        
        // Cargar datos desde GAS
        async function loadData() {
            showLoader(true);
            showError('');
            updateStatus('Conectando a Google Sheets...');
            
            try {
                // Usar fetch con modo 'no-cors' para GitHub Pages
                const response = await fetch(GAS_URL, {
                    method: 'GET',
                    mode: 'no-cors' // Modo especial para GitHub Pages
                });
                
                // Para 'no-cors', usamos un proxy o método alternativo
                await loadDataWithJSONP();
                
            } catch (error) {
                console.error('Error de conexión:', error);
                showError('Error de conexión. Usando datos de ejemplo...');
                loadSampleData();
            }
        }
        
        // Método JSONP para evitar CORS
        function loadDataWithJSONP() {
            return new Promise((resolve, reject) => {
                const callbackName = 'callback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (data && data.success) {
                        processData(data.data);
                        resolve(data);
                    } else {
                        reject(new Error('Datos inválidos'));
                    }
                };
                
                script.src = `${GAS_URL}?callback=${callbackName}&format=jsonp`;
                script.onerror = reject;
                document.body.appendChild(script);
            });
        }
        
        // Procesar datos recibidos
        function processData(data) {
            try {
                rawData = data.map(item => ({
                    year: item.año || item.year,
                    month: item.mes || item.month,
                    monthName: item.mes_nombre || item.mesNombre,
                    code: item.codigo_cie || item.code,
                    description: item.descripcion_cie || item.description,
                    count: item.cantidad || item.count
                }));
                
                console.log(`${rawData.length} registros cargados`);
                
                // Actualizar filtros de año
                updateYearFilters();
                
                // Mostrar dashboard
                filteredData = [...rawData];
                updateDashboard();
                updateStatus('Datos cargados correctamente');
                showLoader(false);
                
            } catch (error) {
                console.error('Error procesando datos:', error);
                showError('Error procesando datos. Cargando datos de ejemplo...');
                loadSampleData();
            }
        }
        
        // Datos de ejemplo (fallback)
        function loadSampleData() {
            rawData = [
                {year: 2024, month: 1, monthName: "Enero", code: "A419", description: "SEPSIS, NO ESPECIFICADA", count: 4},
                {year: 2024, month: 2, monthName: "Febrero", code: "A419", description: "SEPSIS, NO ESPECIFICADA", count: 1},
                {year: 2024, month: 3, monthName: "Marzo", code: "A419", description: "SEPSIS, NO ESPECIFICADA", count: 4},
                {year: 2024, month: 4, monthName: "Abril", code: "A419", description: "SEPSIS, NO ESPECIFICADA", count: 4},
                {year: 2024, month: 5, monthName: "Mayo", code: "A419", description: "SEPSIS, NO ESPECIFICADA", count: 2},
                {year: 2024, month: 6, monthName: "Junio", code: "A419", description: "SEPSIS, NO ESPECIFICADA", count: 5},
                {year: 2024, month: 8, monthName: "Agosto", code: "A419", description: "SEPSIS, NO ESPECIFICADA", count: 1},
                {year: 2024, month: 9, monthName: "Septiembre", code: "A419", description: "SEPSIS, NO ESPECIFICADA", count: 4},
                {year: 2024, month: 10, monthName: "Octubre", code: "A419", description: "SEPSIS, NO ESPECIFICADA", count: 3},
                {year: 2024, month: 11, monthName: "Noviembre", code: "A419", description: "SEPSIS, NO ESPECIFICADA", count: 3},
                {year: 2024, month: 12, monthName: "Diciembre", code: "A419", description: "SEPSIS, NO ESPECIFICADA", count: 5},
                {year: 2025, month: 1, monthName: "Enero", code: "A419", description: "SEPSIS, NO ESPECIFICADA", count: 5},
                {year: 2025, month: 2, monthName: "Febrero", code: "A419", description: "SEPSIS, NO ESPECIFICADA", count: 2},
                {year: 2025, month: 3, monthName: "Marzo", code: "A419", description: "SEPSIS, NO ESPECIFICADA", count: 4},
                {year: 2025, month: 4, monthName: "Abril", code: "A419", description: "SEPSIS, NO ESPECIFICADA", count: 8},
                {year: 2025, month: 5, monthName: "Mayo", code: "A419", description: "SEPSIS, NO ESPECIFICADA", count: 3},
                {year: 2025, month: 6, monthName: "Junio", code: "A419", description: "SEPSIS, NO ESPECIFICADA", count: 2}
            ];
            
            updateYearFilters();
            filteredData = [...rawData];
            updateDashboard();
            updateStatus('Usando datos de ejemplo');
            showLoader(false);
        }
        
        // ===== FUNCIONES DE FILTRADO =====
        
        function applyFilters() {
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            filteredData = rawData.filter(item => {
                if (year !== 'all' && item.year.toString() !== year) return false;
                if (month !== 'all' && item.month.toString() !== month) return false;
                if (search && !item.code.toLowerCase().includes(search) && 
                    !item.description.toLowerCase().includes(search)) return false;
                return true;
            });
            
            updateDashboard();
        }
        
        function resetFilters() {
            document.getElementById('yearFilter').value = 'all';
            document.getElementById('monthFilter').value = 'all';
            document.getElementById('searchInput').value = '';
            filteredData = [...rawData];
            updateDashboard();
        }
        
        // ===== ACTUALIZAR DASHBOARD =====
        
        function updateDashboard() {
            updateStats();
            updateTable();
            updateCharts();
            updateStatus(`Mostrando ${filteredData.length} registros filtrados`);
        }
        
        function updateStats() {
            if (filteredData.length === 0) {
                document.getElementById('totalDeaths').textContent = '0';
                document.getElementById('topCause').textContent = '-';
                document.getElementById('peakMonth').textContent = '-';
                document.getElementById('uniqueCodes').textContent = '0';
                return;
            }
            
            // Total defunciones
            const total = filteredData.reduce((sum, item) => sum + item.count, 0);
            document.getElementById('totalDeaths').textContent = total.toLocaleString();
            
            // Causa principal
            const causeCounts = {};
            filteredData.forEach(item => {
                causeCounts[item.code] = (causeCounts[item.code] || 0) + item.count;
            });
            
            let topCode = '';
            let topCount = 0;
            for (const [code, count] of Object.entries(causeCounts)) {
                if (count > topCount) {
                    topCount = count;
                    topCode = code;
                }
            }
            
            const topItem = filteredData.find(item => item.code === topCode);
            document.getElementById('topCause').textContent = topCode;
            document.getElementById('topCauseDesc').textContent = 
                topItem ? (topItem.description.length > 40 ? 
                    topItem.description.substring(0, 40) + '...' : 
                    topItem.description) : '';
            
            // Mes pico
            const monthCounts = {};
            filteredData.forEach(item => {
                const key = `${item.monthName} ${item.year}`;
                monthCounts[key] = (monthCounts[key] || 0) + item.count;
            });
            
            let peakMonth = '';
            let peakCount = 0;
            for (const [month, count] of Object.entries(monthCounts)) {
                if (count > peakCount) {
                    peakCount = count;
                    peakMonth = month;
                }
            }
            
            document.getElementById('peakMonth').textContent = peakMonth;
            document.getElementById('peakCount').textContent = `${peakCount} defunciones`;
            
            // Códigos únicos
            const uniqueCodes = new Set(filteredData.map(item => item.code));
            document.getElementById('uniqueCodes').textContent = uniqueCodes.size;
        }
        
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            const rowCount = document.getElementById('rowCount');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem;">
                            No hay datos con los filtros actuales
                        </td>
                    </tr>
                `;
                rowCount.textContent = '0';
                return;
            }
            
            // Ordenar datos
            const sortedData = [...filteredData].sort((a, b) => {
                if (a.year !== b.year) return b.year - a.year;
                if (a.month !== b.month) return b.month - a.month;
                return b.count - a.count;
            });
            
            let html = '';
            sortedData.forEach(item => {
                const shortDesc = item.description.length > 60 ? 
                    item.description.substring(0, 60) + '...' : 
                    item.description;
                
                html += `
                    <tr>
                        <td><strong>${item.year}</strong></td>
                        <td>${item.monthName}</td>
                        <td><code>${item.code}</code></td>
                        <td title="${item.description}">${shortDesc}</td>
                        <td><span style="color: #e74c3c; font-weight: bold;">${item.count}</span></td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            rowCount.textContent = filteredData.length.toString();
        }
        
        function updateCharts() {
            if (!monthlyChart || !causesChart) {
                initCharts();
            }
            
            updateMonthlyChart();
            updateCausesChart();
        }
        
        function initCharts() {
            // Gráfico mensual
            const ctx1 = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(ctx1, {
                type: 'bar',
                data: { labels: [], datasets: [{
                    label: 'Defunciones',
                    data: [],
                    backgroundColor: '#3498db',
                    borderColor: '#2980b9',
                    borderWidth: 1
                }]},
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            // Gráfico de causas
            const ctx2 = document.getElementById('causesChart').getContext('2d');
            causesChart = new Chart(ctx2, {
                type: 'bar',
                data: { labels: [], datasets: [{
                    label: 'Defunciones',
                    data: [],
                    backgroundColor: '#e74c3c',
                    borderColor: '#c0392b',
                    borderWidth: 1
                }]},
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }
        
        function updateMonthlyChart() {
            const monthData = {};
            filteredData.forEach(item => {
                const key = `${item.monthName} ${item.year}`;
                monthData[key] = (monthData[key] || 0) + item.count;
            });
            
            const labels = Object.keys(monthData);
            const data = Object.values(monthData);
            
            monthlyChart.data.labels = labels;
            monthlyChart.data.datasets[0].data = data;
            monthlyChart.update();
        }
        
        function updateCausesChart() {
            const causeData = {};
            filteredData.forEach(item => {
                const key = item.code;
                causeData[key] = (causeData[key] || 0) + item.count;
            });
            
            const sorted = Object.entries(causeData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const labels = sorted.map(([code]) => code);
            const data = sorted.map(([, count]) => count);
            
            causesChart.data.labels = labels;
            causesChart.data.datasets[0].data = data;
            causesChart.update();
        }
        
        // ===== FUNCIONES AUXILIARES =====
        
        function updateYearFilters() {
            const years = [...new Set(rawData.map(item => item.year))].sort((a, b) => b - a);
            const select = document.getElementById('yearFilter');
            
            select.innerHTML = '<option value="all">Todos los años</option>';
            years.forEach(year => {
                select.innerHTML += `<option value="${year}">${year}</option>`;
            });
        }
        
        function updateStatus(message) {
            const badge = document.getElementById('statusBadge');
            badge.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            document.getElementById('lastUpdate').textContent = 
                `Última actualización: ${new Date().toLocaleTimeString()}`;
        }
        
        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
            document.getElementById('dashboardContent').style.display = show ? 'none' : 'block';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (message) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            } else {
                errorDiv.style.display = 'none';
            }
        }
    </script>
</body>
</html>