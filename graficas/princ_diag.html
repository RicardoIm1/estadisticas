<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Hospitalario - Sin CORS Issues</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ============================================
        // DATOS EMBEBIDOS DIRECTAMENTE - SIN FETCH
        // ============================================
        <? var data = getDataForHtml(); ?>
        const EMBEDDED_DATA = <?= data ?>;
        // ============================================
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f0f2f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        header { background: linear-gradient(135deg, #1a237e 0%, #283593 100%); color: white; padding: 30px; text-align: center; }
        h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .controls { padding: 20px; background: #f8f9fa; text-align: center; }
        button { background: #1a237e; color: white; border: none; padding: 12px 25px; margin: 5px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:hover { background: #283593; }
        .dashboard { padding: 30px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .stat-value { font-size: 2.5rem; font-weight: bold; color: #1a237e; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f5f5f5; color: #1a237e; }
        .chart-container { height: 400px; margin: 30px 0; }
        footer { padding: 20px; background: #f8f9fa; text-align: center; color: #666; border-top: 1px solid #e0e0e0; }
        .data-source { background: #e8f5e9; padding: 10px; border-radius: 5px; margin: 10px 0; color: #2e7d32; }
        .error { background: #ffebee; padding: 15px; border-radius: 5px; margin: 10px 0; color: #c62828; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè• Dashboard Hospitalario</h1>
            <p>Datos del 2do Cuatrimestre 2024 vs 2025</p>
            <div class="data-source">
                <strong>‚úì Datos cargados directamente</strong> - Sin problemas de CORS
            </div>
        </header>
        
        <div class="controls">
            <button onclick="refreshData()">üîÑ Actualizar P√°gina</button>
            <button onclick="showRawData()">üìä Ver Datos Crudos</button>
            <button onclick="exportToCSV()">üì• Exportar CSV</button>
        </div>
        
        <div class="dashboard" id="dashboard">
            <!-- Se cargar√° din√°micamente -->
        </div>
        
        <footer>
            <p>Actualizado: <span id="updateTime"></span></p>
            <p><span id="dataStatus"></span></p>
        </footer>
    </div>

    <script>
        // ============================================
        // INICIALIZACI√ìN - DATOS YA EST√ÅN CARGADOS
        // ============================================
        console.log('üöÄ Dashboard inicializado');
        console.log('üìä Datos embebidos:', EMBEDDED_DATA);
        
        // Verificar datos
        const hasRealData = !EMBEDDED_DATA.error && !EMBEDDED_DATA.sampleData;
        const dataSource = hasRealData ? 'Google Sheets (Datos reales)' : 'Datos de ejemplo';
        
        // Actualizar UI
        document.getElementById('updateTime').textContent = new Date().toLocaleString('es-ES');
        document.getElementById('dataStatus').textContent = hasRealData ? '‚úÖ Datos en tiempo real' : '‚ö†Ô∏è Modo demostraci√≥n';
        document.getElementById('dataStatus').style.color = hasRealData ? '#2e7d32' : '#f57c00';
        
        // Renderizar dashboard inmediatamente
        renderDashboard();
        
        // ============================================
        // FUNCIONES PRINCIPALES
        // ============================================
        
        function renderDashboard() {
            const dashboardEl = document.getElementById('dashboard');
            
            if (!EMBEDDED_DATA || EMBEDDED_DATA.error) {
                dashboardEl.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Error al cargar datos</h3>
                        <p>${EMBEDDED_DATA.error || 'Error desconocido'}</p>
                        <p>Mostrando datos de ejemplo...</p>
                    </div>
                `;
                loadSampleData();
                return;
            }
            
            // Usar datos reales o de ejemplo
            const data = EMBEDDED_DATA.sampleData ? getEnhancedSampleData() : EMBEDDED_DATA;
            
            let html = '';
            
            // 1. ESTAD√çSTICAS
            html += '<h2>üìà Estad√≠sticas Principales</h2>';
            html += '<div class="stats">';
            
            // Egresos Hospitalarios
            const egresos2025 = data.egresos_hospitalarios?.['2025'] || [];
            const egresos2024 = data.egresos_hospitalarios?.['2024'] || [];
            const totalEgresos2025 = egresos2025.reduce((sum, item) => sum + (item.volumen || 0), 0);
            const totalEgresos2024 = egresos2024.reduce((sum, item) => sum + (item.volumen || 0), 0);
            
            html += `
                <div class="stat-card">
                    <h3>üè• Egresos Hospitalarios</h3>
                    <div class="stat-value">${totalEgresos2025.toLocaleString()}</div>
                    <p>2025: ${totalEgresos2025.toLocaleString()} casos</p>
                    <p>2024: ${totalEgresos2024.toLocaleString()} casos</p>
                    <p style="color: ${totalEgresos2025 >= totalEgresos2024 ? '#2e7d32' : '#c62828'}; margin-top: 10px;">
                        ${totalEgresos2025 >= totalEgresos2024 ? 'üìà' : 'üìâ'} 
                        ${totalEgresos2024 > 0 ? Math.abs(((totalEgresos2025 - totalEgresos2024) / totalEgresos2024 * 100)).toFixed(1) : '100'}%
                        ${totalEgresos2025 >= totalEgresos2024 ? 'aumento' : 'disminuci√≥n'}
                    </p>
                </div>
            `;
            
            // Urgencias
            const urgencias2025 = data.urgencias?.['2025'] || [];
            const urgencias2024 = data.urgencias?.['2024'] || [];
            const totalUrgencias2025 = urgencias2025.reduce((sum, item) => sum + (item.volumen || 0), 0);
            const totalUrgencias2024 = urgencias2024.reduce((sum, item) => sum + (item.volumen || 0), 0);
            
            html += `
                <div class="stat-card">
                    <h3>üöë Urgencias</h3>
                    <div class="stat-value">${totalUrgencias2025.toLocaleString()}</div>
                    <p>2025: ${totalUrgencias2025.toLocaleString()} casos</p>
                    <p>2024: ${totalUrgencias2024.toLocaleString()} casos</p>
                    <p style="color: ${totalUrgencias2025 >= totalUrgencias2024 ? '#2e7d32' : '#c62828'}; margin-top: 10px;">
                        ${totalUrgencias2025 >= totalUrgencias2024 ? 'üìà' : 'üìâ'} 
                        ${totalUrgencias2024 > 0 ? Math.abs(((totalUrgencias2025 - totalUrgencias2024) / totalUrgencias2024 * 100)).toFixed(1) : '100'}%
                        ${totalUrgencias2025 >= totalUrgencias2024 ? 'aumento' : 'disminuci√≥n'}
                    </p>
                </div>
            `;
            
            html += '</div>';
            
            // 2. GR√ÅFICOS
            html += '<h2>üìä Gr√°ficos Comparativos</h2>';
            html += '<div class="chart-container"><canvas id="mainChart"></canvas></div>';
            
            // 3. TABLAS DE DATOS
            html += '<h2>üìã Datos Detallados</h2>';
            
            // Tabla de Egresos 2025
            if (egresos2025.length > 0) {
                html += '<h3>üè• Top 10 Egresos Hospitalarios 2025</h3>';
                html += '<table>';
                html += '<thead><tr><th>#</th><th>Diagn√≥stico</th><th>Volumen</th></tr></thead>';
                html += '<tbody>';
                egresos2025.slice(0, 10).forEach(item => {
                    html += `<tr>
                        <td><strong>${item.orden}</strong></td>
                        <td>${item.causa}</td>
                        <td><strong>${item.volumen.toLocaleString()}</strong></td>
                    </tr>`;
                });
                html += '</tbody></table>';
            }
            
            // Tabla de Urgencias 2025
            if (urgencias2025.length > 0) {
                html += '<h3 style="margin-top: 30px;">üöë Top 10 Urgencias 2025</h3>';
                html += '<table>';
                html += '<thead><tr><th>#</th><th>Diagn√≥stico</th><th>Volumen</th></tr></thead>';
                html += '<tbody>';
                urgencias2025.slice(0, 10).forEach(item => {
                    html += `<tr>
                        <td><strong>${item.orden}</strong></td>
                        <td>${item.causa}</td>
                        <td><strong>${item.volumen.toLocaleString()}</strong></td>
                    </tr>`;
                });
                html += '</tbody></table>';
            }
            
            dashboardEl.innerHTML = html;
            
            // Renderizar gr√°fico
            renderChart();
        }
        
        function renderChart() {
            const ctx = document.getElementById('mainChart');
            if (!ctx) return;
            
            const data = EMBEDDED_DATA.sampleData ? getEnhancedSampleData() : EMBEDDED_DATA;
            
            const egresos2025 = data.egresos_hospitalarios?.['2025'] || [];
            const egresos2024 = data.egresos_hospitalarios?.['2024'] || [];
            const urgencias2025 = data.urgencias?.['2025'] || [];
            const urgencias2024 = data.urgencias?.['2024'] || [];
            
            const totalEgresos2025 = egresos2025.reduce((sum, item) => sum + (item.volumen || 0), 0);
            const totalEgresos2024 = egresos2024.reduce((sum, item) => sum + (item.volumen || 0), 0);
            const totalUrgencias2025 = urgencias2025.reduce((sum, item) => sum + (item.volumen || 0), 0);
            const totalUrgencias2024 = urgencias2024.reduce((sum, item) => sum + (item.volumen || 0), 0);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Egresos Hospitalarios', 'Urgencias'],
                    datasets: [
                        {
                            label: '2024',
                            data: [totalEgresos2024, totalUrgencias2024],
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '2025',
                            data: [totalEgresos2025, totalUrgencias2025],
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function getEnhancedSampleData() {
            return {
                egresos_hospitalarios: {
                    '2024': [
                        { orden: 1, causa: "160 Causas obst√©tricas directas, excepto aborto y parto √∫nico espont√°neo (solo morbilidad)", volumen: 324 },
                        { orden: 2, causa: "166 Traumatismos, envenenamientos y algunas otras consecuencias de causas externas", volumen: 276 },
                        { orden: 3, causa: "161 Parto √∫nico espont√°neo", volumen: 201 },
                        { orden: 4, causa: "159 Aborto (solo morbilidad)", volumen: 127 },
                        { orden: 5, causa: "163 Ciertas afecciones originadas en el per√≠odo perinatal", volumen: 95 }
                    ],
                    '2025': [
                        { orden: 1, causa: "166 Traumatismos, envenenamientos y algunas otras consecuencias de causas externas", volumen: 272 },
                        { orden: 2, causa: "160 Causas obst√©tricas directas, excepto aborto y parto √∫nico espont√°neo (solo morbilidad)", volumen: 253 },
                        { orden: 3, causa: "161 Parto √∫nico espont√°neo", volumen: 223 },
                        { orden: 4, causa: "159 Aborto (solo morbilidad)", volumen: 122 },
                        { orden: 5, causa: "163 Ciertas afecciones originadas en el per√≠odo perinatal", volumen: 83 }
                    ]
                },
                urgencias: {
                    '2024': [
                        { orden: 1, causa: "166 Traumatismos, envenenamientos y algunas otras consecuencias de causas externas", volumen: 2018 },
                        { orden: 2, causa: "179 Supervisi√≥n de embarazo normal", volumen: 1293 },
                        { orden: 3, causa: "160 Causas obst√©tricas directas, excepto aborto y parto √∫nico espont√°neo (solo morbilidad)", volumen: 405 },
                        { orden: 4, causa: "104 Infecciones respiratorias agudas, excepto neumon√≠a e influenza", volumen: 362 },
                        { orden: 5, causa: "126 Colelitiasis y colecistitis", volumen: 261 }
                    ],
                    '2025': [
                        { orden: 1, causa: "166 Traumatismos, envenenamientos y algunas otras consecuencias de causas externas", volumen: 1924 },
                        { orden: 2, causa: "179 Supervisi√≥n de embarazo normal", volumen: 1162 },
                        { orden: 3, causa: "160 Causas obst√©tricas directas, excepto aborto y parto √∫nico espont√°neo (solo morbilidad)", volumen: 332 },
                        { orden: 4, causa: "104 Infecciones respiratorias agudas, excepto neumon√≠a e influenza", volumen: 311 },
                        { orden: 5, causa: "001 Enfermedades infecciosas intestinales", volumen: 283 }
                    ]
                }
            };
        }
        
        function loadSampleData() {
            console.log('Cargando datos de ejemplo mejorados...');
            // Ya est√°n cargados en getEnhancedSampleData()
        }
        
        function refreshData() {
            location.reload();
        }
        
        function showRawData() {
            alert('Datos embebidos:\n' + JSON.stringify(EMBEDDED_DATA, null, 2));
        }
        
        function exportToCSV() {
            const data = EMBEDDED_DATA.sampleData ? getEnhancedSampleData() : EMBEDDED_DATA;
            let csv = 'Categor√≠a,A√±o,Orden,Diagn√≥stico,Volumen\n';
            
            ['egresos_hospitalarios', 'urgencias'].forEach(category => {
                ['2024', '2025'].forEach(year => {
                    const items = data[category]?.[year] || [];
                    items.forEach(item => {
                        csv += `${category},${year},${item.orden},"${item.causa.replace(/"/g, '""')}",${item.volumen}\n`;
                    });
                });
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `dashboard_hospitalario_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // Inicializar tooltips para Chart.js si es necesario
        if (typeof Chart !== 'undefined') {
            Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            Chart.defaults.plugins.tooltip.titleColor = '#fff';
            Chart.defaults.plugins.tooltip.bodyColor = '#fff';
            Chart.defaults.plugins.tooltip.padding = 10;
        }
    </script>
</body>
</html>