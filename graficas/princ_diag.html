<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Hospitalario - Sin CORS Issues</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; padding: 0; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        header { background: linear-gradient(135deg, #1a237e 0%, #283593 100%); color: white; padding: 30px; text-align: center; }
        h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .controls { background: #f8f9fa; padding: 20px; display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        button { background: #1a237e; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        button:hover { background: #283593; transform: translateY(-2px); transition: all 0.3s; }
        .loading { text-align: center; padding: 60px; font-size: 1.2rem; color: #666; }
        .error { background: #ff5252; color: white; padding: 20px; margin: 20px; border-radius: 10px; text-align: center; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; padding: 30px; }
        .stat-card { background: white; border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .stat-value { font-size: 2.5rem; font-weight: bold; color: #1a237e; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #1a237e; color: white; }
        tr:hover { background: #f5f5f5; }
        .chart-container { height: 400px; margin: 30px; }
        footer { text-align: center; padding: 20px; background: #f8f9fa; color: #666; border-top: 1px solid #e0e0e0; }
        .tab { display: inline-block; padding: 10px 20px; cursor: pointer; background: #e0e0e0; margin: 5px; border-radius: 5px; }
        .tab.active { background: #1a237e; color: white; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè• Dashboard Hospitalario</h1>
            <p>Datos del 2do Cuatrimestre 2024 vs 2025</p>
            <div style="margin-top: 15px; font-size: 0.9rem; opacity: 0.9;">
                <i class="fas fa-bolt"></i> Sin problemas de CORS - Conexi√≥n directa
            </div>
        </header>
        
        <div class="controls">
            <button onclick="loadData()">
                <span>üîÑ Cargar Datos</span>
            </button>
            <button onclick="testConnection()">
                <span>üîó Probar Conexi√≥n</span>
            </button>
            <button onclick="window.open('<?= ScriptApp.getService().getUrl() ?>?api=data', '_blank')">
                <span>üìä Ver JSON</span>
            </button>
        </div>
        
        <div id="message"></div>
        
        <div id="loading" class="loading" style="display: none;">
            <h2>‚è≥ Cargando datos...</h2>
            <p>Conectando directamente con Google Sheets</p>
            <div style="margin-top: 20px; font-size: 0.9rem; color: #666;">
                Esta versi√≥n no usa fetch() para evitar problemas de CORS
            </div>
        </div>
        
        <div class="tabs" style="background: #f1f1f1; padding: 10px; text-align: center;">
            <div class="tab active" onclick="showTab('stats')">üìà Estad√≠sticas</div>
            <div class="tab" onclick="showTab('charts')">üìä Gr√°ficos</div>
            <div class="tab" onclick="showTab('tables')">üìã Tablas</div>
            <div class="tab" onclick="showTab('raw')">üìÑ Datos Crudos</div>
        </div>
        
        <div id="stats-tab" class="tab-content active">
            <div class="stats" id="stats"></div>
        </div>
        
        <div id="charts-tab" class="tab-content">
            <div class="chart-container">
                <canvas id="chart"></canvas>
            </div>
        </div>
        
        <div id="tables-tab" class="tab-content">
            <div id="tables"></div>
        </div>
        
        <div id="raw-tab" class="tab-content">
            <pre id="raw-data" style="background: #f5f5f5; padding: 20px; border-radius: 10px; overflow: auto; max-height: 500px;"></pre>
        </div>
        
        <footer>
            <p>Conectado directamente a: <?= ScriptApp.getService().getUrl() ?></p>
            <p style="margin-top: 10px; font-size: 0.9rem;">
                Actualizado: <span id="update-time">--:--</span> | 
                <span id="data-status" style="color: #4CAF50;">‚óè Conectado</span>
            </p>
        </footer>
    </div>

    <script>
        // ============================================
        // SOLUCI√ìN DEFINITIVA - SIN FETCH, SIN CORS
        // ============================================
        
        // URL de tu Web App - IMPORTANTE: Usar <?= ?> para obtener din√°micamente
        const WEB_APP_URL = '<?= ScriptApp.getService().getUrl() ?>';
        console.log('URL de la Web App:', WEB_APP_URL);
        
        let dashboardData = null;
        let chart = null;
        
        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard inicializado');
            updateStatus('üü° Esperando datos...');
            
            // Cargar datos autom√°ticamente despu√©s de 1 segundo
            setTimeout(loadData, 1000);
        });
        
        // Mostrar mensaje
        function showMessage(text, type = 'info') {
            const messageEl = document.getElementById('message');
            if (!messageEl) return;
            
            messageEl.innerHTML = `
                <div class="${type === 'error' ? 'error' : 'info'}" style="background: ${type === 'error' ? '#ff5252' : '#4CAF50'};">
                    ${text}
                </div>
            `;
            messageEl.style.display = 'block';
            
            // Auto-ocultar despu√©s de 5 segundos
            if (type !== 'error') {
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 5000);
            }
        }
        
        // Actualizar estado
        function updateStatus(status) {
            const statusEl = document.getElementById('data-status');
            if (statusEl) {
                statusEl.innerHTML = status;
            }
            
            const timeEl = document.getElementById('update-time');
            if (timeEl) {
                const now = new Date();
                timeEl.textContent = now.toLocaleTimeString('es-ES');
            }
        }
        
        // Mostrar/ocultar tabs
        function showTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar tab seleccionado
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        // ============================================
        // M√âTODO PRINCIPAL - SIN FETCH
        // ============================================
        
        function loadData() {
            console.log('Iniciando carga de datos...');
            document.getElementById('loading').style.display = 'block';
            document.getElementById('message').style.display = 'none';
            updateStatus('üü° Cargando...');
            
            // M√©todo 1: Usar iframe para evitar CORS
            loadDataViaIframe();
        }
        
        function loadDataViaIframe() {
            console.log('Usando m√©todo iframe...');
            
            // Crear iframe oculto
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = WEB_APP_URL + '?api=data&format=json&callback=handleData';
            
            // Configurar evento de carga
            iframe.onload = function() {
                console.log('Iframe cargado');
                
                try {
                    // Intentar acceder al contenido
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const text = iframeDoc.body.textContent;
                    
                    if (text) {
                        const data = JSON.parse(text);
                        processData(data);
                    } else {
                        throw new Error('Iframe vac√≠o');
                    }
                } catch (error) {
                    console.warn('Error con iframe:', error);
                    // Intentar m√©todo alternativo
                    loadDataViaScriptTag();
                }
            };
            
            iframe.onerror = function() {
                console.warn('Error cargando iframe');
                loadDataViaScriptTag();
            };
            
            document.body.appendChild(iframe);
            
            // Timeout
            setTimeout(() => {
                if (document.body.contains(iframe)) {
                    document.body.removeChild(iframe);
                }
                if (!dashboardData) {
                    loadDataViaScriptTag();
                }
            }, 10000);
        }
        
        function loadDataViaScriptTag() {
            console.log('Usando m√©todo script tag (JSONP)...');
            
            // Crear script para JSONP
            const script = document.createElement('script');
            script.src = WEB_APP_URL + '?api=data&callback=handleJsonpData&t=' + Date.now();
            
            // Funci√≥n global para JSONP
            window.handleJsonpData = function(data) {
                console.log('Datos recibidos via JSONP:', data);
                processData(data);
                
                // Limpiar script
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
            };
            
            script.onerror = function() {
                console.error('Error cargando script JSONP');
                document.getElementById('loading').style.display = 'none';
                showMessage(`
                    <strong>Error de conexi√≥n</strong><br>
                    No se pudo cargar los datos. Posibles soluciones:<br>
                    1. Aseg√∫rate de que la Web App est√© desplegada<br>
                    2. Verifica tu conexi√≥n a internet<br>
                    3. Prueba en otro navegador<br><br>
                    <button onclick="loadSampleData()" style="background: white; color: #ff5252; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">
                        Cargar datos de ejemplo
                    </button>
                `, 'error');
                updateStatus('üî¥ Error de conexi√≥n');
            };
            
            document.head.appendChild(script);
        }
        
        // Procesar datos recibidos
        function processData(result) {
            console.log('Procesando datos:', result);
            
            if (result && result.success) {
                dashboardData = result.data;
                
                // Renderizar todo
                renderStats();
                renderChart();
                renderTables();
                renderRawData();
                
                document.getElementById('loading').style.display = 'none';
                showMessage('‚úÖ Datos cargados correctamente', 'success');
                updateStatus('üü¢ Conectado');
                
                console.log('Dashboard actualizado correctamente');
                
            } else {
                throw new Error(result?.error || 'Error en los datos recibidos');
            }
        }
        
        // Funci√≥n de prueba de conexi√≥n
        function testConnection() {
            console.log('Probando conexi√≥n...');
            showMessage('üîç Probando conexi√≥n con el servidor...');
            
            const testScript = document.createElement('script');
            testScript.src = WEB_APP_URL + '?api=data&callback=testCallback&t=' + Date.now();
            
            window.testCallback = function(data) {
                if (data && data.success) {
                    showMessage('‚úÖ Conexi√≥n exitosa. Datos disponibles.', 'success');
                    console.log('Test exitoso:', data);
                } else {
                    showMessage('‚ö†Ô∏è Conexi√≥n establecida pero error en datos', 'error');
                }
                
                if (testScript.parentNode) {
                    testScript.parentNode.removeChild(testScript);
                }
            };
            
            testScript.onerror = function() {
                showMessage('‚ùå No se pudo establecer conexi√≥n', 'error');
            };
            
            document.head.appendChild(testScript);
        }
        
        // ============================================
        // RENDERIZADO
        // ============================================
        
        function renderStats() {
            const statsEl = document.getElementById('stats');
            if (!statsEl || !dashboardData) return;
            
            let html = '';
            const categories = ['egresos_hospitalarios', 'urgencias', 'afecciones_lesiones', 'causas_externas'];
            
            categories.forEach(cat => {
                const stats = dashboardData.statistics?.[cat];
                if (stats && stats['2025']) {
                    const total2025 = stats['2025'].total;
                    const total2024 = stats['2024']?.total || 0;
                    const change = total2024 > 0 ? ((total2025 - total2024) / total2024 * 100).toFixed(1) : 'N/A';
                    
                    html += `
                    <div class="stat-card">
                        <h3>${cat.replace('_', ' ').toUpperCase()}</h3>
                        <div class="stat-value">${total2025.toLocaleString()}</div>
                        <div style="color: #666;">
                            <div>2024: ${total2024.toLocaleString()}</div>
                            <div style="margin-top: 10px; ${change >= 0 ? 'color: #4CAF50' : 'color: #ff5252'}">
                                ${change !== 'N/A' ? (change >= 0 ? '‚ñ≤ +' : '‚ñº ') + change + '%' : 'Sin datos 2024'}
                            </div>
                        </div>
                    </div>
                    `;
                }
            });
            
            statsEl.innerHTML = html || '<div class="stat-card"><p>No hay estad√≠sticas disponibles</p></div>';
        }
        
        function renderChart() {
            const ctx = document.getElementById('chart');
            if (!ctx || !dashboardData) return;
            
            // Destruir gr√°fico anterior
            if (chart) {
                chart.destroy();
            }
            
            const categories = ['egresos_hospitalarios', 'urgencias'];
            const labels = ['Egresos', 'Urgencias'];
            const data2024 = categories.map(cat => dashboardData.statistics?.[cat]?.['2024']?.total || 0);
            const data2025 = categories.map(cat => dashboardData.statistics?.[cat]?.['2025']?.total || 0);
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '2024',
                            data: data2024,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)'
                        },
                        {
                            label: '2025',
                            data: data2025,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Comparativa 2024 vs 2025'
                        }
                    }
                }
            });
        }
        
        function renderTables() {
            const tablesEl = document.getElementById('tables');
            if (!tablesEl || !dashboardData) return;
            
            let html = '';
            
            // Mostrar solo egresos hospitalarios y urgencias por defecto
            const showCategories = ['egresos_hospitalarios', 'urgencias'];
            
            showCategories.forEach(cat => {
                const data2025 = dashboardData.sections?.[cat]?.['2025'];
                if (data2025 && data2025.length > 0) {
                    html += `
                    <div style="margin-bottom: 30px;">
                        <h3>${cat.replace('_', ' ').toUpperCase()} - 2025 (Top 10)</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Diagn√≥stico</th>
                                    <th>Volumen</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data2025.slice(0, 10).map(item => `
                                    <tr>
                                        <td>${item.orden}</td>
                                        <td>${item.causa.substring(0, 60)}${item.causa.length > 60 ? '...' : ''}</td>
                                        <td><strong>${item.volumen.toLocaleString()}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    `;
                }
            });
            
            tablesEl.innerHTML = html || '<p>No hay datos para mostrar</p>';
        }
        
        function renderRawData() {
            const rawEl = document.getElementById('raw-data');
            if (rawEl && dashboardData) {
                rawEl.textContent = JSON.stringify(dashboardData, null, 2);
            }
        }
        
        // Datos de ejemplo para emergencias
        function loadSampleData() {
            console.log('Cargando datos de ejemplo...');
            
            dashboardData = {
                sections: {
                    egresos_hospitalarios: {
                        '2025': [
                            { orden: 1, causa: "166 Traumatismos, envenenamientos y algunas otras consecuencias de causas externas", volumen: 272 },
                            { orden: 2, causa: "160 Causas obst√©tricas directas, excepto aborto y parto √∫nico espont√°neo (solo morbilidad)", volumen: 253 }
                        ]
                    },
                    urgencias: {
                        '2025': [
                            { orden: 1, causa: "166 Traumatismos, envenenamientos y algunas otras consecuencias de causas externas", volumen: 1924 },
                            { orden: 2, causa: "179 Supervisi√≥n de embarazo normal", volumen: 1162 }
                        ]
                    }
                },
                statistics: {
                    egresos_hospitalarios: {
                        '2025': { total: 525, count: 2 }
                    },
                    urgencias: {
                        '2025': { total: 3086, count: 2 }
                    }
                }
            };
            
            renderStats();
            renderChart();
            renderTables();
            renderRawData();
            
            document.getElementById('loading').style.display = 'none';
            showMessage('‚ö†Ô∏è Mostrando datos de ejemplo. Los datos reales no se pudieron cargar.', 'error');
            updateStatus('üü° Modo demostraci√≥n');
        }
    </script>
</body>
</html>