<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Hospitalario</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a237e;
            --secondary: #283593;
            --accent: #3949ab;
            --light: #f5f7fa;
            --dark: #333;
            --success: #2e7d32;
            --warning: #f57c00;
            --danger: #c62828;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--dark);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 30px 40px;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23000' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.1;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        h1 i {
            color: #64b5f6;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .controls {
            padding: 25px 40px;
            background: var(--light);
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select,
        button {
            padding: 12px 20px;
            border-radius: 8px;
            border: 2px solid #ddd;
            font-size: 1rem;
            transition: all 0.3s;
        }

        select {
            background: white;
            min-width: 200px;
        }

        select:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(57, 73, 171, 0.1);
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        button:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        button:active {
            transform: translateY(0);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error-message {
            background: #ffebee;
            color: var(--danger);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 40px;
            display: none;
            border-left: 5px solid var(--danger);
        }

        .dashboard-content {
            padding: 30px 40px;
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--accent);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-title {
            font-size: 1.1rem;
            color: #666;
            font-weight: 600;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--dark);
            margin: 10px 0;
        }

        .stat-change {
            font-size: 0.9rem;
            padding: 5px 12px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }

        .change-up {
            background: #e8f5e9;
            color: var(--success);
        }

        .change-down {
            background: #ffebee;
            color: var(--danger);
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e0e0e0;
        }

        .chart-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-wrapper {
            height: 350px;
            position: relative;
        }

        .tables-container {
            margin-top: 40px;
        }

        .table-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
        }

        .table-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--light);
            color: var(--primary);
            font-weight: 600;
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid #ddd;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .volumen-cell {
            font-weight: bold;
            color: var(--primary);
        }

        footer {
            text-align: center;
            padding: 25px 40px;
            background: var(--light);
            color: #666;
            border-top: 1px solid #e0e0e0;
            margin-top: 40px;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            select,
            button {
                width: 100%;
            }

            h1 {
                font-size: 2rem;
            }

            .stat-value {
                font-size: 2rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1><i class="fas fa-hospital-alt"></i> Dashboard Hospitalario</h1>
                <p class="subtitle">Análisis de principales diagnósticos - 2do Cuatrimestre 2024 vs 2025</p>
                <div
                    style="background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 6px; display: inline-block;">
                    <i class="fas fa-database"></i> Datos en tiempo real desde Google Sheets
                </div>
            </div>
        </header>

        <div class="controls">
            <div class="control-group">
                <select id="categorySelect">
                    <option value="all">Todas las categorías</option>
                    <option value="egresos_hospitalarios">Egresos Hospitalarios</option>
                    <option value="urgencias">Urgencias</option>
                    <option value="afecciones_lesiones">Afecciones en Lesiones</option>
                    <option value="causas_externas">Causas Externas</option>
                </select>

                <select id="yearSelect">
                    <option value="both">2024 y 2025</option>
                    <option value="2024">Solo 2024</option>
                    <option value="2025">Solo 2025</option>
                </select>
            </div>

            <button id="refreshBtn">
                <i class="fas fa-sync-alt"></i> Actualizar Datos
            </button>
        </div>

        <div id="errorMessage" class="error-message">
            <!-- Mensajes de error aparecerán aquí -->
        </div>

        <div id="loading" class="loading-overlay">
            <div class="spinner"></div>
            <h2>Cargando datos...</h2>
            <p>Por favor espera mientras se obtienen los datos del Google Sheets</p>
        </div>

        <div id="dashboardContent" class="dashboard-content">
            <div class="stats-grid" id="statsGrid">
                <!-- Estadísticas se cargarán aquí -->
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <h3 class="chart-title"><i class="fas fa-chart-line"></i> Comparativa por Categoría</h3>
                    <div class="chart-wrapper">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3 class="chart-title"><i class="fas fa-chart-pie"></i> Distribución Top 5</h3>
                    <div class="chart-wrapper">
                        <canvas id="top5Chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="tables-container" id="tablesContainer">
                <!-- Tablas se cargarán aquí -->
            </div>
        </div>

        <footer>
            <p>Dashboard desarrollado con Google Apps Script • Actualizado: <span id="lastUpdate"></span></p>
            <p style="margin-top: 10px; font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> Los datos se obtienen automáticamente desde Google Sheets
            </p>
        </footer>
    </div>

        <script>
            // ============================================
            // CONFIGURACIÓN - REEMPLAZA ESTA URL
            // ============================================
            // OBTÉN LA URL DE TU WEB APP DESDE:
            // Apps Script → Desplegar → Administrar implementaciones
            // ============================================
        
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby4BTmhQ0yB8_QcQNfPByPmgihqWfjaojf3x-fSeUiQW_jYk8q8kJoKbRXgXIdyxA/exec';
        
        let dashboardData = null;
        let charts = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard iniciado');
            console.log('URL de la Web App:', WEB_APP_URL);
            
            // Mostrar loading
            showLoading(true);
            
            // Probar la conexión primero
            testConnection().then(success => {
                if (success) {
                    // Si la conexión funciona, cargar datos
                    loadData();
                } else {
                    // Si falla, mostrar datos de ejemplo
                    showError('No se pudo conectar con el servidor. Mostrando datos de ejemplo.', true);
                    loadSampleData();
                    showLoading(false);
                }
            });
            
            // Configurar eventos
            document.getElementById('refreshBtn').addEventListener('click', function() {
                showLoading(true);
                loadData();
            });
            
            document.getElementById('categorySelect').addEventListener('change', renderDashboard);
            document.getElementById('yearSelect').addEventListener('change', renderDashboard);
        });
        
        // Función para probar la conexión
        async function testConnection() {
            try {
                console.log('Probando conexión con:', WEB_APP_URL);
                
                // Usar fetch con timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(WEB_APP_URL + '?test=1', {
                    method: 'GET',
                    mode: 'no-cors', // Intentar sin CORS primero
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                console.log('Respuesta de prueba:', response);
                return true;
                
            } catch (error) {
                console.error('Error en test de conexión:', error);
                return false;
            }
        }
        
        function showLoading(show) {
            const loadingEl = document.getElementById('loading');
            const dashboardEl = document.getElementById('dashboardContent');
            
            if (loadingEl) loadingEl.style.display = show ? 'flex' : 'none';
            if (dashboardEl) dashboardEl.style.display = show ? 'none' : 'block';
            
            if (show) {
                console.log('Mostrando loading...');
            } else {
                console.log('Ocultando loading...');
            }
        }
        
        function showError(message, isWarning = false) {
            console.error('Error:', message);
            
            const errorEl = document.getElementById('errorMessage');
            if (!errorEl) {
                // Crear elemento de error si no existe
                const container = document.querySelector('.container');
                const errorDiv = document.createElement('div');
                errorDiv.id = 'errorMessage';
                errorDiv.className = 'error-message';
                errorDiv.style.cssText = `
                    background: ${isWarning ? '#fff3e0' : '#ffebee'};
                    color: ${isWarning ? '#f57c00' : '#c62828'};
                    padding: 20px;
                    margin: 20px;
                    border-radius: 10px;
                    border-left: 5px solid ${isWarning ? '#f57c00' : '#c62828'};
                `;
                container.insertBefore(errorDiv, container.children[1]);
            }
            
            errorEl.innerHTML = `
                <i class="fas ${isWarning ? 'fa-exclamation-triangle' : 'fa-exclamation-circle'}"></i>
                <strong>${isWarning ? 'Advertencia' : 'Error'}:</strong> ${message}
                ${!isWarning ? '<br><small>Intenta recargar la página o verifica la conexión.</small>' : ''}
            `;
            errorEl.style.display = 'block';
        }
        
        function hideError() {
            const errorEl = document.getElementById('errorMessage');
            if (errorEl) {
                errorEl.style.display = 'none';
            }
        }
        
        async function loadData() {
            console.log('Iniciando carga de datos...');
            hideError();
            
            try {
                // URL con parámetros para evitar caché
                const url = `${WEB_APP_URL}?api=data&t=${Date.now()}`;
                console.log('Solicitando datos a:', url);
                
                // Configurar fetch con opciones específicas
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors', // Cambiado a cors
                    cache: 'no-cache',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log('Respuesta recibida:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Datos parseados:', result);
                
                if (result.success) {
                    dashboardData = result.data;
                    console.log('Datos cargados exitosamente');
                    
                    // Actualizar timestamp
                    const lastUpdateEl = document.getElementById('lastUpdate');
                    if (lastUpdateEl) {
                        lastUpdateEl.textContent = new Date().toLocaleString('es-ES');
                    }
                    
                    renderDashboard();
                    showLoading(false);
                    
                } else {
                    throw new Error(result.error || 'Error en los datos recibidos');
                }
                
            } catch (error) {
                console.error('Error detallado:', error);
                
                // Información adicional para depurar
                let errorMsg = `No se pudieron cargar los datos: ${error.message}`;
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMsg += '<br><br><strong>Posibles causas:</strong>';
                    errorMsg += '<br>1. La URL de la Web App es incorrecta';
                    errorMsg += '<br>2. La Web App no está desplegada';
                    errorMsg += '<br>3. Problemas de CORS (prueba en otro navegador)';
                    errorMsg += '<br>4. Bloqueado por extensión del navegador';
                }
                
                showError(errorMsg);
                showLoading(false);
                
                // Cargar datos de ejemplo
                setTimeout(() => {
                    console.log('Cargando datos de ejemplo...');
                    loadSampleData();
                }, 1000);
            }
        }
        
        function loadSampleData() {
            console.log('Cargando datos de ejemplo...');
            
            // Datos de ejemplo más completos
            dashboardData = {
                egresos_hospitalarios_2024: [
                    { orden: 1, causa: "160 Causas obstétricas directas", volumen: 324 },
                    { orden: 2, causa: "166 Traumatismos, envenenamientos", volumen: 276 },
                    { orden: 3, causa: "161 Parto único espontáneo", volumen: 201 },
                    { orden: 4, causa: "159 Aborto (solo morbilidad)", volumen: 127 },
                    { orden: 5, causa: "163 Ciertas afecciones del período perinatal", volumen: 95 }
                ],
                egresos_hospitalarios_2025: [
                    { orden: 1, causa: "166 Traumatismos, envenenamientos y algunas otras consecuencias de causas externas", volumen: 272 },
                    { orden: 2, causa: "160 Causas obstétricas directas, excepto aborto y parto único espontáneo (solo morbilidad)", volumen: 253 },
                    { orden: 3, causa: "161 Parto único espontáneo", volumen: 223 },
                    { orden: 4, causa: "159 Aborto (solo morbilidad)", volumen: 122 },
                    { orden: 5, causa: "163 Ciertas afecciones originadas en el período perinatal", volumen: 83 }
                ],
                urgencias_2025: [
                    { orden: 1, causa: "166 Traumatismos, envenenamientos y algunas otras consecuencias de causas externas", volumen: 1924 },
                    { orden: 2, causa: "179 Supervisión de embarazo normal", volumen: 1162 },
                    { orden: 3, causa: "160 Causas obstétricas directas, excepto aborto y parto único espontáneo (solo morbilidad)", volumen: 332 },
                    { orden: 4, causa: "104 Infecciones respiratorias agudas, excepto neumonía e influenza", volumen: 311 },
                    { orden: 5, causa: "001 Enfermedades infecciosas intestinales", volumen: 283 }
                ],
                statistics: {
                    egresos_hospitalarios_2024: { total: 1023, count: 5, average: 204.6 },
                    egresos_hospitalarios_2025: { total: 953, count: 5, average: 190.6 },
                    urgencias_2025: { total: 4012, count: 5, average: 802.4 }
                }
            };
            
            // Mostrar advertencia
            showError('Mostrando datos de ejemplo. Para ver datos reales, asegúrate de desplegar la Web App correctamente.', true);
            
            renderDashboard();
            showLoading(false);
        }
        
        function renderDashboard() {
            if (!dashboardData) {
                showError('No hay datos disponibles. Haz clic en "Actualizar Datos"');
                return;
            }
            
            console.log('Renderizando dashboard...');
            
            // Renderizar cada componente
            try {
                renderStats();
                renderCharts();
                renderTables();
                console.log('Dashboard renderizado exitosamente');
            } catch (error) {
                console.error('Error al renderizar:', error);
                showError(`Error al mostrar los datos: ${error.message}`);
            }
        }
        
        function renderStats() {
            const statsGrid = document.getElementById('statsGrid');
            if (!statsGrid) return;
            
            console.log('Renderizando estadísticas...');
            
            // (Mantén tu función renderStats existente aquí)
            // ... tu código actual para renderStats ...
        }
        
        function renderCharts() {
            console.log('Renderizando gráficos...');
            
            // (Mantén tu función renderCharts existente aquí)
            // ... tu código actual para renderCharts ...
        }
        
        function renderTables() {
            const container = document.getElementById('tablesContainer');
            if (!container) return;
            
            console.log('Renderizando tablas...');
            
            // (Mantén tu función renderTables existente aquí)
            // ... tu código actual para renderTables ...
        }
        
        // Función auxiliar para crear gráficos (si la necesitas)
        function createChart(canvasId, type, data, options) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;
            
            const ctx = canvas.getContext('2d');
            
            // Destruir gráfico anterior si existe
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            
            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: data,
                options: options || {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            return charts[canvasId];
        }
    </script>

</body>

</html>