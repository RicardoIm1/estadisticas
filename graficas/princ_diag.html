<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Hospitalario</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a237e;
            --secondary: #283593;
            --success: #2e7d32;
            --warning: #f57c00;
            --danger: #c62828;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
        }
        
        .controls {
            padding: 25px 40px;
            background: #f8f9fa;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        button:hover {
            background: var(--secondary);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(26, 35, 126, 0.3);
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            display: none;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(26, 35, 126, 0.1);
            border-top: 6px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: var(--danger);
            color: white;
            padding: 25px 40px;
            margin: 20px 40px;
            border-radius: 15px;
            display: none;
        }
        
        .warning {
            background: var(--warning);
            color: white;
            padding: 25px 40px;
            margin: 20px 40px;
            border-radius: 15px;
            display: none;
        }
        
        .dashboard-content {
            padding: 40px;
            display: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .stat-value {
            font-size: 3rem;
            font-weight: 800;
            color: #333;
            margin: 15px 0;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
        }
        
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
        }
        
        .chart-wrapper {
            height: 400px;
            position: relative;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            color: var(--primary);
            font-weight: 600;
        }
        
        footer {
            padding: 30px 40px;
            background: #f8f9fa;
            color: #666;
            text-align: center;
            border-top: 1px solid #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-hospital-alt"></i> Dashboard Hospitalario</h1>
            <p>Datos del 2do Cuatrimestre 2024 vs 2025</p>
        </header>
        
        <div class="controls">
            <button id="loadDataBtn">
                <i class="fas fa-sync-alt"></i> Cargar Datos Reales
            </button>
            <button id="testConnectionBtn">
                <i class="fas fa-plug"></i> Probar Conexi√≥n
            </button>
            <button onclick="window.open('https://script.google.com/macros/s/AKfycbz95-Kf5U2dYICNanlUacOWWcyxykRVOLNp08vsvpnEEk5IokN1Q8zL6LlukKfjYSc/exec?api=data', '_blank')">
                <i class="fas fa-code"></i> Ver Datos JSON
            </button>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <h2>Cargando datos...</h2>
            <p>Conectando con Google Sheets</p>
        </div>
        
        <div id="errorMessage" class="error"></div>
        <div id="warningMessage" class="warning"></div>
        
        <div id="dashboardContent" class="dashboard-content">
            <div class="stats-grid" id="statsGrid"></div>
            
            <div class="charts-container">
                <div class="chart-card">
                    <h3><i class="fas fa-chart-line"></i> Comparativa 2024 vs 2025</h3>
                    <div class="chart-wrapper">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3><i class="fas fa-chart-pie"></i> Top 5 Diagn√≥sticos 2025</h3>
                    <div class="chart-wrapper">
                        <canvas id="top5Chart"></canvas>
                    </div>
                </div>
            </div>
            
            <div id="tablesContainer"></div>
        </div>
        
        <footer>
            <p>Conectado a: <strong id="currentUrl">https://script.google.com/macros/s/AKfycbz95-Kf5U2dYICNanlUacOWWcyxykRVOLNp08vsvpnEEk5IokN1Q8zL6LlukKfjYSc/exec</strong></p>
            <p>Actualizado: <span id="lastUpdate">--:--</span></p>
        </footer>
    </div>

    <script>
        // ============================================
        // URL QUE S√ç FUNCIONA - USAR ESTA
        // ============================================
        const WORKING_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz95-Kf5U2dYICNanlUacOWWcyxykRVOLNp08vsvpnEEk5IokN1Q8zL6LlukKfjYSc/exec';
        // ============================================
        
        let dashboardData = null;
        let charts = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Dashboard inicializado');
            console.log('‚úÖ Usando URL verificada:', WORKING_WEB_APP_URL);
            
            document.getElementById('currentUrl').textContent = WORKING_WEB_APP_URL;
            
            // Configurar eventos
            document.getElementById('loadDataBtn').addEventListener('click', loadData);
            document.getElementById('testConnectionBtn').addEventListener('click', testConnection);
            
            // Cargar datos autom√°ticamente
            setTimeout(loadData, 1000);
        });
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('dashboardContent').style.display = show ? 'none' : 'block';
        }
        
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.innerHTML = `
                <h3><i class="fas fa-exclamation-circle"></i> Error</h3>
                <p>${message}</p>
            `;
            errorEl.style.display = 'block';
            document.getElementById('warningMessage').style.display = 'none';
        }
        
        function showWarning(message) {
            const warningEl = document.getElementById('warningMessage');
            warningEl.innerHTML = `
                <h3><i class="fas fa-exclamation-triangle"></i> Advertencia</h3>
                <p>${message}</p>
            `;
            warningEl.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }
        
        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('warningMessage').style.display = 'none';
        }
        
        function testConnection() {
            console.log('üîó Probando conexi√≥n...');
            showLoading(true);
            hideMessages();
            
            // Crear iframe para probar
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = WORKING_WEB_APP_URL + '?api=data';
            
            iframe.onload = function() {
                console.log('‚úÖ Conexi√≥n exitosa');
                showLoading(false);
                showWarning('‚úÖ Conexi√≥n establecida correctamente. Ahora carga los datos.');
            };
            
            iframe.onerror = function() {
                console.error('‚ùå Error de conexi√≥n');
                showLoading(false);
                showError('No se pudo conectar. Verifica la URL o tu conexi√≥n a internet.');
            };
            
            document.body.appendChild(iframe);
            
            setTimeout(() => {
                if (document.body.contains(iframe)) {
                    document.body.removeChild(iframe);
                }
            }, 5000);
        }
        
        function loadData() {
            console.log('üì• Cargando datos...');
            showLoading(true);
            hideMessages();
            
            // Usar el m√©todo SEGURO que siempre funciona
            loadDataWithIframe();
        }
        
        function loadDataWithIframe() {
            console.log('üîÑ Usando m√©todo iframe seguro...');
            
            // Crear iframe oculto
            const iframeId = 'dataLoader-' + Date.now();
            const iframe = document.createElement('iframe');
            iframe.id = iframeId;
            iframe.style.display = 'none';
            iframe.src = WORKING_WEB_APP_URL + '?api=data&format=json&t=' + Date.now();
            
            // Configurar para recibir mensajes
            window.addEventListener('message', function(event) {
                // Solo procesar mensajes de nuestro iframe
                if (event.source === iframe.contentWindow) {
                    console.log('üì® Mensaje recibido:', event.data);
                    
                    try {
                        const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                        
                        if (data && data.success) {
                            dashboardData = data.data;
                            console.log('‚úÖ Datos recibidos correctamente');
                            processSuccessfulData();
                        } else {
                            throw new Error(data?.error || 'Error en los datos');
                        }
                    } catch (error) {
                        console.error('‚ùå Error procesando datos:', error);
                        showError(`Error: ${error.message}`);
                        loadSampleData();
                    }
                }
            });
            
            iframe.onload = function() {
                console.log('‚úÖ Iframe cargado');
                
                // Intentar extraer datos del iframe
                setTimeout(() => {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        const iframeContent = iframeDoc.body.textContent;
                        
                        if (iframeContent) {
                            const data = JSON.parse(iframeContent);
                            if (data.success) {
                                dashboardData = data.data;
                                processSuccessfulData();
                                return;
                            }
                        }
                    } catch (e) {
                        console.warn('No se pudieron extraer datos del iframe:', e);
                    }
                    
                    // Si llegamos aqu√≠, usar sample data
                    showWarning('No se pudieron cargar datos en tiempo real. Mostrando datos de ejemplo.');
                    loadSampleData();
                    
                }, 3000);
            };
            
            iframe.onerror = function() {
                console.error('‚ùå Error cargando iframe');
                showError('Error de conexi√≥n. Mostrando datos de ejemplo.');
                loadSampleData();
            };
            
            document.body.appendChild(iframe);
            
            // Timeout
            setTimeout(() => {
                const loadedIframe = document.getElementById(iframeId);
                if (loadedIframe && document.body.contains(loadedIframe)) {
                    document.body.removeChild(loadedIframe);
                }
                
                if (!dashboardData) {
                    console.warn('‚è±Ô∏è Timeout - Usando datos de ejemplo');
                    showWarning('Timeout en la conexi√≥n. Mostrando datos de ejemplo.');
                    loadSampleData();
                }
            }, 10000);
        }
        
        function processSuccessfulData() {
            console.log('üéâ Procesando datos exitosos');
            
            // Actualizar timestamp
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `${now.toLocaleDateString('es-ES')} ${now.toLocaleTimeString('es-ES')}`;
            
            // Renderizar dashboard
            renderDashboard();
            showLoading(false);
            hideMessages();
            
            console.log('‚úÖ Dashboard actualizado con datos reales');
        }
        
        function loadSampleData() {
            console.log('üìã Cargando datos de ejemplo');
            
            dashboardData = {
                sections: {
                    egresos_hospitalarios: {
                        '2024': [
                            { orden: 1, causa: "160 Causas obst√©tricas directas, excepto aborto y parto √∫nico espont√°neo (solo morbilidad)", volumen: 324 },
                            { orden: 2, causa: "166 Traumatismos, envenenamientos y algunas otras consecuencias de causas externas", volumen: 276 }
                        ],
                        '2025': [
                            { orden: 1, causa: "166 Traumatismos, envenenamientos y algunas otras consecuencias de causas externas", volumen: 272 },
                            { orden: 2, causa: "160 Causas obst√©tricas directas, excepto aborto y parto √∫nico espont√°neo (solo morbilidad)", volumen: 253 }
                        ]
                    },
                    urgencias: {
                        '2024': [
                            { orden: 1, causa: "166 Traumatismos, envenenamientos y algunas otras consecuencias de causas externas", volumen: 2018 },
                            { orden: 2, causa: "179 Supervisi√≥n de embarazo normal", volumen: 1293 }
                        ],
                        '2025': [
                            { orden: 1, causa: "166 Traumatismos, envenenamientos y algunas otras consecuencias de causas externas", volumen: 1924 },
                            { orden: 2, causa: "179 Supervisi√≥n de embarazo normal", volumen: 1162 }
                        ]
                    }
                },
                statistics: {
                    egresos_hospitalarios: {
                        '2024': { total: 600, count: 2, topCause: "Causas obst√©tricas directas", topVolume: 324 },
                        '2025': { total: 525, count: 2, topCause: "Traumatismos, envenenamientos", topVolume: 272 }
                    },
                    urgencias: {
                        '2024': { total: 3311, count: 2, topCause: "Traumatismos, envenenamientos", topVolume: 2018 },
                        '2025': { total: 3086, count: 2, topCause: "Traumatismos, envenenamientos", topVolume: 1924 }
                    }
                }
            };
            
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `${now.toLocaleDateString('es-ES')} ${now.toLocaleTimeString('es-ES')} (Ejemplo)`;
            
            renderDashboard();
            showLoading(false);
            showWarning('‚ö†Ô∏è Mostrando datos de ejemplo. Para ver datos reales, aseg√∫rate de que la Web App est√© correctamente desplegada.');
        }
        
        function renderDashboard() {
            if (!dashboardData) return;
            
            console.log('üé® Renderizando dashboard...');
            
            renderStats();
            renderCharts();
            renderTables();
            
            console.log('‚úÖ Dashboard renderizado');
        }
        
        function renderStats() {
            const statsGrid = document.getElementById('statsGrid');
            if (!statsGrid) return;
            
            const categories = [
                { key: 'egresos_hospitalarios', name: 'Egresos Hospitalarios', icon: 'fas fa-procedures' },
                { key: 'urgencias', name: 'Urgencias', icon: 'fas fa-ambulance' }
            ];
            
            let html = '';
            
            categories.forEach(cat => {
                const stats = dashboardData.statistics?.[cat.key];
                
                if (stats && stats['2025'] && stats['2024']) {
                    const total2025 = stats['2025'].total;
                    const total2024 = stats['2024'].total;
                    const change = ((total2025 - total2024) / total2024 * 100).toFixed(1);
                    
                    html += `
                    <div class="stat-card">
                        <h3><i class="${cat.icon}"></i> ${cat.name}</h3>
                        <div class="stat-value">${total2025.toLocaleString()}</div>
                        <div style="color: #666;">
                            <div><strong>2024:</strong> ${total2024.toLocaleString()}</div>
                            <div style="margin-top: 10px; ${parseFloat(change) >= 0 ? 'color: #2e7d32' : 'color: #c62828'}">
                                ${parseFloat(change) >= 0 ? 'üìà +' : 'üìâ '}${change}%
                            </div>
                        </div>
                    </div>
                    `;
                }
            });
            
            statsGrid.innerHTML = html;
        }
        
        function renderCharts() {
            // Destruir gr√°ficos anteriores
            if (charts.comparison) charts.comparison.destroy();
            if (charts.top5) charts.top5.destroy();
            
            // Gr√°fico de comparaci√≥n
            const comparisonCtx = document.getElementById('comparisonChart');
            if (comparisonCtx) {
                const categories = ['egresos_hospitalarios', 'urgencias'];
                const labels = ['Egresos', 'Urgencias'];
                const data2024 = categories.map(cat => dashboardData.statistics?.[cat]?.['2024']?.total || 0);
                const data2025 = categories.map(cat => dashboardData.statistics?.[cat]?.['2025']?.total || 0);
                
                charts.comparison = new Chart(comparisonCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '2024',
                                data: data2024,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)'
                            },
                            {
                                label: '2025',
                                data: data2025,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Gr√°fico de top 5
            const top5Ctx = document.getElementById('top5Chart');
            if (top5Ctx && dashboardData.sections?.egresos_hospitalarios?.['2025']) {
                const top5 = dashboardData.sections.egresos_hospitalarios['2025'].slice(0, 5);
                
                if (top5.length > 0) {
                    charts.top5 = new Chart(top5Ctx, {
                        type: 'pie',
                        data: {
                            labels: top5.map(item => `#${item.orden}: ${item.causa.substring(0, 20)}...`),
                            datasets: [{
                                data: top5.map(item => item.volumen),
                                backgroundColor: ['#1a237e', '#283593', '#303f9f', '#3949ab', '#5c6bc0']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }
            }
        }
        
        function renderTables() {
            const container = document.getElementById('tablesContainer');
            if (!container) return;
            
            let html = '<h2 style="margin-bottom: 20px;"><i class="fas fa-table"></i> Datos Detallados</h2>';
            
            // Mostrar egresos hospitalarios
            const egresos2025 = dashboardData.sections?.egresos_hospitalarios?.['2025'];
            if (egresos2025 && egresos2025.length > 0) {
                html += `
                <h3>üè• Egresos Hospitalarios 2025</h3>
                <table>
                    <thead>
                        <tr><th>#</th><th>Diagn√≥stico</th><th>Volumen</th></tr>
                    </thead>
                    <tbody>
                        ${egresos2025.slice(0, 10).map(item => `
                            <tr>
                                <td><strong>${item.orden}</strong></td>
                                <td>${item.causa}</td>
                                <td><strong>${item.volumen.toLocaleString()}</strong></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                `;
            }
            
            // Mostrar urgencias
            const urgencias2025 = dashboardData.sections?.urgencias?.['2025'];
            if (urgencias2025 && urgencias2025.length > 0) {
                html += `
                <h3 style="margin-top: 40px;">üöë Urgencias 2025</h3>
                <table>
                    <thead>
                        <tr><th>#</th><th>Diagn√≥stico</th><th>Volumen</th></tr>
                    </thead>
                    <tbody>
                        ${urgencias2025.slice(0, 10).map(item => `
                            <tr>
                                <td><strong>${item.orden}</strong></td>
                                <td>${item.causa}</td>
                                <td><strong>${item.volumen.toLocaleString()}</strong></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                `;
            }
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>