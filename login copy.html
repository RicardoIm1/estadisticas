<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estad√≠sticas y Archivo Cl√≠nico</title>
  <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
  <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="/estadisticas/main_css/login.css" rel="stylesheet">
</head>
<style>
  .efemerides-lista ul li {
    text-decoration: none;
  }
</style>

<body>
  <!-- ///////// -->
  <!-- Despu√©s del formulario y antes del footer -->
  <div class="gaceta-container">
    <!-- <h3 class="gaceta-title">
      <i class="fas fa-newspaper"></i> √öltimas Noticias
    </h3> -->

    <div class="anuncios-lista">

      <div class="anuncio-item" id="efemerides-tile">
        <!--  <h3><i class="fa-solid fa-calendar-day"></i></h3> -->
        <!-- <h4>Efem√©rides de salud</h4> -->
        <ul id="efemerides-lista"></ul>
      </div>

      <div class="anuncio-item">
        <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
        <h3>¬°EL LAVADO DE MANOS ES IMPORTANTE!</h3>
      </div>

      <a href="https://drive.google.com/file/d/1PA_VC3IHTQp6hr2cC8B3uCBZPM2oJ5e4/view?usp=sharing" target="_blank"
        style="text-decoration: none; color: inherit;">
        <div class="anuncio-item">
          <i class="fas fa-calendar-check" aria-hidden="true"></i>
          <h3 class="color: var(fa-calendar-check)">Recordatorio: Cierre estad√≠stico mensual el d√≠a...</h3>
        </div>
      </a>

      <a href="http://www.dgis.salud.gob.mx/descargas/cemece/CEMECE_AUXCOD_2_2025.pdf" target="_blank"
        style="text-decoration: none; color: inherit;">
        <div class="anuncio-item">
          <i class="fas fa-calendar-check" aria-hidden="true"></i>
          <h3 class="color: rgb(0, 255, 89);">AUXILIAR DE CODIFICACI√ìN CEMECE 2025</h3>
        </div>
      </a>


      <div class="anuncio-item">
        <i class="fas fa-head-side-mask" aria-hidden="true"></i>
        <p>Recordatorio: Usa el cubrebocas y pide a los dem√°s que tambi√©n lo usen</p>
      </div>

      <!-- <div class="anuncio-item">
        <i class="fas fa-star" aria-hidden="true"></i>
        <p>¬°Felicitaciones al equipo de Estad√≠sticas por sus indicadores!</p>
      </div>

      <div class="anuncio-item">
        <i class="fas fa-star" aria-hidden="true"></i>
        <p>¬°Felicitaciones al equipo de Archivo Cl√≠nico por sus indicadores!</p>
      </div> -->
    </div>
  </div>

  <style>
    /* ESTILOS MEJORADOS PARA LA GACETA LATERAL */
    .gaceta-container {
      position: fixed;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      width: 320px;
      max-height: 85vh;
      overflow-y: auto;
      /* background: rgba(255, 255, 255, 0.1); */
      /* backdrop-filter: blur(15px); */
      /* box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25); */
      border-radius: 20px;
      padding: 25px;
      z-index: 100;
    }

    .gaceta-title {
      font-size: 1.4rem;
      margin-bottom: 20px;
      color: #fff;
      text-align: center;
      padding-bottom: 15px;
      border-bottom: 2px solid #4ecdc4;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-weight: 600;
    }

    .gaceta-title i {
      color: #4ecdc4;
      font-size: 1.6rem;
    }

    .anuncios-lista {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .anuncio-item {
      display: flex;
      align-items: flex-start;
      gap: 15px;
      padding: 18px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      /*border-left: 4px solid #4ecdc4;*/
      transition: all 0.3s ease;
    }

    .anuncio-item:hover {
      background: rgba(255, 255, 255, 0.12);
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .anuncio-item i {
      color: #4ecdc4;
      font-size: 1.3rem;
      min-width: 24px;
      margin-top: 3px;
    }

    .anuncio-item p {
      margin: 0;
      color: #f0f0f0;
      font-size: 1rem;
      line-height: 1.5;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    /* Scrollbar personalizado */
    .gaceta-container::-webkit-scrollbar {
      width: 6px;
    }

    .gaceta-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .gaceta-container::-webkit-scrollbar-thumb {
      background: #4ecdc4;
      border-radius: 10px;
    }

    /* MEDIA QUERIES - OCULTAR EN DISPOSITIVOS PEQUE√ëOS */
    @media (max-width: 1024px) {
      .gaceta-container {
        display: none;
        /* Se oculta completamente en tablets y m√≥viles */
      }

      /* Ajustar el contenedor principal para que ocupe todo el ancho */
      .glass {
        margin: 0 auto;
        width: 90%;
        max-width: 450px;
      }
    }

    /* Para pantallas muy grandes */
    @media (min-width: 1400px) {
      .gaceta-container {
        left: 40px;
        width: 350px;
      }
    }

    /* Para pantallas medianas */
    @media (max-width: 1400px) and (min-width: 1025px) {
      .gaceta-container {
        left: 15px;
        width: 300px;
        padding: 20px;
      }
    }
  </style>

  <!-- ///////// -->

  <div class="glass">
    <div class="header">
      <img class="logo" src="img/logo-hrpv.png" alt="Logo" width="120" />
      <h3>Estad√≠sticas y Archivo Cl√≠nico</h3>
    </div>


    <div id="message"></div>


    <form id="formularioLogin">
      <div class="form-group">
        <label for="username"><i class="fas fa-user"></i> Usuario</label>
        <input type="text" id="usuario" name="usuario" placeholder="ej. r.ramirez" required />
      </div>

      <div class="form-group">
        <label for="password"><i class="fas fa-key"></i> Contrase√±a</label>
        <input type="password" id="clave" name="clave" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
      </div>

      <div class="botones-vertical">
        <button type="submit">
          <i class="fas fa-sign-in-alt"></i> Iniciar sesi√≥n
        </button>
        <button type="reset"><i class="fas fa-broom"></i> Limpiar</button>
      </div>
    </form>

    <footer>
      <p id="footerText">Hecho con ‚ù§Ô∏è por Ricardo ¬∑ 2023</p>
    </footer>
  </div>

  <script>
    // ========== SISTEMA DE ESTADO ==========
    let intensidadUso = 0;
    let respiracionInterval;

    function iniciarRespiracion() {
      const dashboard = document.querySelector(".glass");
      if (!dashboard) return;

      clearInterval(respiracionInterval);

      let fase = 0;
      respiracionInterval = setInterval(() => {
        fase += 0.02;
        const intensidad = Math.min(0.15 + intensidadUso / 80, 0.4);
        const escala = 1 + Math.sin(fase) * intensidad * 0.02;
        dashboard.style.transform = `scale(${escala})`;
      }, 500);
    }

    function setEstado(estado, mensaje = null) {
      const dashboard = document.querySelector(".glass");
      const messageDiv = document.getElementById("message");
      if (!dashboard) return;

      intensidadUso = Math.min(intensidadUso + 1, 10);
      iniciarRespiracion();
      setTimeout(
        () => (intensidadUso = Math.max(intensidadUso - 1, 0)),
        8000
      );

      dashboard.classList.remove("loading", "success", "error");
      dashboard.classList.add(estado);

      if (messageDiv) {
        const iconos = {
          loading:
            '<i class="fas fa-sync fa-spin"></i> Validando credenciales...',
          success: '<i class="fas fa-check-circle"></i> ¬°ACCESO EXITOSO! <br>',
          error: '<i class="fas fa-exclamation-circle"></i> ',
        };
        messageDiv.innerHTML = mensaje
          ? iconos[estado] + mensaje
          : iconos[estado];
        messageDiv.style.color = estado === "error" ? "#f87171" : "white";
        messageDiv.style.opacity = "1";
      }

      if (estado !== "success") {
        setTimeout(() => {
          dashboard.classList.remove("loading", "success", "error");
        }, 5000);
      }
    }
  </script>

  <script>
    // ========== L√ìGICA DEL LOGIN CON JSONP ==========
    document.getElementById(
      "footerText"
    ).innerHTML = `Hecho con ‚ù§Ô∏è por Ricardo ¬∑ ${new Date().getFullYear()}`;

    const form = document.getElementById("formularioLogin");
    const scriptUrl =
      "https://script.google.com/macros/s/AKfycbywX2f0VrdTz2UKXY9u_lX4DwMrVJj-_XHQtjFfT9kx6E_3NsBqhTCqwJ923SzpeRzu/exec";

    // ‚úÖ Funci√≥n global para manejar la respuesta del LOGIN
    window.manejarLogin = function (resultado) {
      console.log("üîç Respuesta REAL de Google Sheets:", resultado);

      // Remover el script despu√©s de usarlo
      const oldScript = document.getElementById("jsonp-script");
      if (oldScript) oldScript.remove();

      /* if (resultado.success) {
        const usuario = document.getElementById("usuario").value;
        setEstado(
          "success",
          `¬°Bienvenido ${usuario}! ( Rol: ${resultado.rol})`
          ); 
          }*/

      if (resultado.success) {
        const usuario = document.getElementById("usuario").value;
        setEstado(
          "success",
          `<br><div>¬°Bienvenido(a)</div><br>
          <div><strong>${usuario}</strong></div><br>
          <div><strong>${resultado.rol || '‚Äî'}</strong></div>`
        );

        // ‚úÖ Guardar sesi√≥n en localStorage
        localStorage.setItem("usuario", usuario);
        localStorage.setItem("rol", resultado.rol);
        localStorage.setItem("loginTime", new Date().getTime());

        setTimeout(() => {
          // Redirigir seg√∫n el rol
          if (resultado.rol === "ADMIN") {
            window.location.href = "/estadisticas/control/";
          } else if (resultado.rol === "CAJA") {
            window.location.href = "/estadisticas/caja/caja.html";
          } else if (resultado.rol === "Lector") {
            window.location.href = "/estadisticas/";
          } else if (resultado.rol === "ESTADISTICAS") {
            window.location.href = "/estadisticas/est/";
          } else if (resultado.rol === "ARCHIVO CLINICO") {
            window.location.href = "/estadisticas/archivo/";
          } else if (resultado.rol === "EPIDEMIOLOGIA") {
            window.location.href = "/estadisticas/epidemio/";
          } else if (resultado.rol === "SUBDIRECCION") {
            window.location.href = "/estadisticas/archivo/h_faltantespp.html";
          } else {
            window.location.href = "/estadisticas/"; // valor por defecto
          }
        }, 2000);
      } else {
        setEstado("error", resultado.error || "Credenciales incorrectas");
        console.error("‚ùå Error de login:", resultado.error);
      }
    };

    // ‚úÖ Funci√≥n global para verificar el servidor
    window.verificarServidorCallback = function (res) {
      console.log("‚úÖ Servidor activo:", res);
      // Remover el script despu√©s de usarlo
      const script = document.getElementById("server-check-script");
      if (script) script.remove();
    };

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      setEstado("loading");

      const usuario = document.getElementById("usuario").value.trim();
      const clave = document.getElementById("clave").value;

      if (!usuario || !clave) {
        setEstado("error", "Usuario y contrase√±a son requeridos");
        return;
      }

      console.log("üì§ Enviando credenciales:", { usuario, clave });

      // ‚úÖ JSONP - Crear script din√°mico (GET)
      const script = document.createElement("script");
      script.id = "jsonp-script";

      // Par√°metros por URL (GET)
      const params = new URLSearchParams({
        usuario: usuario,
        clave: clave,
        callback: "manejarLogin", // ‚úÖ Nombre de funci√≥n global
        ip: "web", // Para logs
      });

      script.src = `${scriptUrl}?${params.toString()}`;
      console.log("üîó URL llamada:", script.src);

      document.head.appendChild(script);

      // Timeout por si falla
      setTimeout(() => {
        const scriptElement = document.getElementById("jsonp-script");
        if (scriptElement) {
          scriptElement.remove();
          setEstado("error", "Timeout - No response from server");
        }
      }, 10000);
    });

    form.addEventListener("reset", () => {
      const messageDiv = document.getElementById("message");
      messageDiv.innerHTML = "";
      messageDiv.style.opacity = "0";
    });

    // ‚úÖ Verificar sesi√≥n existente
    function verificarSesion() {
      const usuario = localStorage.getItem("usuario");
      const loginTime = localStorage.getItem("loginTime");
      const ahora = new Date().getTime();

      // Si hay sesi√≥n y no ha expirado (24 horas)
      if (usuario && loginTime && ahora - loginTime < 24 * 60 * 60 * 1000) {
        console.log("Sesi√≥n activa para:", usuario);
        // Opcional: redirigir autom√°ticamente
        // window.location.href = 'dashboard.html';
      } else {
        // Limpiar sesi√≥n expirada
        localStorage.removeItem("usuario");
        localStorage.removeItem("rol");
        localStorage.removeItem("loginTime");
      }
    }

    // ‚úÖ Verificar servidor al cargar (CORREGIDO)
    function verificarServidor() {
      try {
        const script = document.createElement("script");
        script.id = "server-check-script";
        // ‚úÖ Usar nombre de funci√≥n global, no funci√≥n an√≥nima
        script.src = `${scriptUrl}?callback=verificarServidorCallback`;
        document.head.appendChild(script);

        // Limpiar despu√©s de 3 segundos si no responde
        setTimeout(() => {
          const oldScript = document.getElementById("server-check-script");
          if (oldScript) oldScript.remove();
        }, 3000);
      } catch (error) {
        console.log("‚ùå No se pudo conectar al servidor:", error);
      }
    }

    window.addEventListener("load", function () {
      iniciarRespiracion();
      verificarSesion();
      verificarServidor();
    });

    // ‚úÖ Funci√≥n para cerrar sesi√≥n (usar en otras p√°ginas)
    window.cerrarSesion = function () {
      localStorage.removeItem("usuario");
      localStorage.removeItem("rol");
      localStorage.removeItem("loginTime");
      window.location.href = "/estadisticas/index.html";
    };
    // En tu login.js - Verificar expiraci√≥n de sesi√≥n
    function verificarSesionExpirada() {
      const loginTime = localStorage.getItem('loginTime');
      const ahora = new Date().getTime();
      const horasTranscurridas = (ahora - loginTime) / (1000 * 60 * 60);

      // Expirar despu√©s de 24 horas
      if (horasTranscurridas > 24) {
        localStorage.clear();
        window.location.href = '/estadisticas/index.html';
      }
    }

    // Ejecutar cada hora
    setInterval(verificarSesionExpirada, 60 * 60 * 1000);
  </script>

  <script>
    // Funci√≥n para obtener efem√©rides pr√≥ximas (siguientes 30 d√≠as)
    function getEfemeridesProximas() {
      const fecha = new Date();
      const proximas = [];

      // Crear un array con los objetos de fecha para los pr√≥ximos 30 d√≠as
      for (let i = 1; i <= 30; i++) { // Empezamos desde 1 para excluir el d√≠a actual
        const fechaCheck = new Date();
        fechaCheck.setDate(fecha.getDate() + i);
        const mes = fechaCheck.getMonth();
        const dia = fechaCheck.getDate();

        // Buscar si hay alguna efem√©ride en esta fecha
        const efemeride = efemeridesSalud.find(ef => ef.mes === mes && ef.dia === dia);

        if (efemeride) {
          // Calcular d√≠as faltantes de manera precisa
          const fechaEfemeride = new Date(fecha.getFullYear(), mes, dia);
          const diferenciaTiempo = fechaEfemeride - fecha;
          const diasFaltantes = Math.ceil(diferenciaTiempo / (1000 * 60 * 60 * 24));

          proximas.push({
            ...efemeride,
            fecha: fechaEfemeride,
            diasFaltantes: diasFaltantes,
            mes: mes,
            dia: dia
          });
        }
      }

      // Ordenar por fecha m√°s pr√≥xima
      proximas.sort((a, b) => a.diasFaltantes - b.diasFaltantes);

      return proximas;
    }

    // Funci√≥n para obtener efem√©rides que incluyan tambi√©n el d√≠a actual si aplica
    function getEfemeridesProximasIncluyendoHoy() {
      const fecha = new Date();
      const mesActual = fecha.getMonth();
      const diaActual = fecha.getDate();
      const proximas = [];

      // Verificar si hoy hay alguna efem√©ride
      const efemerideHoy = efemeridesSalud.find(ef => ef.mes === mesActual && ef.dia === diaActual);

      if (efemerideHoy) {
        proximas.push({
          ...efemerideHoy,
          diasFaltantes: 0,
          esHoy: true
        });
      }

      // Buscar en los pr√≥ximos 30 d√≠as (empezando desde 1 para no duplicar hoy)
      for (let i = 1; i <= 30; i++) {
        const fechaCheck = new Date();
        fechaCheck.setDate(fecha.getDate() + i);
        const mes = fechaCheck.getMonth();
        const dia = fechaCheck.getDate();

        const efemeride = efemeridesSalud.find(ef => ef.mes === mes && ef.dia === dia);

        if (efemeride) {
          proximas.push({
            ...efemeride,
            diasFaltantes: i,
            esHoy: false
          });
        }
      }

      return proximas.slice(0, 5); // Mostrar hasta 5 efem√©rides pr√≥ximas
    }

    // Funci√≥n para actualizar el tile con efem√©rides pr√≥ximas
    function actualizarEfemerides() {
      const lista = document.getElementById('efemerides-lista');
      if (!lista) return;

      // Obtener efem√©rides pr√≥ximas (puedes elegir cualquiera de las dos funciones)
      const efemeridesProximas = getEfemeridesProximas(); // Excluye el d√≠a actual
      // const efemeridesProximas = getEfemeridesProximasIncluyendoHoy(); // Incluye el d√≠a actual si hay

      // Limpiar lista actual
      lista.innerHTML = '';

      // Mostrar las efem√©rides pr√≥ximas
      if (efemeridesProximas.length > 0) {
        efemeridesProximas.slice(0, 4).forEach(ef => { // Mostrar hasta 4
          const item = document.createElement('li');
          const diaFormateado = ef.dia.toString().padStart(2, '0');
          const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

          let textoDias = '';
          if (ef.diasFaltantes === 0) {
            textoDias = 'üî¥ HOY';
          } else if (ef.diasFaltantes === 1) {
            textoDias = '‚è∞ MA√ëANA';
          } else {
            textoDias = `üìÖ ${ef.diasFaltantes} d√≠as`;
          }

          item.innerHTML = `${ef.icono} <strong>${diaFormateado} ${meses[ef.mes]}</strong> ‚Äî ${ef.descripcion} <span style="opacity:0.7; font-size:0.8rem;">${textoDias}</span>`;
          lista.appendChild(item);
        });

        // Si hay m√°s de 4, mostrar cu√°ntas faltan
        if (efemeridesProximas.length > 4) {
          const item = document.createElement('li');
          item.style.opacity = '0.7';
          item.style.fontStyle = 'italic';
          item.style.fontSize = '0.8rem';
          item.innerHTML = `‚Üª y ${efemeridesProximas.length - 4} m√°s en los pr√≥ximos 30 d√≠as`;
          lista.appendChild(item);
        }
      } else {
        // Si no hay efem√©rides en los pr√≥ximos 30 d√≠as, mostrar un mensaje
        const item = document.createElement('li');
        item.style.opacity = '0.7';
        item.style.fontStyle = 'italic';
        item.innerHTML = '‚ú® No hay efem√©rides en los pr√≥ximos 30 d√≠as';
        lista.appendChild(item);
      }
    }

    // Tambi√©n puedes crear una versi√≥n que muestre las del mes actual PERO 
    // ordenadas desde el d√≠a actual hacia adelante
    function getEfemeridesMesDesdeHoy() {
      const fecha = new Date();
      const mesActual = fecha.getMonth();
      const diaActual = fecha.getDate();

      // Obtener todas las efem√©rides del mes actual
      const delMes = efemeridesSalud.filter(ef => ef.mes === mesActual);

      // Separar las que ya pasaron y las que est√°n por venir
      const pasadas = delMes.filter(ef => ef.dia < diaActual);
      const futuras = delMes.filter(ef => ef.dia >= diaActual);

      // Ordenar futuras por d√≠a (ascendente) y pasadas por d√≠a (descendente)
      futuras.sort((a, b) => a.dia - b.dia);
      pasadas.sort((a, b) => b.dia - a.dia);

      // Combinar: primero las futuras, luego las pasadas (o viceversa seg√∫n prefieras)
      return [...futuras, ...pasadas];
    }

    // Funci√≥n alternativa que muestra las del mes actual pero destacando las pr√≥ximas
    function actualizarEfemeridesDestacandoProximas() {
      const lista = document.getElementById('efemerides-lista');
      if (!lista) return;

      const fecha = new Date();
      const diaActual = fecha.getDate();
      const efemeridesMes = getEfemeridesMesDesdeHoy();

      lista.innerHTML = '';

      if (efemeridesMes.length > 0) {
        // Mostrar las pr√≥ximas primero (hasta 3)
        const proximas = efemeridesMes.filter(ef => ef.dia >= diaActual).slice(0, 3);
        const pasadas = efemeridesMes.filter(ef => ef.dia < diaActual).slice(0, 2);

        proximas.forEach(ef => {
          const item = document.createElement('li');
          const diaFormateado = ef.dia.toString().padStart(2, '0');
          const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
          const destacado = ef.dia === diaActual ? ' üî¥ HOY' : ef.dia > diaActual ? ' ‚è∞' : '';

          item.innerHTML = `${ef.icono} ${diaFormateado} ${meses[ef.mes]} ‚Äî ${ef.descripcion}${destacado}`;
          if (ef.dia === diaActual) {
            item.style.fontWeight = 'bold';
            item.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            item.style.borderRadius = '4px';
            item.style.padding = '2px 4px';
          }
          lista.appendChild(item);
        });

        // Si hay m√°s efem√©rides pr√≥ximas, indicarlo
        const totalProximas = efemeridesMes.filter(ef => ef.dia >= diaActual).length;
        if (totalProximas > 3) {
          const item = document.createElement('li');
          item.style.opacity = '0.7';
          item.style.fontStyle = 'italic';
          item.style.fontSize = '0.8rem';
          item.innerHTML = `‚Üª y ${totalProximas - 3} m√°s pr√≥ximas este mes`;
          lista.appendChild(item);
        } else if (pasadas.length > 0) {
          // Mostrar algunas pasadas si no hay muchas pr√≥ximas
          const item = document.createElement('li');
          item.style.opacity = '0.5';
          item.style.fontStyle = 'italic';
          item.style.fontSize = '0.8rem';
          item.innerHTML = `üìÖ Ya pasaron: ${pasadas.map(p => `${p.dia} ${meses[p.mes]}`).join(', ')}`;
          lista.appendChild(item);
        }
      }
    }

    // Ejecutar al cargar la p√°gina (elige la funci√≥n que prefieras)
    document.addEventListener('DOMContentLoaded', actualizarEfemerides);
    // document.addEventListener('DOMContentLoaded', actualizarEfemeridesDestacandoProximas);

    // Actualizar cada hora para mantener precisi√≥n
    setInterval(actualizarEfemerides, 3600000); // Cada hora
  </script>
</body>

</html>