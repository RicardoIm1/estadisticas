<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estad√≠sticas y Archivo Cl√≠nico</title>
  <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
  <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="/estadisticas/main_css/login.css" rel="stylesheet">
</head>

<body>
  <div class="glass">
    <div class="header">
      <img class="logo" src="img/logo-hrpv.png" alt="Logo" width="120" />
      <h3>Estad√≠sticas y Archivo Cl√≠nico</h3>
    </div>

    <div id="message"></div>

    <form id="formularioLogin">
      <div class="form-group">
        <label for="username"><i class="fas fa-user"></i> Usuario</label>
        <input type="text" id="usuario" name="usuario" placeholder="ej. r.ramirez" required />
      </div>

      <div class="form-group">
        <label for="password"><i class="fas fa-key"></i> Contrase√±a</label>
        <input type="password" id="clave" name="clave" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
      </div>

      <div class="botones-vertical">
        <button type="submit">
          <i class="fas fa-sign-in-alt"></i> Iniciar sesi√≥n
        </button>
        <button type="reset"><i class="fas fa-broom"></i> Limpiar</button>
      </div>
    </form>

    <footer>
      <p id="footerText">Hecho con ‚ù§Ô∏è por Ricardo ¬∑ 2023</p>
    </footer>
  </div>

  <script>
    // ========== SISTEMA DE ESTADO ==========
    let intensidadUso = 0;
    let respiracionInterval;

    function iniciarRespiracion() {
      const dashboard = document.querySelector(".glass");
      if (!dashboard) return;

      clearInterval(respiracionInterval);

      let fase = 0;
      respiracionInterval = setInterval(() => {
        fase += 0.02;
        const intensidad = Math.min(0.15 + intensidadUso / 80, 0.4);
        const escala = 1 + Math.sin(fase) * intensidad * 0.02;
        dashboard.style.transform = `scale(${escala})`;
      }, 500);
    }

    function setEstado(estado, mensaje = null) {
      const dashboard = document.querySelector(".glass");
      const messageDiv = document.getElementById("message");
      if (!dashboard) return;

      intensidadUso = Math.min(intensidadUso + 1, 10);
      iniciarRespiracion();
      setTimeout(
        () => (intensidadUso = Math.max(intensidadUso - 1, 0)),
        8000
      );

      dashboard.classList.remove("loading", "success", "error");
      dashboard.classList.add(estado);

      if (messageDiv) {
        const iconos = {
          loading:
            '<i class="fas fa-sync fa-spin"></i> Validando credenciales...',
          success: '<i class="fas fa-check-circle"></i> ¬°ACCESO EXITOSO! <br>',
          error: '<i class="fas fa-exclamation-circle"></i> ',
        };
        messageDiv.innerHTML = mensaje
          ? iconos[estado] + mensaje
          : iconos[estado];
        messageDiv.style.color = estado === "error" ? "#f87171" : "white";
        messageDiv.style.opacity = "1";
      }

      if (estado !== "success") {
        setTimeout(() => {
          dashboard.classList.remove("loading", "success", "error");
        }, 5000);
      }
    }
  </script>
  
  <script>
    // ========== L√ìGICA DEL LOGIN CON JSONP ==========
    document.getElementById(
      "footerText"
    ).innerHTML = `Hecho con ‚ù§Ô∏è por Ricardo ¬∑ ${new Date().getFullYear()}`;

    const form = document.getElementById("formularioLogin");
    const scriptUrl =
      "https://script.google.com/macros/s/AKfycbywX2f0VrdTz2UKXY9u_lX4DwMrVJj-_XHQtjFfT9kx6E_3NsBqhTCqwJ923SzpeRzu/exec";

    // ‚úÖ Funci√≥n global para manejar la respuesta del LOGIN
    window.manejarLogin = function (resultado) {
      console.log("üîç Respuesta REAL de Google Sheets:", resultado);

      // Remover el script despu√©s de usarlo
      const oldScript = document.getElementById("jsonp-script");
      if (oldScript) oldScript.remove();

      /* if (resultado.success) {
        const usuario = document.getElementById("usuario").value;
        setEstado(
          "success",
          `¬°Bienvenido ${usuario}! ( Rol: ${resultado.rol})`
          ); 
          }*/

      if (resultado.success) {
        const usuario = document.getElementById("usuario").value;
        setEstado(
          "success",
          `<br><div>¬°Bienvenido(a)</div><br>
          <div><strong>${usuario}</strong></div><br>
          <div><strong>${resultado.rol || '‚Äî'}</strong></div>`
        );

        // ‚úÖ Guardar sesi√≥n en localStorage
        localStorage.setItem("usuario", usuario);
        localStorage.setItem("rol", resultado.rol);
        localStorage.setItem("loginTime", new Date().getTime());

        setTimeout(() => {
          // Redirigir seg√∫n el rol
          if (resultado.rol === "ADMIN") {
            window.location.href = "/estadisticas/control/";
          } else if (resultado.rol === "CAJA") {
            window.location.href = "/estadisticas/caja/caja.html";
          } else if (resultado.rol === "Lector") {
            window.location.href = "/estadisticas/";
          } else if (resultado.rol === "ESTADISTICAS") {
            window.location.href = "/estadisticas/est/";
          } else if (resultado.rol === "ARCHIVO CLINICO") {
            window.location.href = "/estadisticas/archivo/";
          } else if (resultado.rol === "EPIDEMIOLOGIA") {
            window.location.href = "/estadisticas/epidemio/";
          } else if (resultado.rol === "SUBDIRECCION") {
            window.location.href = "/estadisticas/archivo/h_faltantes.html";
          } else {
            window.location.href = "/estadisticas/"; // valor por defecto
          }
        }, 2000);
      } else {
        setEstado("error", resultado.error || "Credenciales incorrectas");
        console.error("‚ùå Error de login:", resultado.error);
      }
    };

    // ‚úÖ Funci√≥n global para verificar el servidor
    window.verificarServidorCallback = function (res) {
      console.log("‚úÖ Servidor activo:", res);
      // Remover el script despu√©s de usarlo
      const script = document.getElementById("server-check-script");
      if (script) script.remove();
    };

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      setEstado("loading");

      const usuario = document.getElementById("usuario").value.trim();
      const clave = document.getElementById("clave").value;

      if (!usuario || !clave) {
        setEstado("error", "Usuario y contrase√±a son requeridos");
        return;
      }

      console.log("üì§ Enviando credenciales:", { usuario, clave });

      // ‚úÖ JSONP - Crear script din√°mico (GET)
      const script = document.createElement("script");
      script.id = "jsonp-script";

      // Par√°metros por URL (GET)
      const params = new URLSearchParams({
        usuario: usuario,
        clave: clave,
        callback: "manejarLogin", // ‚úÖ Nombre de funci√≥n global
        ip: "web", // Para logs
      });

      script.src = `${scriptUrl}?${params.toString()}`;
      console.log("üîó URL llamada:", script.src);

      document.head.appendChild(script);

      // Timeout por si falla
      setTimeout(() => {
        const scriptElement = document.getElementById("jsonp-script");
        if (scriptElement) {
          scriptElement.remove();
          setEstado("error", "Timeout - No response from server");
        }
      }, 10000);
    });

    form.addEventListener("reset", () => {
      const messageDiv = document.getElementById("message");
      messageDiv.innerHTML = "";
      messageDiv.style.opacity = "0";
    });

    // ‚úÖ Verificar sesi√≥n existente
    function verificarSesion() {
      const usuario = localStorage.getItem("usuario");
      const loginTime = localStorage.getItem("loginTime");
      const ahora = new Date().getTime();

      // Si hay sesi√≥n y no ha expirado (24 horas)
      if (usuario && loginTime && ahora - loginTime < 24 * 60 * 60 * 1000) {
        console.log("Sesi√≥n activa para:", usuario);
        // Opcional: redirigir autom√°ticamente
        // window.location.href = 'dashboard.html';
      } else {
        // Limpiar sesi√≥n expirada
        localStorage.removeItem("usuario");
        localStorage.removeItem("rol");
        localStorage.removeItem("loginTime");
      }
    }

    // ‚úÖ Verificar servidor al cargar (CORREGIDO)
    function verificarServidor() {
      try {
        const script = document.createElement("script");
        script.id = "server-check-script";
        // ‚úÖ Usar nombre de funci√≥n global, no funci√≥n an√≥nima
        script.src = `${scriptUrl}?callback=verificarServidorCallback`;
        document.head.appendChild(script);

        // Limpiar despu√©s de 3 segundos si no responde
        setTimeout(() => {
          const oldScript = document.getElementById("server-check-script");
          if (oldScript) oldScript.remove();
        }, 3000);
      } catch (error) {
        console.log("‚ùå No se pudo conectar al servidor:", error);
      }
    }

    window.addEventListener("load", function () {
      iniciarRespiracion();
      verificarSesion();
      verificarServidor();
    });

    // ‚úÖ Funci√≥n para cerrar sesi√≥n (usar en otras p√°ginas)
    window.cerrarSesion = function () {
      localStorage.removeItem("usuario");
      localStorage.removeItem("rol");
      localStorage.removeItem("loginTime");
      window.location.href = "/estadisticas/index.html";
    };
    // En tu login.js - Verificar expiraci√≥n de sesi√≥n
    function verificarSesionExpirada() {
      const loginTime = localStorage.getItem('loginTime');
      const ahora = new Date().getTime();
      const horasTranscurridas = (ahora - loginTime) / (1000 * 60 * 60);

      // Expirar despu√©s de 24 horas
      if (horasTranscurridas > 24) {
        localStorage.clear();
        window.location.href = '/estadisticas/index.html';
      }
    }

    // Ejecutar cada hora
    setInterval(verificarSesionExpirada, 60 * 60 * 1000);
  </script>
</body>

</html>