<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Control de Informes</title>
  <link rel="shortcut icon" href="/estadisticas/img/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/estadisticas/img/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="/estadisticas/main_css/estilos.css" />
  <style>
    .matriz {
      grid-auto-rows: 34px;
    }

    .matriz-grid {
      margin-top: 20px;
      display: grid;
      grid-auto-rows: minmax(42px, auto);
      gap: 0;
      overflow-y: auto;
      /* border: 1px solid #e5e7eb; */
      background-color: transparent !important;
      /* background: white; */
      border-radius: 16px;
      overflow-x: hidden;
      overflow-y: auto;
    }

    .celda {
      /* border-bottom: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb; */
      display: flex;
      align-items: center;
      padding: 6px 10px;
      /* background: white; */
      background: transparent;
      /* color: #2c3e50; */
      color: white;
      width: auto;
    }

    .celda-llena {
      background: rgba(249, 237, 6, 0.874);
    }

    .col-titulo {
      font-weight: bold;
      background: #2c3e50 !important;
      justify-content: center;
      position: sticky;
      top: 0;
      z-index: 30;
      color: 0;
      font-size: 0.8rem;
      padding: 4px;
    }

    .celda-fija {
      font-size: 10px;
      /* background: #f9fafb !important; */
      background: transparent !important;
      font-weight: 600;
      position: sticky;
      left: 0;
      z-index: 20;
      color: #f9fafb;
    }

    .col-titulo:first-child {
      left: 0;
      z-index: 40;
    }

    .card-informe {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 2px;
    }

    .card-informe.activo {
      /* background: #e0f7e9; */
      /* background: #2c3e50; */
      background: transparent !important;
      border-radius: 6px;
      padding: 4px;
    }

    .input-evidencia {
      flex: 1;
      border: 0px solid transparent;
      padding: 4px;
      border-radius: 12px;
      font-size: 0.75rem;
      width: 90%;
      color: #0d49ee;
      background-color: transparent;
    }
  </style>
</head>

<body>
  <!-- En el body -->
  <div id="user-info"
    style="position: fixed; top: 10px; right: 10px; background: #f5f5f5; padding: 10px; border-radius: 5px;">
    <!-- Aqu√≠ se mostrar√° el usuario -->
  </div>
  <div class="glass glass-inner">
    <h5>Informes Mensuales</h5>
    <!--     <div id="header"></div> -->

    <!-- MATRIZ -->
    <div id="matriz" class="matriz-grid"></div>
    <div id="footer"></div>
  </div>

  <script>
    const INFORMES = [
      "SINBA BD EGRESOS", "SINBA BD URGENCIAS", "SINBA BD LESIONES", "SINBA BD NACIMIENTOS",
      "SINBA BD DEFUNCIONES", "SINBA GERENCIAL", "RESUMEN DEFUNCIONES",
      "CONCENTRADO GENERAL DEL CENSO", "CORTA ESTANCIA", "PRINCIPALES CAUSAS DE EGRESO",
      "EXPEDIENTES CLINICOS NUEVOS", "LABORATORIO", "TAMIZ NEONATAL", "CAPACITACIONES DE ENFERMERIA",
      "VACUNAS", "CARTILLAS DE SALUD", "REHABILITACION", "EPIDEMIOLOGIA", "TRABAJO SOCIAL",
      "SERVICIO DE AMBULANCIAS"
    ];

    const LLAVE = "informes_matriz_v2";

    function obtenerDatos() {
      return JSON.parse(localStorage.getItem(LLAVE)) || { meses: {} };
    }

    function guardarDatos(obj) {
      localStorage.setItem(LLAVE, JSON.stringify(obj));
    }

    function generarMesesA√±oActual() {
      const y = new Date().getFullYear();
      const m = [];
      for (let i = 1; i <= 12; i++) {
        m.push(`${y}-${String(i).padStart(2, "0")}`);
      }
      return m;
    }

    function generarMatrizAuto() {
      const meses = generarMesesA√±oActual();
      const matriz = document.getElementById("matriz");
      matriz.innerHTML = "";

      matriz.style.gridTemplateColumns = `auto repeat(${meses.length}, auto)`;

      const datos = obtenerDatos();

      // TITULOS
      matriz.appendChild(crearCeldaTitulo("Informes"));
      meses.forEach(m => matriz.appendChild(crearCeldaTitulo(m)));

      // FILAS
      INFORMES.forEach(informe => {
        matriz.appendChild(crearCeldaFija(informe));

        meses.forEach(mes => {
          if (!datos.meses[mes]) datos.meses[mes] = {};
          if (!datos.meses[mes][informe]) {
            datos.meses[mes][informe] = { ruta: "", completo: false };
          }

          matriz.appendChild(crearCeldaEditable(mes, informe, datos));
        });
      });

      guardarDatos(datos);
    }

    function crearCeldaTitulo(texto) {
      const d = document.createElement("div");
      d.className = "celda col-titulo";
      d.textContent = texto;
      return d;
    }

    function crearCeldaFija(texto) {
      const d = document.createElement("div");
      d.className = "celda celda-fija";
      d.textContent = texto;
      return d;
    }

    function crearCeldaEditable(mes, informe, datos) {
      const d = document.createElement("div");
      d.className = "celda";

      const reg = datos.meses[mes][informe];

      const box = document.createElement("div");
      box.className = "card-informe";
      if (reg.ruta) box.classList.add("activo");

      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.checked = reg.completo;

      const inp = document.createElement("input");
      inp.type = "text";
      inp.value = reg.ruta;
      inp.placeholder = "Evidencia";
      inp.className = "input-evidencia";

      // Color persistente al cargar
      if (reg.ruta) d.classList.add("celda-llena");


      // --- √öNICO LISTENER PARA inp ---
      inp.addEventListener("input", () => {
        reg.ruta = inp.value.trim();
        reg.completo = reg.ruta !== "";
        chk.checked = reg.completo;
        box.classList.toggle("activo", reg.completo);

        d.classList.toggle("celda-llena", reg.completo);

        guardarDatos(datos);
      });


      // --- CLICK EN CELDA COMPLETA ---
      d.addEventListener("click", (e) => {
        if (e.target.tagName === "INPUT") return;

        if (reg.ruta && reg.ruta.trim() !== "") {
          let url = reg.ruta.trim();
          if (!/^https?:\/\//i.test(url)) url = "https://" + url;
          window.open(url, "_blank");
        }
      });

      chk.addEventListener("change", () => {
        reg.completo = chk.checked;
        if (!reg.completo) reg.ruta = "";

        inp.value = reg.ruta;
        box.classList.toggle("activo", reg.completo);
        d.classList.toggle("celda-llena", reg.completo);

        guardarDatos(datos);
      });

      // Ensamble
      box.appendChild(chk);
      box.appendChild(inp);
      d.appendChild(box);
      return d;
    }

    // GENERACI√ìN AUTOM√ÅTICA AL ABRIR LA P√ÅGINA
    window.addEventListener("load", generarMatrizAuto);
  </script>

  <script>
    fetch('/estadisticas/comun/header.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('header').innerHTML = html;

        // Cargar sesi√≥n.js despu√©s de insertar el HTML
        const s = document.createElement('script');
        s.src = '/estadisticas/comun/sesion.js';

        s.onload = () => {
          console.log("üî• sesion.js cargado. Verificando sesi√≥n...");
          verificarAutenticacion();
        };

        document.body.appendChild(s);
      });

    fetch('/estadisticas/comun/footer.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('footer').innerHTML = html;

        const footer = document.getElementById('footerText');
        if (footer) {
          footer.innerHTML = `Hecho con ‚ù§Ô∏è por Ricardo ¬∑ ${new Date().getFullYear()}`;
        } else {
          console.warn("‚ö† footerText no existe dentro de footer.html");
        }
      });

  </script>

</body>

</html>