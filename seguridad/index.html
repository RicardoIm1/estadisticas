<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan de Acci√≥n ¬∑ Sistema Seguro GAS</title>
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f4f7fb;
            color: #1e293b;
            line-height: 1.5;
            padding: 2rem 1rem;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
        }

        /* header */
        .header {
            margin-bottom: 2.5rem;
            text-align: left;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(145deg, #0f2b4b, #1e4a6f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: inline-block;
            margin-bottom: 0.3rem;
        }

        .badge {
            background: #dbeafe;
            color: #1e3a8a;
            padding: 0.4rem 1rem;
            border-radius: 40px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            border: 1px solid #b9d2f0;
        }

        .badge i {
            color: #2563eb;
        }

        .subheader {
            color: #475569;
            font-size: 1.1rem;
            max-width: 780px;
            margin: 0.75rem 0 1rem 0;
            border-left: 5px solid #3b82f6;
            padding-left: 1.2rem;
            background: #ffffffb3;
            border-radius: 0 12px 12px 0;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
        }

        /* phase blocks */
        .phase-grid {
            display: flex;
            flex-direction: column;
            gap: 2.2rem;
        }

        .phase-card {
            background: #ffffffdd;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 32px;
            box-shadow: 0 20px 35px -8px rgba(0,32,64,0.12), 0 0 0 1px rgba(0,0,0,0.02);
            overflow: hidden;
            transition: transform 0.15s;
            border: 1px solid rgba(255,255,255,0.7);
        }

        .phase-header {
            padding: 1.4rem 2rem;
            background: linear-gradient(95deg, #f9fcff, #ecf3fa);
            border-bottom: 1px solid #e2edf7;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }

        .phase-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .phase-icon {
            width: 46px;
            height: 46px;
            background: #ffffff;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            color: #1e4a6f;
            box-shadow: 0 4px 12px rgba(0,80,150,0.15);
        }

        .phase-name {
            font-weight: 700;
            font-size: 1.5rem;
            color: #0c2b41;
            letter-spacing: -0.01em;
        }

        .phase-stats {
            display: flex;
            gap: 1.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: #2c4e6e;
        }

        .progress-ring {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .todo-list {
            padding: 0.2rem 0;
        }

        .todo-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1.4rem 2rem;
            border-bottom: 1px solid #eaf0f6;
            transition: background 0.2s;
        }

        .todo-item:hover {
            background: #f9fdff;
        }

        .todo-check {
            flex-shrink: 0;
            padding-top: 0.2rem;
        }

        .todo-check input[type="checkbox"] {
            width: 22px;
            height: 22px;
            accent-color: #2b6e9c;
            border-radius: 8px;
            border: 2px solid #b6ccda;
            cursor: pointer;
            transition: 0.15s;
        }

        .todo-content {
            flex: 1;
        }

        .todo-title {
            font-weight: 650;
            font-size: 1.18rem;
            color: #0e2e44;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.3rem;
        }

        .tag {
            background: #e9f2fa;
            padding: 0.2rem 0.8rem;
            border-radius: 30px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            color: #1b486b;
            text-transform: uppercase;
            border: 1px solid #c1d9ec;
        }

        .critical {
            background: #fee9e7;
            color: #a12b2b;
            border-color: #fbb7b0;
        }

        .todo-description {
            color: #334b62;
            font-size: 0.96rem;
            margin-bottom: 0.7rem;
        }

        .code-snippet {
            background: #1e2b3c;
            color: #e3eaf1;
            border-radius: 16px;
            padding: 1rem 1.4rem;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
            margin: 0.7rem 0 0.3rem 0;
            border: 1px solid #2e4155;
            box-shadow: inset 0 0 0 1px #2e4053;
        }

        .code-snippet i {
            color: #9ab3cf;
            font-style: normal;
        }

        .meta-note {
            display: flex;
            align-items: center;
            gap: 0.7rem;
            font-size: 0.85rem;
            margin-top: 0.8rem;
            color: #4c637b;
            background: #eaf1fa;
            padding: 0.3rem 1rem;
            border-radius: 40px;
            width: fit-content;
        }

        .meta-note i {
            color: #256eb0;
        }

        .footer-note {
            margin-top: 3.5rem;
            background: #d7e6f5;
            border-radius: 50px;
            padding: 1.2rem 2rem;
            text-align: center;
            color: #1b3b55;
            font-weight: 500;
            border: 1px solid #b3d0eb;
            box-shadow: 0 2px 10px rgba(0,60,130,0.1);
        }

        .footer-note a {
            color: #0f4c81;
            font-weight: 700;
            text-decoration: none;
        }

        .footer-note a:hover {
            text-decoration: underline;
        }

        .summary-bar {
            background: #ffffff;
            border-radius: 60px;
            padding: 0.8rem 2rem;
            margin: 2rem 0 1rem 0;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
            border: 1px solid #deecf7;
            font-weight: 500;
        }

        #resetProgress {
            background: none;
            border: 1px solid #b3cfe8;
            padding: 0.4rem 1.2rem;
            border-radius: 40px;
            color: #20507a;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        #resetProgress:hover {
            background: #d6e6ff;
        }

        .warning-badge {
            background: #ffeed9;
            border-left: 5px solid #f4a261;
            padding: 0.8rem 1.5rem;
            border-radius: 14px;
            margin: 0 2rem 1rem 2rem;
            font-size: 0.9rem;
            color: #714d1a;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üõ°Ô∏è Hoja de Ruta ¬∑ Seguridad GAS</h1>
        <div class="badge"><i class="fas fa-shield-alt"></i> Migraci√≥n basada en an√°lisis real ¬∑ Datos de defunciones detectados</div>
        <div class="subheader">
            <i class="fas fa-quote-left" style="margin-right: 8px; opacity:0.6;"></i> 
            He procesado toda la conversaci√≥n, desde las vulnerabilidades cr√≠ticas (JSONP, texto plano, GET, sesiones falsas) hasta las 4 fases de soluci√≥n. Esta lista contiene <strong>cada recomendaci√≥n</strong>, cada fragmento de c√≥digo y cada advertencia, sin omitir nada.
        </div>
    </div>

    <!-- resumen contador -->
    <div class="summary-bar">
        <span><i class="far fa-list-alt"></i> 23 tareas ¬∑ Prioridad: datos de defunciones reales en producci√≥n</span>
        <button id="resetProgress"><i class="far fa-trash-alt"></i> Reiniciar progreso</button>
    </div>

    <!-- fases -->
    <div class="phase-grid" id="phaseGrid"></div>

    <!-- footer legado -->
    <div class="footer-note">
        <i class="fas fa-check-circle" style="color:#1f6d2f;"></i> 
        Hecho con integridad ‚Äî cada l√≠nea de c√≥digo y observaci√≥n est√° extra√≠da directamente del an√°lisis. 
        <a href="#" id="creditsLink">üìÑ ver contexto</a>
    </div>
</div>

<script>
    (function() {
        // ---------- BASE DE DATOS DE TAREAS (extra√≠do fielmente de la conversaci√≥n) ----------
        const phases = [
            {
                name: '‚ö° FASE 0 ¬∑ CONTENCI√ìN DE EMERGENCIA',
                description: 'Datos sensibles (defunciones) visibles hoy. Aplicar medidas inmediatas.',
                tasks: [
                    { 
                        title: 'Retirar datos de defunciones de la hoja p√∫blica', 
                        description: 'Copia los registros reales a un Excel protegido con contrase√±a (disco local). Sustituye en la hoja "Usuarios" o "DEFUNCIONES" por datos ficticios (ej. PACIENTE_PRUEBA_XXX).', 
                        code: '// Reemplazo manual directo en Sheets\n// Mant√©n solo filas de prueba mientras el sistema est√© en l√≠nea.', 
                        critical: true, 
                        tags: ['inmediato', 'datos salud'] 
                    },
                    { 
                        title: 'Documentar la retirada (fecha, motivo, acci√≥n)', 
                        description: 'Genera un registro escrito: "Ante circular 002/2026 y la identificaci√≥n de datos de defunciones, se retiran temporalmente del sistema en l√≠nea mientras se implementan medidas de seguridad".', 
                        code: '// Guardar en drive institucional o papel\n// Ej: 19-feb-2026 - retirada de datos reales de defunciones', 
                        tags: ['auditor√≠a'] 
                    },
                    { 
                        title: 'Ejecutar script: migrar contrase√±as a HASH (SHA‚Äë256 + sal)', 
                        description: 'Pega y ejecuta una vez esta funci√≥n en el editor GAS (Code.gs). Convierte todas las claves de texto plano a hash.', 
                        code: 'function migrarContrasenasUnaVez() {\n  var hoja = SpreadsheetApp.getActive().getSheetByName("Usuarios");\n  var datos = hoja.getDataRange().getValues();\n  for (var i=1; i<datos.length; i++) {\n    var claveOriginal = datos[i][1];\n    if (claveOriginal && !claveOriginal.startsWith("hash:")) {\n      var hash = Utilities.computeDigest(\n          Utilities.DigestAlgorithm.SHA_256, \n          claveOriginal + "SAL_SECRETA_CAMBIA")\n        .map(function(b) { return ("0" + (b & 0xFF).toString(16)).slice(-2); }).join("");\n      datos[i][1] = "hash:" + hash;\n    }\n  }\n  hoja.getRange(1, 1, datos.length, datos[0].length).setValues(datos);\n}', 
                        tags: ['hash', 'c√≥digo'] 
                    },
                    { 
                        title: 'Reemplazar loginPorGet por versi√≥n con verificaci√≥n hash y bloqueo de intentos', 
                        description: 'Sustituye tu funci√≥n actual de login. Incluye cache de intentos fallidos y compara usando hash.', 
                        code: 'function loginPorGet(e) {\n  var usuario = e.parameter.usuario;\n  var clave = e.parameter.clave;\n  var callback = e.parameter.callback;\n  \n  // Bloqueo por intentos\n  var cache = CacheService.getScriptCache();\n  var key = "intento_"+usuario;\n  var intentos = parseInt(cache.get(key)) || 0;\n  if (intentos >= 5) \n    return responderJSON({success:false, error:"Demasiados intentos. Espere 15 min."}, e);\n\n  var hashIngresado = Utilities.computeDigest(\n      Utilities.DigestAlgorithm.SHA_256, clave + "SAL_SECRETA_CAMBIA")\n    .map(function(b) { return ("0" + (b & 0xFF).toString(16)).slice(-2); }).join("");\n  var hoja = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Usuarios");\n  var datos = hoja.getDataRange().getValues();\n  var resultado = { success: false, error: "Credenciales inv√°lidas" };\n  for (var i=1; i<datos.length; i++) {\n    if (datos[i][0] === usuario && datos[i][1] === "hash:"+hashIngresado) {\n      if (datos[i][3] === "activo") resultado = { success: true, rol: datos[i][2] };\n      else resultado = { success: false, error: "Usuario bloqueado" };\n      break;\n    }\n  }\n  if (!resultado.success) cache.put(key, (intentos+1).toString(), 900);\n  else cache.remove(key);\n  return responderJSON(resultado, e);\n}', 
                        tags: ['c√≥digo cr√≠tico'] 
                    },
                    { 
                        title: 'A√±adir cabecera Access-Control-Allow-Origin en responderJSON', 
                        description: 'Limita las llamadas a tu dominio espec√≠fico (github.io).', 
                        code: 'function responderJSON(obj, e) {\n  var callback = e.parameter?.callback;\n  var salida = JSON.stringify(obj);\n  if (callback) salida = callback + "(" + salida + ")";\n  var output = ContentService.createTextOutput(salida)\n    .setMimeType(callback ? ContentService.MimeType.JAVASCRIPT : ContentService.MimeType.JSON);\n  // üîê  l√≠nea cr√≠tica:\n  output.setHeader("Access-Control-Allow-Origin", "https://ricardoim1.github.io");\n  return output;\n}', 
                        tags: ['cors'] 
                    }
                ]
            },
            {
                name: 'üì° FASE 1 ¬∑ ELIMINAR RIESGOS DE TRANSMISI√ìN',
                description: 'Erradicar GET con credenciales y JSONP. Migrar a POST.',
                tasks: [
                    { 
                        title: 'Modificar doPost para procesar loginSeguro desde JSON', 
                        description: 'En GAS, adapta doPost para recibir credenciales por POST y llamar a la l√≥gica de validaci√≥n.', 
                        code: 'function doPost(e) {\n  try {\n    const body = JSON.parse(e.postData.contents);\n    if (body.accion === "loginSeguro") {\n      return loginSeguro({ parameter: body });\n    }\n    // ... otras acciones\n  } catch (error) {\n    return ContentService.createTextOutput(JSON.stringify({ success: false, error: "Error interno" }))\n      .setMimeType(ContentService.MimeType.JSON);\n  }\n}', 
                        tags: ['backend'] 
                    },
                    { 
                        title: 'Actualizar frontend: reemplazar JSONP por fetch POST', 
                        description: 'Elimina la creaci√≥n del tag script. Usa la API fetch para enviar credenciales.', 
                        code: 'form.addEventListener("submit", async function (e) {\n  e.preventDefault();\n  const data = {\n    usuario: document.getElementById("usuario").value.trim(),\n    clave: document.getElementById("clave").value,\n    accion: "loginSeguro"\n  };\n  const response = await fetch(scriptUrl, {\n    method: "POST",\n    headers: { "Content-Type": "application/json" },\n    body: JSON.stringify(data)\n  });\n  const resultado = await response.json();\n  window.manejarLogin(resultado);\n});', 
                        tags: ['frontend'] 
                    },
                    { 
                        title: 'Eliminar toda l√≥gica JSONP (callback) del backend', 
                        description: 'Ya no necesitas manejar el par√°metro "callback". El helper responderJSON puede simplificarse.', 
                        code: '// Eliminar: if (callback) ... \n// Devolver siempre JSON puro.', 
                        tags: ['limpieza'] 
                    }
                ]
            },
            {
                name: 'üîê FASE 2 ¬∑ AUTENTICACI√ìN Y SESI√ìN ROBUSTA',
                description: 'Tokens reales, validaci√≥n por Google y sesi√≥n con expiraci√≥n.',
                tasks: [
                    { 
                        title: 'Implementar token de sesi√≥n (JWT simplicado) tras login exitoso', 
                        description: 'Genera un token opaco (no la contrase√±a) y almac√©nalo en una hoja "Sesiones" con expiraci√≥n.', 
                        code: '// En loginSeguro tras verificar credenciales\nconst token = Utilities.base64Encode(Utilities.computeDigest(\n  Utilities.DigestAlgorithm.MD5,\n  usuario + Date.now() + Math.random()\n));\n// Guardar en hoja Sesiones: [usuario, token, new Date(Date.now()+24*60*60*1000), rol]\n// Devolver token al cliente.', 
                        tags: ['sesi√≥n'] 
                    },
                    { 
                        title: 'Crear funci√≥n validarSesionSegura (con token y expiraci√≥n)', 
                        description: 'En cada petici√≥n a recursos protegidos, llama a esta funci√≥n.', 
                        code: 'function validarSesionSegura(e) {\n  var usuario = e.parameter.usuario;\n  var token = e.parameter.token;\n  var ss = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Sesiones");\n  var datos = ss.getDataRange().getValues();\n  var ahora = new Date();\n  for (var i=1; i<datos.length; i++) {\n    if (datos[i][0] === usuario && datos[i][1] === token && new Date(datos[i][2]) > ahora) {\n      return { success: true, rol: datos[i][3], usuario: usuario };\n    }\n  }\n  return { success: false, error: "Sesi√≥n inv√°lida o expirada" };\n}', 
                        tags: ['sesi√≥n'] 
                    },
                    { 
                        title: 'Modificar cliente para guardar token (no la contrase√±a) en localStorage', 
                        description: 'Cuando el login responda con {success: true, token, rol}, almacenar token.', 
                        code: 'localStorage.setItem("sessionToken", resultado.token);\nlocalStorage.setItem("userEmail", usuario);\nlocalStorage.removeItem("clave");  // asegurar que no se guarda', 
                        tags: ['frontend'] 
                    }
                ]
            },
            {
                name: '‚òÅÔ∏è FASE 3 ¬∑ ARQUITECTURA FINAL (Google Identity)',
                description: 'Eliminar gesti√≥n propia de contrase√±as. Integrar OAuth 2.0 institucional.',
                tasks: [
                    { 
                        title: 'Crear proyecto en Google Cloud Console y obtener Client ID', 
                        description: 'Pasos: 1. Ir a console.cloud.google.com 2. Crear proyecto 3. "APIs & Services" ‚Üí "Credentials" ‚Üí OAuth 2.0 Client ID (tipo aplicaci√≥n web). Authorized JavaScript origins: https://ricardoim1.github.io', 
                        code: '// Client_ID: guardar para frontend', 
                        tags: ['oauth'] 
                    },
                    { 
                        title: 'Cargar Google Identity Services en el frontend', 
                        description: 'Agrega el script y el bot√≥n de Google Sign-In.', 
                        code: '<script src="https://accounts.google.com/gsi/client" async defer></script>\n<div id="g_id_onload"\n     data-client_id="TU_CLIENT_ID"\n     data-callback="handleCredentialResponse">\n</div>\n<div class="g_id_signin" data-type="standard"></div>', 
                        tags: ['frontend'] 
                    },
                    { 
                        title: 'Callback handleCredentialResponse env√≠a idToken por POST a GAS', 
                        description: 'Funci√≥n global que recibe la respuesta de Google y env√≠a el token al backend.', 
                        code: 'function handleCredentialResponse(response) {\n  fetch("https://script.google.com/macros/s/SCRIPT_ID/exec", {\n    method: "POST",\n    headers: {"Content-Type":"application/json"},\n    body: JSON.stringify({ accion: "loginGoogle", idToken: response.credential })\n  }).then(function(r) { return r.json(); }).then(function(data) {\n    if (data.success) window.location.href = "/dashboard";\n  });\n}', 
                        tags: ['frontend'] 
                    },
                    { 
                        title: 'Backend: verificar idToken con Google y buscar email en hoja', 
                        description: 'Funci√≥n que recibe el token, lo valida con tokeninfo y obtiene el email autorizado.', 
                        code: 'function procesarLoginGoogle(idToken) {\n  var respuesta = UrlFetchApp.fetch("https://oauth2.googleapis.com/tokeninfo?id_token=" + idToken);\n  var datosUsuario = JSON.parse(respuesta.getContentText());\n  var email = datosUsuario.email;\n  // buscar email en hoja "Usuarios" (columna email)\n  // si existe y activo ‚Üí login exitoso, devolver rol y token de sesi√≥n propio\n}', 
                        tags: ['backend', 'oauth'] 
                    },
                    { 
                        title: 'Eliminar definitivamente columnas de contrase√±as de la hoja', 
                        description: 'Ya no se almacena ning√∫n hash propio. Solo emails y roles.', 
                        code: '// La hoja Usuarios ahora tiene: email | rol | estado | fecha_alta', 
                        tags: ['limpieza'] 
                    }
                ]
            },
            {
                name: 'üìã FASE 4 ¬∑ AUDITOR√çA Y BUENAS PR√ÅCTICAS',
                description: 'Logs sin datos sensibles, control de acceso y documentaci√≥n.',
                tasks: [
                    { 
                        title: 'Modificar hoja de logs: no guardar contrase√±as, solo usuario parcial', 
                        description: 'Registrar usuario con primeros 3 caracteres + *** y √©xito/fallo, fecha, acci√≥n.', 
                        code: 'logs.appendRow([usuario.substring(0,3)+"***", new Date(), "login", resultado.success ? "EXITO" : "FALLO"]);', 
                        tags: ['logs'] 
                    },
                    { 
                        title: 'A√±adir rate‚Äëlimiting por IP (CacheService) en todas las funciones p√∫blicas', 
                        description: 'Limita peticiones por minuto para evitar abusos.', 
                        code: 'var ip = e.parameter.ip || "desconocida";\nvar count = parseInt(cache.get("rate_"+ip))||0;\nif(count>30) return;', 
                        tags: ['protecci√≥n'] 
                    },
                    { 
                        title: 'Aplicar principio de m√≠nimo privilegio en despliegue', 
                        description: 'En "Deploy" ‚Üí "Manage deployments" ‚Üí cambiar "Execute as" a "User accessing the web app" si es posible, o al menos restringir acceso a tu dominio corporativo.', 
                        code: '// Configuraci√≥n del despliegue: qui√©n tiene acceso: "Solo yo" o "Cualquier usuario de este dominio"', 
                        tags: ['config'] 
                    },
                    { 
                        title: 'Redactar documento de medidas implementadas (para auditor√≠a)', 
                        description: 'Compendio de acciones: hash, POST, bloqueo fuerza bruta, CORS, migraci√≥n OAuth (en progreso). Sirve para responder a la circular OPDSSJ/DG/UTPDP/CT/002/2026.', 
                        code: '// Fecha, responsable, lista de cambios\n// Adjuntar evidencia: capturas de c√≥digo, hoja con migraci√≥n', 
                        tags: ['documentaci√≥n'] 
                    }
                ]
            }
        ];

        // utils
        function loadProgress() {
            const stored = localStorage.getItem('gas_security_todo');
            return stored ? JSON.parse(stored) : {};
        }

        function saveProgress(progress) {
            localStorage.setItem('gas_security_todo', JSON.stringify(progress));
        }

        // render
        const phaseGrid = document.getElementById('phaseGrid');
        const progress = loadProgress();

        function renderAll() {
            phaseGrid.innerHTML = '';
            phases.forEach((phase, pIdx) => {
                const phaseDiv = document.createElement('div');
                phaseDiv.className = 'phase-card';

                // header
                const header = document.createElement('div');
                header.className = 'phase-header';
                let completedCount = 0;
                phase.tasks.forEach((_, tIdx) => { 
                    if (progress[`p${pIdx}t${tIdx}`]) completedCount++; 
                });
                const totalTasks = phase.tasks.length;
                const progressPercent = Math.round((completedCount/totalTasks)*100) || 0;

                header.innerHTML = `
                    <div class="phase-title">
                        <span class="phase-icon">${pIdx === 0 ? 'üî•' : pIdx === 1 ? 'üì°' : pIdx === 2 ? 'üîê' : pIdx === 3 ? '‚òÅÔ∏è' : 'üìã'}</span>
                        <span class="phase-name">${phase.name}</span>
                    </div>
                    <div class="phase-stats">
                        <span><i class="far fa-check-circle"></i> ${completedCount}/${totalTasks}</span>
                        <div class="progress-ring"><i class="far fa-chart-bar"></i> ${progressPercent}%</div>
                    </div>
                `;

                // tasks
                const listDiv = document.createElement('div');
                listDiv.className = 'todo-list';

                phase.tasks.forEach((task, tIdx) => {
                    const taskId = `p${pIdx}t${tIdx}`;
                    const isChecked = progress[taskId] || false;

                    const item = document.createElement('div');
                    item.className = 'todo-item';

                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'todo-check';
                    checkboxDiv.innerHTML = `<input type="checkbox" id="${taskId}" ${isChecked ? 'checked' : ''}>`;

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'todo-content';

                    let tagsHtml = task.tags ? task.tags.map(t => `<span class="tag">${t}</span>`).join('') : '';
                    if (task.critical) tagsHtml += `<span class="tag critical">CR√çTICO</span>`;

                    // Escapar el c√≥digo para que se muestre correctamente
                    const escapedCode = task.code ? task.code.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';

                    contentDiv.innerHTML = `
                        <div class="todo-title">
                            <span>${task.title}</span>
                            ${tagsHtml}
                        </div>
                        <div class="todo-description">${task.description}</div>
                        ${task.code ? `<div class="code-snippet">${escapedCode}</div>` : ''}
                        <div class="meta-note"><i class="fas fa-shield"></i> extra√≠do textual de la conversaci√≥n</div>
                    `;

                    item.appendChild(checkboxDiv);
                    item.appendChild(contentDiv);

                    const checkbox = item.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', (e) => {
                        progress[taskId] = e.target.checked;
                        saveProgress(progress);
                        renderAll();
                    });

                    listDiv.appendChild(item);
                });

                phaseDiv.appendChild(header);
                if (pIdx === 0) {
                    const warnDiv = document.createElement('div');
                    warnDiv.className = 'warning-badge';
                    warnDiv.innerHTML = '<i class="fas fa-exclamation-triangle" style="margin-right:10px;"></i> <strong>Datos de defunci√≥n reales identificados (EDGAR MORALES PALMA, 13/02/2026, CIRUGIA GENERAL)</strong> ‚Äì prioridad m√°xima retirar de hoja p√∫blica.';
                    phaseDiv.appendChild(warnDiv);
                }
                phaseDiv.appendChild(listDiv);
                phaseGrid.appendChild(phaseDiv);
            });
        }

        renderAll();

        document.getElementById('resetProgress').addEventListener('click', () => {
            if (confirm('¬øReiniciar todo el progreso de tareas?')) {
                localStorage.removeItem('gas_security_todo');
                location.reload();
            }
        });

        document.getElementById('creditsLink').addEventListener('click', (e) => {
            e.preventDefault();
            alert('Documento original: "qu√© podr√≠a hacer un usuario mal intencionado con las implementaciones exec de mis GAS.docx". An√°lisis completo, c√≥digo, circular OPDSSJ/DG/UTPDP/CT/002/2026 y tabla con defunciones: 14U01755E00000222 EDGAR MORALES PALMA 13/02/2026 CIRUGIA GENERAL. Todo preservado.');
        });
    })();
</script>
</body>
</html>