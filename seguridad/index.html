<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plan de Regularización de Seguridad - Sistema GAS</title>

<style>
:root {
  --primary:#1f2937;
  --accent:#2563eb;
  --bg:#f3f4f6;
  --card:#ffffff;
  --border:#e5e7eb;
}

* { box-sizing:border-box; }

body {
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  background:var(--bg);
  color:#111827;
}

header {
  background:var(--primary);
  color:white;
  padding:1.5rem;
}

header h1 {
  margin:0;
  font-size:1.6rem;
}

nav {
  display:flex;
  flex-wrap:wrap;
  background:white;
  border-bottom:1px solid var(--border);
}

nav button {
  flex:1;
  padding:1rem;
  border:none;
  background:white;
  cursor:pointer;
  font-weight:600;
  transition:0.2s;
}

nav button.active {
  border-bottom:3px solid var(--accent);
  color:var(--accent);
}

nav button:hover {
  background:#f9fafb;
}

section {
  display:none;
  padding:1.5rem;
  max-width:1000px;
  margin:auto;
}

section.active {
  display:block;
}

.card {
  background:var(--card);
  padding:1.2rem;
  margin-bottom:1rem;
  border-radius:8px;
  border:1px solid var(--border);
}

.card h3 {
  margin-top:0;
}

details {
  border:1px solid var(--border);
  border-radius:6px;
  margin-bottom:0.8rem;
  background:white;
}

summary {
  padding:0.8rem;
  font-weight:600;
  cursor:pointer;
  background:#f9fafb;
}

details div {
  padding:0.8rem 1rem;
}

ul {
  padding-left:1.2rem;
}

.code {
  background:#111827;
  color:#e5e7eb;
  padding:0.8rem;
  border-radius:6px;
  font-family: monospace;
  overflow:auto;
  font-size:0.85rem;
}

footer {
  text-align:center;
  padding:1rem;
  font-size:0.85rem;
  color:#6b7280;
}
</style>
</head>
<body>

<header>
  <h1>Plan de Regularización y Fortalecimiento de Seguridad</h1>
  <p>Sistema Interno basado en Google Apps Script + Google Sheets</p>
</header>

<nav>
  <button class="active" onclick="openTab('diagnostico', this)">Diagnóstico</button>
  <button onclick="openTab('riesgos', this)">Riesgos Identificados</button>
  <button onclick="openTab('acciones', this)">Acciones Inmediatas</button>
  <button onclick="openTab('estrategia', this)">Estrategia Mediano Plazo</button>
  <button onclick="openTab('datos', this)">Datos Sensibles</button>
</nav>

<section id="diagnostico" class="active">
  <div class="card">
    <h3>Situación Actual</h3>
    <ul>
      <li>Sistema interno desarrollado con Google Apps Script.</li>
      <li>Base de datos almacenada en Google Sheets.</li>
      <li>Autenticación personalizada mediante usuario y contraseña.</li>
      <li>Uso de JSONP y GET para login.</li>
      <li>Contraseñas originalmente almacenadas en texto plano.</li>
      <li>Control de sesión basado en localStorage.</li>
    </ul>
  </div>

  <details>
    <summary>Arquitectura Actual</summary>
    <div>
      Frontend en GitHub Pages → Llamadas a GAS público → Google Sheets como almacenamiento.
      <br><br>
      Problemas detectados:
      <ul>
        <li>Credenciales enviadas por URL.</li>
        <li>Token de sesión equivalente a contraseña.</li>
        <li>Endpoint público accesible sin restricción real.</li>
      </ul>
    </div>
  </details>
</section>

<section id="riesgos">
  <details open>
    <summary>1. Contraseñas en texto plano</summary>
    <div>
      Riesgo alto si alguien accede a la hoja "Usuarios".
      <div class="code">
if (u === usuario && c === clave) { }
      </div>
    </div>
  </details>

  <details>
    <summary>2. Credenciales enviadas por GET</summary>
    <div>
      Se almacenan en historial, logs y tráfico visible.
    </div>
  </details>

  <details>
    <summary>3. Sistema de sesión débil</summary>
    <div>
      Token = contraseña.
      No existe validación criptográfica real.
    </div>
  </details>

  <details>
    <summary>4. Datos de categoría especial</summary>
    <div>
      Registros de defunciones contienen:
      <ul>
        <li>Nombre completo</li>
        <li>Fecha</li>
        <li>Área médica</li>
      </ul>
      Esto constituye dato personal sensible.
    </div>
  </details>
</section>

<section id="acciones">
  <div class="card">
    <h3>Medidas Obligatorias Inmediatas</h3>
  </div>

  <details>
    <summary>Hash de contraseñas (Ejecutar una vez)</summary>
    <div class="code">
function migrarContrasenasUnaVez() {
  var hoja = SpreadsheetApp.getActive().getSheetByName("Usuarios");
  var datos = hoja.getDataRange().getValues();
  for (var i=1; i<datos.length; i++) {
    var claveOriginal = datos[i][1];
    if (claveOriginal && !claveOriginal.startsWith("hash:")) {
      var hash = Utilities.computeDigest(
        Utilities.DigestAlgorithm.SHA_256,
        claveOriginal + "SAL_SECRETA"
      ).map(function(b){return ('0'+(b&0xFF).toString(16)).slice(-2);}).join('');
      datos[i][1] = "hash:" + hash;
    }
  }
  hoja.getRange(1,1,datos.length,datos[0].length).setValues(datos);
}
    </div>
  </details>

  <details>
    <summary>Bloqueo por intentos fallidos</summary>
    <div class="code">
var cache = CacheService.getScriptCache();
var key = "intento_" + usuario;
var intentos = parseInt(cache.get(key)) || 0;

if (intentos >= 5) {
  return responderJSON({ success:false, error:"Espere 15 min" }, e);
}
    </div>
  </details>

  <details>
    <summary>Restricción de origen</summary>
    <div class="code">
output.setHeader(
  "Access-Control-Allow-Origin",
  "https://ricardoim1.github.io"
);
    </div>
  </details>
</section>

<section id="estrategia">
  <div class="card">
    <h3>Plan de Evolución</h3>
    <ul>
      <li>Eliminar JSONP y migrar a POST con fetch.</li>
      <li>Implementar token de sesión real con expiración.</li>
      <li>Eliminar contraseñas permanentes y migrar a OAuth institucional.</li>
      <li>Controlar accesos mediante Session.getActiveUser().</li>
      <li>Documentar medidas técnicas implementadas.</li>
    </ul>
  </div>

  <details>
    <summary>Cronograma sugerido</summary>
    <div>
      <ul>
        <li>Hoy: Hash + bloqueo + cabecera.</li>
        <li>Esta semana: Migrar a POST.</li>
        <li>Este mes: Sistema de sesión robusto.</li>
        <li>Fase futura: OAuth institucional.</li>
      </ul>
    </div>
  </details>
</section>

<section id="datos">
  <div class="card">
    <h3>Tratamiento de Datos Sensibles</h3>
    <ul>
      <li>Limitar acceso solo a personal necesario.</li>
      <li>Eliminar cuentas inactivas.</li>
      <li>No compartir usuarios.</li>
      <li>Evitar exponer registros de defunción en entorno web si no es indispensable.</li>
      <li>Documentar proceso de fortalecimiento.</li>
    </ul>
  </div>

  <details>
    <summary>Postura ante supervisión</summary>
    <div>
      Se encuentra en proceso activo de fortalecimiento técnico conforme a circular institucional.
      <br><br>
      Medidas ya implementadas:
      <ul>
        <li>Hash de contraseñas.</li>
        <li>Bloqueo antifuerza bruta.</li>
        <li>Restricción de origen.</li>
      </ul>
    </div>
  </details>
</section>

<footer>
  Documento interno de guía técnica y cumplimiento — 2026
</footer>

<script>
function openTab(id, btn) {
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  btn.classList.add("active");
}
</script>

</body>
</html>
