<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Gu√≠a Pr√°ctica Paso a Paso para Corregirlo </title>
</head>

<body>
    <div class="container">
        <h1>üîß Gu√≠a Pr√°ctica Paso a Paso para Corregirlo</h1>
        <h3>Con el script de login</h3>
        <div>
            <pre>cualquiera con la herramienta inspeccionar del navegador puede ver el codigo fuente:
    // ========== L√ìGICA DEL LOGIN CON JSONP ==========
    document.getElementById(
      "footerText"
    ).innerHTML = `Hecho con ‚ù§Ô∏è por Ricardo ¬∑ ${new Date().getFullYear()}`;

    const form = document.getElementById("formularioLogin");
    const scriptUrl =
      "https://script.google.com/macros/s/AKfycbywX2f0VrdTz2UKXY9u_lX4DwMrVJj-_XHQtjFfT9kx6E_3NsBqhTCqwJ923SzpeRzu/exec";

    // ‚úÖ Funci√≥n global para manejar la respuesta del LOGIN
    window.manejarLogin = function (resultado) {
      console.log("üîç Respuesta REAL de Google Sheets:", resultado);

      // Remover el script despu√©s de usarlo
      const oldScript = document.getElementById("jsonp-script");
      if (oldScript) oldScript.remove();

      /* if (resultado.success) {
        const usuario = document.getElementById("usuario").value;
        setEstado(
          "success",
          `¬°Bienvenido ${usuario}! ( Rol: ${resultado.rol})`
          ); 
          }*/

      if (resultado.success) {
        const usuario = document.getElementById("usuario").value;
        setEstado(
          "success",
          `<br><div>¬°Bienvenido(a)</div><br>
          <div><strong>${usuario}</strong></div><br>
          <div><strong>${resultado.rol || '‚Äî'}</strong></div>`
        );

        // ‚úÖ Guardar sesi√≥n en localStorage
        localStorage.setItem("usuario", usuario);
        localStorage.setItem("rol", resultado.rol);
        localStorage.setItem("loginTime", new Date().getTime());

        setTimeout(() => {
          // Redirigir seg√∫n el rol
          if (resultado.rol === "ADMIN") {
            window.location.href = "/estadisticas/control/";
          } else if (resultado.rol === "CAJA") {
            window.location.href = "/estadisticas/caja/caja.html";
          } else if (resultado.rol === "Lector") {
            window.location.href = "/estadisticas/";
          } else if (resultado.rol === "ESTADISTICAS") {
            window.location.href = "/estadisticas/est/";
          } else if (resultado.rol === "ARCHIVO CLINICO") {
            window.location.href = "/estadisticas/archivo/";
          } else if (resultado.rol === "EPIDEMIOLOGIA") {
            window.location.href = "/estadisticas/epidemio/";
          } else if (resultado.rol === "SUBDIRECCION") {
            window.location.href = "/estadisticas/archivo/h_faltantespp.html";
          } else {
            window.location.href = "/estadisticas/"; // valor por defecto
          }
        }, 2000);
      } else {
        setEstado("error", resultado.error || "Credenciales incorrectas");
        console.error("‚ùå Error de login:", resultado.error);
      }
    };

    // ‚úÖ Funci√≥n global para verificar el servidor
    window.verificarServidorCallback = function (res) {
      console.log("‚úÖ Servidor activo:", res);
      // Remover el script despu√©s de usarlo
      const script = document.getElementById("server-check-script");
      if (script) script.remove();
    };

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      setEstado("loading");

      const usuario = document.getElementById("usuario").value.trim();
      const clave = document.getElementById("clave").value;

      if (!usuario || !clave) {
        setEstado("error", "Usuario y contrase√±a son requeridos");
        return;
      }

      console.log("üì§ Enviando credenciales:", { usuario, clave });

      // ‚úÖ JSONP - Crear script din√°mico (GET)
      const script = document.createElement("script");
      script.id = "jsonp-script";

      // Par√°metros por URL (GET)
      const params = new URLSearchParams({
        usuario: usuario,
        clave: clave,
        callback: "manejarLogin", // ‚úÖ Nombre de funci√≥n global
        ip: "web", // Para logs
      });

      script.src = `${scriptUrl}?${params.toString()}`;
      console.log("üîó URL llamada:", script.src);

      document.head.appendChild(script);

      // Timeout por si falla
      setTimeout(() => {
        const scriptElement = document.getElementById("jsonp-script");
        if (scriptElement) {
          scriptElement.remove();
          setEstado("error", "Timeout - No response from server");
        }
      }, 10000);
    });

    form.addEventListener("reset", () => {
      const messageDiv = document.getElementById("message");
      messageDiv.innerHTML = "";
      messageDiv.style.opacity = "0";
    });

    // ‚úÖ Verificar sesi√≥n existente
    function verificarSesion() {
      const usuario = localStorage.getItem("usuario");
      const loginTime = localStorage.getItem("loginTime");
      const ahora = new Date().getTime();

      // Si hay sesi√≥n y no ha expirado (24 horas)
      if (usuario && loginTime && ahora - loginTime < 24 * 60 * 60 * 1000) {
        console.log("Sesi√≥n activa para:", usuario);
        // Opcional: redirigir autom√°ticamente
        // window.location.href = 'dashboard.html';
      } else {
        // Limpiar sesi√≥n expirada
        localStorage.removeItem("usuario");
        localStorage.removeItem("rol");
        localStorage.removeItem("loginTime");
      }
    }

    // ‚úÖ Verificar servidor al cargar (CORREGIDO)
    function verificarServidor() {
      try {
        const script = document.createElement("script");
        script.id = "server-check-script";
        // ‚úÖ Usar nombre de funci√≥n global, no funci√≥n an√≥nima
        script.src = `${scriptUrl}?callback=verificarServidorCallback`;
        document.head.appendChild(script);

        // Limpiar despu√©s de 3 segundos si no responde
        setTimeout(() => {
          const oldScript = document.getElementById("server-check-script");
          if (oldScript) oldScript.remove();
        }, 3000);
      } catch (error) {
        console.log("‚ùå No se pudo conectar al servidor:", error);
      }
    }

    window.addEventListener("load", function () {
      iniciarRespiracion();
      verificarSesion();
      verificarServidor();
    });

    // ‚úÖ Funci√≥n para cerrar sesi√≥n (usar en otras p√°ginas)
    window.cerrarSesion = function () {
      localStorage.removeItem("usuario");
      localStorage.removeItem("rol");
      localStorage.removeItem("loginTime");
      window.location.href = "/estadisticas/index.html";
    };
    // En tu login.js - Verificar expiraci√≥n de sesi√≥n
    function verificarSesionExpirada() {
      const loginTime = localStorage.getItem('loginTime');
      const ahora = new Date().getTime();
      const horasTranscurridas = (ahora - loginTime) / (1000 * 60 * 60);

      // Expirar despu√©s de 24 horas
      if (horasTranscurridas > 24) {
        localStorage.clear();
        window.location.href = '/estadisticas/index.html';
      }
    }

    // Ejecutar cada hora
    setInterval(verificarSesionExpirada, 60 * 60 * 1000);</pre>
        </div>
        <div class="paso">
            <h2>1. Reescribe el Cliente (HTML/JS) para usar google.script.run:</h2>
            <p>Esto es lo m√°s seguro para comunicar tu web con GAS, ya que maneja la autenticaci√≥n de Google de forma
                transparente.</p>
            <pre>
                // 1. En tu HTML, carga la API de Google
                <script src="https://accounts.google.com/gsi/client"></script>
                <script src="https://apis.google.com/js/api.js"></script>

                // 2. En tu login.js, implementa Google Sign-In
                function handleCredentialResponse(response) {
                    // response.credential es el JWT de Google
                    google.script.run
                    .withSuccessHandler(function(rolDelServidor) {
                        // Login exitoso. El servidor nos devuelve el rol.
                        redirigirSegunRol(rolDelServidor);
                    })
                    .withFailureHandler(function(error) {
                        // Login fallido (email no autorizado)
                        mostrarError("Acceso denegado. No est√°s en la lista.");
                    })
                    .procesarLoginGoogle(response.credential); // Esta funci√≥n est√° en tu GAS.
                }

                // 3. Bot√≥n de Google en tu HTML
                <div id="g_id_onload"
                    data-client_id="TU_CLIENT_ID_DE_GOOGLE_CLOUD"
                    data-callback="handleCredentialResponse">
                </div>
                <div class="g_id_signin" data-type="standard"></div>
            </pre>
        </div>
        <div class="paso">
            <h2>2. Reestructura el Servidor (GAS - C√≥digo .gs) - La Parte M√°s Importante:</h2>
            <p>Tu servidor debe hacer dos cosas:
            <ul>
                <li>Verificar la identidad real usando el token de Google.</li>
                <li>Comprobar los permisos en una hoja de c√°lculo "Maestra de Usuarios" (usuario -> rol).</li>
            </ul>
            </p>
            <pre>
                // En tu Code.gs
                function procesarLoginGoogle(idToken) {
                try {
                    // 1. VERIFICAR que el token es v√°lido y obtener el email.
                    var respuesta = UrlFetchApp.fetch("https://oauth2.googleapis.com/tokeninfo?id_token=" + idToken);
                    var datosUsuario = JSON.parse(respuesta.getContentText());
                    var email = datosUsuario.email;

                    // 2. AUTORIZAR: Buscar el email en tu hoja de usuarios.
                    var hojaUsuarios = SpreadsheetApp.openById("ID_HOJA").getSheetByName("Usuarios");
                    var datos = hojaUsuarios.getDataRange().getValues();

                    for (var i = 0; i < datos.length; i++) {
                    if (datos[i][0] === email) { // Columna 1: Email
                        var rol = datos[i][1]; // Columna 2: Rol
                        // 3. Devolver SOLO el rol al cliente. La identidad queda establecida.
                        return { success: true, rol: rol };
                    }
                    }
                    // Email no encontrado en la lista
                    throw new Error("Usuario no autorizado.");
                } catch (error) {
                    Logger.log("Error login: %s", error.toString());
                    return { success: false, error: "Error de autenticaci√≥n." };
                }
                }

                // 4. En TODAS las funciones que sirven p√°ginas protegidas, VERIFICAR.
                function servirPaginaAdmin() {
                var usuario = Session.getActiveUser().getEmail(); // Esto solo funciona si el usuario est√° logueado con Google.
                // ... buscar rol de 'usuario' y solo devolver HTML si es ADMIN ...
                }
            </pre>
        </div>
        <div class="paso">
            <h2>3. Elimina por Completo la L√≥gica de JSONP y GET con credenciales. Esa t√©cnica ya no debe existir en tu
                aplicaci√≥n.</h2>
            <table>
                <thead>
                    <tr>
                        <th>Caracter√≠stica</th>
                        <th>Enfoque actual</th>
                        <th>Enfoque propuesto</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>autenticaci√≥n</td>
                        <td>Contrase√±a propia, enviada en texto claro</td>
                        <td>Google OAuth 2.0 estandar industrial</td>
                    </tr>
                    <tr>
                        <td>Canal</td>
                        <td>JSONP/GET (visible)</td>
                        <td>HTTPS POST (encriptado)</td>
                    </tr>
                    <tr>
                        <td>Verificaci√≥n</td>
                        <td>L√≥gica propia de GAS</td>
                        <td>Verificada por Google</td>
                    </tr>
                    <tr>
                        <td>Sesi√≥n</td>
                        <td>Falsa, almacenada en el navegador</td>
                        <td>Real, gestionada por Google</td>
                    </tr>
                    <tr>
                        <td>Protecci√≥n</td>
                        <td>Casi nula</td>
                        <td>Alta, contra inyecci√≥n y suplantaci√≥n</td>
                    </tr>
                </tbody>
            </table>

        </div>
    </div>
</body>

</html>