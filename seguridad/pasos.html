<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游댢 Gu칤a Pr치ctica Paso a Paso para Corregirlo </title>
</head>

<body>
    <div class="container">
        <h1>游댢 Gu칤a Pr치ctica Paso a Paso para Corregirlo</h1>
        <div class="paso">
            <h2>1. Reescribe el Cliente (HTML/JS) para usar google.script.run:</h2>
            <p>Esto es lo m치s seguro para comunicar tu web con GAS, ya que maneja la autenticaci칩n de Google de forma
                transparente.</p>
            <pre>
                // 1. En tu HTML, carga la API de Google
                <script src="https://accounts.google.com/gsi/client"></script>
                <script src="https://apis.google.com/js/api.js"></script>

                // 2. En tu login.js, implementa Google Sign-In
                function handleCredentialResponse(response) {
                    // response.credential es el JWT de Google
                    google.script.run
                    .withSuccessHandler(function(rolDelServidor) {
                        // Login exitoso. El servidor nos devuelve el rol.
                        redirigirSegunRol(rolDelServidor);
                    })
                    .withFailureHandler(function(error) {
                        // Login fallido (email no autorizado)
                        mostrarError("Acceso denegado. No est치s en la lista.");
                    })
                    .procesarLoginGoogle(response.credential); // Esta funci칩n est치 en tu GAS.
                }

                // 3. Bot칩n de Google en tu HTML
                <div id="g_id_onload"
                    data-client_id="TU_CLIENT_ID_DE_GOOGLE_CLOUD"
                    data-callback="handleCredentialResponse">
                </div>
                <div class="g_id_signin" data-type="standard"></div>
            </pre>
        </div>
        <div class="paso">
            <h2>2. Reestructura el Servidor (GAS - C칩digo .gs) - La Parte M치s Importante:</h2>
            <p>Tu servidor debe hacer dos cosas:
            <ul>
                <li>Verificar la identidad real usando el token de Google.</li>
                <li>Comprobar los permisos en una hoja de c치lculo "Maestra de Usuarios" (usuario -> rol).</li>
            </ul>
            </p>
            <pre>
                // En tu Code.gs
                function procesarLoginGoogle(idToken) {
                try {
                    // 1. VERIFICAR que el token es v치lido y obtener el email.
                    var respuesta = UrlFetchApp.fetch("https://oauth2.googleapis.com/tokeninfo?id_token=" + idToken);
                    var datosUsuario = JSON.parse(respuesta.getContentText());
                    var email = datosUsuario.email;

                    // 2. AUTORIZAR: Buscar el email en tu hoja de usuarios.
                    var hojaUsuarios = SpreadsheetApp.openById("ID_HOJA").getSheetByName("Usuarios");
                    var datos = hojaUsuarios.getDataRange().getValues();

                    for (var i = 0; i < datos.length; i++) {
                    if (datos[i][0] === email) { // Columna 1: Email
                        var rol = datos[i][1]; // Columna 2: Rol
                        // 3. Devolver SOLO el rol al cliente. La identidad queda establecida.
                        return { success: true, rol: rol };
                    }
                    }
                    // Email no encontrado en la lista
                    throw new Error("Usuario no autorizado.");
                } catch (error) {
                    Logger.log("Error login: %s", error.toString());
                    return { success: false, error: "Error de autenticaci칩n." };
                }
                }

                // 4. En TODAS las funciones que sirven p치ginas protegidas, VERIFICAR.
                function servirPaginaAdmin() {
                var usuario = Session.getActiveUser().getEmail(); // Esto solo funciona si el usuario est치 logueado con Google.
                // ... buscar rol de 'usuario' y solo devolver HTML si es ADMIN ...
                }
            </pre>
        </div>
        <div class="paso">
            <h2>3. Elimina por Completo la L칩gica de JSONP y GET con credenciales. Esa t칠cnica ya no debe existir en tu aplicaci칩n.</h2>
            <table>
                <thead>Comparacion de los dos enfoques</thead>
                <tbody>
                    <tr>
                        <td>caracteristica</td>
                        <td>Enfoque actual</td>
                        <td>Enfoque propuesto</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>

</html>